---
---
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>cicada-nymph.fasm</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
    <!--
      body {
        color: #f8f8f0;
        background-color: #1b1d1e;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #a6e22e;
      }
      .comment {
        /* font-lock-comment-face */
        color: #FF8888;
      }
      .constant {
        /* font-lock-constant-face */
        color: #ae81ff;
      }
      .default {
        /* default */
        color: #f8f8f0;
        background-color: #1b1d1e;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #a6e22e;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #f92672;
        font-weight: bold;
      }
      .preprocessor {
        /* font-lock-preprocessor-face */
        color: #a6e22e;
      }
      .rainbow-delimiters-depth-1 {
        /* rainbow-delimiters-depth-1-face */
        color: #8c8c8c;
      }
      .rainbow-delimiters-depth-2 {
        /* rainbow-delimiters-depth-2-face */
        color: #93a8c6;
      }
      .rainbow-delimiters-depth-3 {
        /* rainbow-delimiters-depth-3-face */
        color: #b0b1a3;
      }
      .string {
        /* font-lock-string-face */
        color: #e6db74;
      }
      .type {
        /* font-lock-type-face */
        color: #66d9ef;
        font-weight: bold;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #fd971f;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
{% include in-org-head.html %}
  </head>
  <body>
<pre>
<span class="comment">;;;; before you compile the code
;;;; do not forget to choose your platform
;;;; in the following code
</span>
<span class="preprocessor">include</span> <span class="string">"platform-configuration.inc"</span>

<span class="comment">;; in fasm, "dup" is a reserved word
</span><span class="keyword">dup</span> <span class="preprocessor">equ</span> duplicate

<span class="comment">;; in fasm, "end" is a reserved word
</span><span class="keyword">finish</span> <span class="preprocessor">equ</span> <span class="keyword">end</span>
<span class="keyword">end</span> <span class="preprocessor">equ</span> exit

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

jo_size = <span class="constant">8</span> <span class="comment">;; (byte)
</span><span class="type">xx</span> <span class="preprocessor">equ</span> <span class="type">dq</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

jo_size = <span class="constant">4</span> <span class="comment">;; (byte)
</span><span class="type">xx</span> <span class="preprocessor">equ</span> <span class="type">dd</span>

<span class="variable-name">rax</span> <span class="preprocessor">equ</span> <span class="variable-name">eax</span>
<span class="variable-name">rbx</span> <span class="preprocessor">equ</span> <span class="variable-name">ebx</span>
<span class="variable-name">rcx</span> <span class="preprocessor">equ</span> <span class="variable-name">ecx</span>
<span class="variable-name">rdx</span> <span class="preprocessor">equ</span> <span class="variable-name">edx</span>
<span class="variable-name">rsp</span> <span class="preprocessor">equ</span> <span class="variable-name">esp</span>
<span class="variable-name">rbp</span> <span class="preprocessor">equ</span> <span class="variable-name">ebp</span>
<span class="variable-name">rsi</span> <span class="preprocessor">equ</span> <span class="variable-name">esi</span>
<span class="variable-name">rdi</span> <span class="preprocessor">equ</span> <span class="variable-name">edi</span>

<span class="builtin">syscall</span> <span class="preprocessor">equ</span> <span class="builtin">int</span> <span class="constant">80h</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">define</span> linux64_sys_6_r8  <span class="variable-name">r8</span>
<span class="preprocessor">define</span> linux64_sys_5_r9  <span class="variable-name">r9</span>
<span class="preprocessor">define</span> linux64_sys_4_r10 <span class="variable-name">r10</span>
<span class="preprocessor">define</span> linux64_sys_3_rdx <span class="variable-name">rdx</span>
<span class="preprocessor">define</span> linux64_sys_2_rsi <span class="variable-name">rsi</span>
<span class="preprocessor">define</span> linux64_sys_1_rdi <span class="variable-name">rdi</span>
<span class="preprocessor">define</span> linux64_sys_n_rax <span class="variable-name">rax</span>

<span class="preprocessor">define</span> linux64_syscall_read   <span class="constant">0</span>
<span class="preprocessor">define</span> linux64_syscall_write  <span class="constant">1</span>
<span class="preprocessor">define</span> linux64_syscall_open   <span class="constant">2</span>
<span class="preprocessor">define</span> linux64_syscall_close  <span class="constant">3</span>
<span class="preprocessor">define</span> linux64_syscall_exit   <span class="constant">60</span>
<span class="comment">;; about open &amp; read &amp; write
</span>
<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="keyword">format</span> ELF64 <span class="keyword">executable</span> <span class="constant">3</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="keyword">entry</span> begin_to_interpret_threaded_code
<span class="keyword">segment</span> <span class="keyword">readable</span> <span class="keyword">executable</span> <span class="keyword">writeable</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">define</span> linux32_sys_6_ebp <span class="variable-name">ebp</span>
<span class="preprocessor">define</span> linux32_sys_5_edi <span class="variable-name">edi</span>
<span class="preprocessor">define</span> linux32_sys_4_esi <span class="variable-name">esi</span>
<span class="preprocessor">define</span> linux32_sys_3_edx <span class="variable-name">edx</span>
<span class="preprocessor">define</span> linux32_sys_2_ecx <span class="variable-name">ecx</span>
<span class="preprocessor">define</span> linux32_sys_1_ebx <span class="variable-name">ebx</span>
<span class="preprocessor">define</span> linux32_sys_n_eax <span class="variable-name">eax</span>

<span class="preprocessor">define</span> linux32_syscall_exit    <span class="constant">1</span>
<span class="preprocessor">define</span> linux32_syscall_read    <span class="constant">3</span>
<span class="preprocessor">define</span> linux32_syscall_write   <span class="constant">4</span>
<span class="preprocessor">define</span> linux32_syscall_open    <span class="constant">5</span>
<span class="preprocessor">define</span> linux32_syscall_close   <span class="constant">6</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="keyword">format</span> ELF <span class="keyword">executable</span> <span class="constant">3</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="keyword">entry</span> begin_to_interpret_threaded_code
<span class="keyword">segment</span> <span class="keyword">readable</span> <span class="keyword">executable</span> <span class="keyword">writeable</span>

<span class="rainbow-delimiters-depth-1">}</span>

current_free_address$un_initialized_memory = address$un_initialized_memory

<span class="keyword">labeling</span>  <span class="preprocessor">equ</span> = current_free_address$un_initialized_memory
<span class="type">preserve</span>  <span class="preprocessor">equ</span> current_free_address$un_initialized_memory = current_free_address$un_initialized_memory +

size$argument_stack = <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size

   <span class="type">preserve</span> <span class="constant">64</span> * jo_size
address$argument_stack <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$argument_stack

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="comment">;; if you want to extend cicada in assembly
;; the following registers must NOT be used
</span>
<span class="preprocessor">define</span> pointer$argument_stack <span class="variable-name">r15</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">macro</span> <span class="function-name">push_argument_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>, register
   <span class="builtin">add</span> pointer$argument_stack, jo_size
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="preprocessor">macro</span> <span class="function-name">pop_argument_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="builtin">sub</span> pointer$argument_stack, jo_size
   <span class="builtin">mov</span> register, <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">pointer$argument_stack</span>:
   <span class="type">xx</span> address$argument_stack

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">macro</span> <span class="function-name">push_argument_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
   <span class="builtin">push</span> <span class="variable-name">ebx</span>
   <span class="builtin">mov</span> <span class="variable-name">ebx</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">ebx</span><span class="rainbow-delimiters-depth-3">]</span>, register
   <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">ebx</span>
   <span class="builtin">pop</span> <span class="variable-name">ebx</span>
   <span class="keyword">else</span>
   <span class="builtin">push</span> <span class="variable-name">eax</span>
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">eax</span><span class="rainbow-delimiters-depth-3">]</span>, register
   <span class="builtin">add</span> <span class="variable-name">eax</span>, jo_size
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">eax</span>
   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   <span class="keyword">finish</span> <span class="keyword">if</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="preprocessor">macro</span> <span class="function-name">pop_argument_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
   <span class="builtin">push</span> <span class="variable-name">ebx</span>
   <span class="builtin">mov</span> <span class="variable-name">ebx</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">sub</span> <span class="variable-name">ebx</span>, jo_size
   <span class="builtin">mov</span> register, <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">ebx</span><span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">ebx</span>
   <span class="builtin">pop</span> <span class="variable-name">ebx</span>
   <span class="keyword">else</span>
   <span class="builtin">push</span> <span class="variable-name">eax</span>
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">sub</span> <span class="variable-name">eax</span>, jo_size
   <span class="builtin">mov</span> register, <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">eax</span><span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">eax</span>
   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   <span class="keyword">finish</span> <span class="keyword">if</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="rainbow-delimiters-depth-1">}</span>

size$return_stack = <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size

   <span class="type">preserve</span> <span class="constant">64</span> * jo_size
address$return_stack <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$return_stack

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="comment">;; if you want to extend cicada in assembly
;; the following registers must NOT be used
</span>
<span class="preprocessor">define</span> pointer$return_stack <span class="variable-name">r14</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">macro</span> <span class="function-name">push_return_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>, register
   <span class="builtin">add</span> pointer$return_stack, jo_size
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="preprocessor">macro</span> <span class="function-name">pop_return_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="builtin">sub</span> pointer$return_stack, jo_size
   <span class="builtin">mov</span> register, <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">pointer$return_stack</span>:
   <span class="type">xx</span> address$return_stack

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">macro</span> <span class="function-name">push_return_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
   <span class="builtin">push</span> <span class="variable-name">ebx</span>
   <span class="builtin">mov</span> <span class="variable-name">ebx</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">ebx</span><span class="rainbow-delimiters-depth-3">]</span>, register
   <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">ebx</span>
   <span class="builtin">pop</span> <span class="variable-name">ebx</span>
   <span class="keyword">else</span>
   <span class="builtin">push</span> <span class="variable-name">eax</span>
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">eax</span><span class="rainbow-delimiters-depth-3">]</span>, register
   <span class="builtin">add</span> <span class="variable-name">eax</span>, jo_size
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">eax</span>
   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   <span class="keyword">finish</span> <span class="keyword">if</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="preprocessor">macro</span> <span class="function-name">pop_return_stack</span> register \<span class="rainbow-delimiters-depth-2">{</span>
   <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
   <span class="builtin">mov</span> <span class="variable-name">ebx</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">sub</span> <span class="variable-name">ebx</span>, jo_size
   <span class="builtin">mov</span> register, <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">ebx</span><span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">ebx</span>
   <span class="keyword">else</span>
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">sub</span> <span class="variable-name">eax</span>, jo_size
   <span class="builtin">mov</span> register, <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">eax</span><span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-3">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-3">]</span>, <span class="variable-name">eax</span>
   <span class="keyword">finish</span> <span class="keyword">if</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">macro</span> <span class="function-name">next</span> \<span class="rainbow-delimiters-depth-2">{</span>
   pop_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">jmp</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-3">]</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="rainbow-delimiters-depth-1">}</span>


<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="preprocessor">macro</span> <span class="function-name">next</span> \<span class="rainbow-delimiters-depth-2">{</span>
   pop_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-3">]</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">jmp</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-3">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-3">]</span>
\<span class="rainbow-delimiters-depth-2">}</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="comment">;; initial link to point to 0 (as null)
</span>link = <span class="constant">0</span>

<span class="function-name">address$name_string_area</span>:
   <span class="keyword">times</span> <span class="constant">64</span> * <span class="constant">1024</span> <span class="type">db</span> <span class="constant">0</span>

<span class="function-name">address$core_file</span>:
   <span class="keyword">file</span> <span class="string">"core/core.cn"</span>
<span class="function-name">end$core_file</span>:

<span class="function-name">end$name_string_area</span>:

current_free_address$name_string_area = address$name_string_area

<span class="preprocessor">macro</span> <span class="function-name">make_name_string</span> string <span class="rainbow-delimiters-depth-1">{</span>

<span class="keyword">virtual</span> <span class="keyword">at</span> <span class="constant">0</span>
<span class="function-name">.start$string</span>:
   <span class="type">db</span> string
<span class="function-name">.end$string</span>:
   <span class="type">dw</span> <span class="rainbow-delimiters-depth-2">(</span>.end$string - .start$string<span class="rainbow-delimiters-depth-2">)</span>
   <span class="keyword">load</span> .length <span class="type">word</span> <span class="keyword">from</span> <span class="rainbow-delimiters-depth-2">(</span>.end$string<span class="rainbow-delimiters-depth-2">)</span>
<span class="keyword">finish</span> <span class="keyword">virtual</span>
<span class="keyword">store</span> <span class="type">word</span> .length <span class="keyword">at</span> <span class="rainbow-delimiters-depth-2">(</span>current_free_address$name_string_area<span class="rainbow-delimiters-depth-2">)</span>

current_free_address$name_string_area = current_free_address$name_string_area + <span class="constant">2</span>

<span class="keyword">repeat</span> .length
   <span class="keyword">virtual</span> <span class="keyword">at</span> <span class="constant">0</span>
      <span class="type">db</span> string
      <span class="keyword">load</span> .char <span class="type">byte</span> <span class="keyword">from</span> <span class="rainbow-delimiters-depth-2">(</span>% - <span class="constant">1</span><span class="rainbow-delimiters-depth-2">)</span>
   <span class="keyword">finish</span> <span class="keyword">virtual</span>
   <span class="keyword">store</span> <span class="type">byte</span> .char <span class="keyword">at</span> <span class="rainbow-delimiters-depth-2">(</span>current_free_address$name_string_area<span class="rainbow-delimiters-depth-2">)</span>
   current_free_address$name_string_area = current_free_address$name_string_area + <span class="constant">1</span>
<span class="keyword">finish</span> <span class="keyword">repeat</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">macro</span> <span class="function-name">define_function</span> string, <span class="builtin">jo</span> <span class="rainbow-delimiters-depth-1">{</span>

define_function__#<span class="builtin">jo</span>:

name__#<span class="builtin">jo</span>:
   <span class="type">xx</span> current_free_address$name_string_area

   make_name_string string

link__#<span class="builtin">jo</span>:
   <span class="type">xx</span> link
   link = link__#<span class="builtin">jo</span>

<span class="builtin">jo</span>:
   <span class="type">xx</span> explain$function

   <span class="comment">;; here follows a jojo as function-body
</span>
<span class="rainbow-delimiters-depth-1">}</span>

<span class="function-name">explain$function</span>:
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-1">]</span>
   push_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-1">]</span>
   push_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
   push_return_stack <span class="variable-name">rax</span>
   next

<span class="preprocessor">macro</span> <span class="function-name">define_primitive_function</span> string, <span class="builtin">jo</span> <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function__#<span class="builtin">jo</span>:

name__#<span class="builtin">jo</span>:
   <span class="type">xx</span> current_free_address$name_string_area

   make_name_string string

link__#<span class="builtin">jo</span>:
   <span class="type">xx</span> link
   link = link__#<span class="builtin">jo</span>

<span class="builtin">jo</span>:
   <span class="type">xx</span> assembly_code__#<span class="builtin">jo</span>

assembly_code__#<span class="builtin">jo</span>:

   <span class="comment">;; here follows assembly code
</span>   <span class="comment">;; as primitive function body
</span>
<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">macro</span> <span class="function-name">define_variable</span> string, <span class="builtin">jo</span> <span class="rainbow-delimiters-depth-1">{</span>

define_variable__#<span class="builtin">jo</span>:

length__#<span class="builtin">jo</span>:
   <span class="type">xx</span> <span class="constant">1</span>

name__#<span class="builtin">jo</span>:
   <span class="type">xx</span> current_free_address$name_string_area

   make_name_string string

link__#<span class="builtin">jo</span>:
   <span class="type">xx</span> link
   link = link__#<span class="builtin">jo</span>

<span class="builtin">jo</span>:
   <span class="type">xx</span> explain$variable

   <span class="comment">;; here follows a value of jo_size
</span>   <span class="comment">;; only one value is allowed
</span>
<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">explain$variable</span>:
   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span>jo_size * <span class="constant">3</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">rdx</span>, <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">explain$variable</span>:
   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span>jo_size * <span class="constant">3</span><span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">rdx</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">macro</span> <span class="function-name">define_exception</span> string, <span class="builtin">jo</span> <span class="rainbow-delimiters-depth-1">{</span>

define_exception__#<span class="builtin">jo</span>:

   <span class="type">xx</span> <span class="constant">0</span>

name__#<span class="builtin">jo</span>:
   <span class="type">xx</span> current_free_address$name_string_area

   make_name_string string

link__#<span class="builtin">jo</span>:
   <span class="type">xx</span> link
   link = link__#<span class="builtin">jo</span>

<span class="builtin">jo</span>:
   <span class="type">xx</span> explain$exception

   <span class="comment">;; here follows a jojo as function-body
</span>
<span class="rainbow-delimiters-depth-1">}</span>

define_variable <span class="string">"*lost-exception-REPL*"</span>, V__lost_exception_REPL
   <span class="type">xx</span> basic_REPL

<span class="function-name">string$lost_exception_REPL</span>:
   <span class="type">db</span> <span class="string">"* an exception has lost itself"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  the function-jo stored in *lost-exception-REPL*"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  is reseted to"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  as a top-level-REPL"</span>, <span class="constant">10</span>
<span class="function-name">.end</span>:
length$lost_exception_REPL = <span class="rainbow-delimiters-depth-1">(</span>.end - string$lost_exception_REPL<span class="rainbow-delimiters-depth-1">)</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"instruction,exception-reset-stack"</span>, exception_reset_stack
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   pop_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
     <span class="builtin">sub</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">(</span>jo_size * <span class="constant">3</span><span class="rainbow-delimiters-depth-2">)</span>
     <span class="builtin">mov</span> pointer$argument_stack, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"instruction,exception-reset-stack"</span>, exception_reset_stack
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   pop_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
     <span class="builtin">sub</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">(</span>jo_size * <span class="constant">3</span><span class="rainbow-delimiters-depth-2">)</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>
     <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">explain$exception</span>:
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="variable-name">rax</span>

<span class="function-name">.next_jojo</span>:
   pop_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, exception_head
   <span class="builtin">je</span> .next_jo
   <span class="builtin">cmp</span> pointer$return_stack, address$return_stack
   <span class="builtin">je</span> .not_found
   <span class="builtin">jmp</span> .next_jojo


<span class="function-name">.next_jo</span>:
   <span class="comment">;; expecting
</span>   <span class="comment">;;   rbx jojo
</span>   <span class="comment">;;   rsi jo (to cmp)
</span>   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="variable-name">rsi</span>
   <span class="builtin">je</span> .found
   <span class="builtin">test</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">jz</span> .next_jojo
   <span class="builtin">jmp</span> .next_jo


<span class="function-name">.found</span>:
   <span class="comment">;; expecting
</span>   <span class="comment">;;   pointer$return_stack
</span>   <span class="comment">;;   rsi jo
</span>   pop_return_stack <span class="variable-name">rax</span>
   <span class="comment">;; mov pointer$argument_stack, rax
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="variable-name">rsi</span>
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">(</span>jo_size * <span class="constant">3</span><span class="rainbow-delimiters-depth-2">)</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>

   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-2">]</span>
   push_return_stack <span class="variable-name">rbx</span>

   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-2">]</span>
   push_return_stack <span class="variable-name">rbx</span>

   <span class="builtin">add</span> <span class="variable-name">rsi</span>, jo_size
   push_return_stack <span class="variable-name">rsi</span>
   next

<span class="function-name">.not_found</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, string$lost_exception_REPL
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, length$lost_exception_REPL
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">call</span> __write_string

   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>V__lost_exception_REPL + jo_size<span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">call</span> <span class="rainbow-delimiters-depth-2">(</span>reset_top_level_REPL + jo_size<span class="rainbow-delimiters-depth-2">)</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">explain$exception</span>:
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="variable-name">rax</span>

<span class="function-name">.next_jojo</span>:
   pop_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, exception_head
   <span class="builtin">je</span> .next_jo
   <span class="builtin">mov</span> <span class="variable-name">rdx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">rdx</span>, address$return_stack
   <span class="builtin">je</span> .not_found
   <span class="builtin">jmp</span> .next_jojo


<span class="function-name">.next_jo</span>:
   <span class="comment">;; expecting
</span>   <span class="comment">;;   rbx jojo
</span>   <span class="comment">;;   rsi jo (to cmp)
</span>   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="variable-name">rsi</span>
   <span class="builtin">je</span> .found
   <span class="builtin">test</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">jz</span> .next_jojo
   <span class="builtin">jmp</span> .next_jo


<span class="function-name">.found</span>:
   <span class="comment">;; expecting
</span>   <span class="comment">;;   pointer$return_stack
</span>   <span class="comment">;;   rsi jo
</span>   pop_return_stack <span class="variable-name">rax</span>
   <span class="comment">;; mov [pointer$argument_stack], rax
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="variable-name">rsi</span>
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">(</span>jo_size * <span class="constant">3</span><span class="rainbow-delimiters-depth-2">)</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>

   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-2">]</span>
   push_return_stack <span class="variable-name">rbx</span>

   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-2">]</span>
   push_return_stack <span class="variable-name">rbx</span>

   <span class="builtin">add</span> <span class="variable-name">rsi</span>, jo_size
   push_return_stack <span class="variable-name">rsi</span>
   next

<span class="function-name">.not_found</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, string$lost_exception_REPL
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, length$lost_exception_REPL
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">call</span> __write_string

   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>V__lost_exception_REPL + jo_size<span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">call</span> <span class="rainbow-delimiters-depth-2">(</span>reset_top_level_REPL + jo_size<span class="rainbow-delimiters-depth-2">)</span>

   <span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"execute-jo"</span>, execute_jo
   <span class="comment">;; &lt;&lt; jo -- unknown &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">jmp</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>

<span class="rainbow-delimiters-depth-1">}</span>


<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"execute-jo"</span>, execute_jo
   <span class="comment">;; &lt;&lt; jo -- unknown &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">eax</span>
   <span class="builtin">jmp</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">eax</span><span class="rainbow-delimiters-depth-2">]</span>

<span class="rainbow-delimiters-depth-1">}</span>

define_variable <span class="string">"*jo-size*"</span>, V__jo_size
   <span class="type">xx</span> jo_size

define_function <span class="string">"jo-&gt;name"</span>, jo_to_name
   <span class="comment">;; &lt;&lt; jo -- string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, jo_size, subtraction
   <span class="type">xx</span> <span class="keyword">literal</span>, jo_size, subtraction
   <span class="type">xx</span> fetch
   <span class="type">xx</span> address_to_name_string
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"jo-&gt;link"</span>, jo_to_link
   <span class="comment">;; &lt;&lt; jo -- link &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, jo_size
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"last-jo,jotionary?"</span>, last_jo__jotionary?
   <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>   <span class="type">xx</span> jo_to_link
   <span class="type">xx</span> fetch
   <span class="type">xx</span> zero?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"jo-&gt;pre-jo"</span>, jo_to_pre_jo
   <span class="comment">;; &lt;&lt; jo -- pre-jo &gt;&gt;
</span>   <span class="type">xx</span> jo_to_link
   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, jo_size
   <span class="type">xx</span> addition
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"jo-&gt;type"</span>, jo_to_type
   <span class="comment">;; &lt;&lt; jo -- type &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>

   <span class="type">xx</span> <span class="keyword">dup</span>, fetch
   <span class="type">xx</span> swap, subtraction, <span class="keyword">literal</span>, jo_size, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, zero
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_variable <span class="string">"*name-string-area*"</span>, V__name_string_area
   <span class="type">xx</span> address$name_string_area

define_variable <span class="string">"*size,name-string-area*"</span>, V__size__name_string_area
   <span class="type">xx</span> <span class="rainbow-delimiters-depth-1">(</span>end$name_string_area - address$name_string_area<span class="rainbow-delimiters-depth-1">)</span>

<span class="comment">;; *current-free-address,name-string-area*
;; is at epilog
</span>
define_function <span class="string">"address-&gt;name-string"</span>, address_to_name_string
   <span class="comment">;; &lt;&lt; address -- string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, addition  <span class="comment">;; address
</span>   <span class="type">xx</span> swap, fetch_two_bytes <span class="comment">;; length
</span>   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"primitive-function-jo?"</span>, primitive_function_jo?
   <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>   <span class="type">xx</span> jo_to_type
   <span class="type">xx</span> zero?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"function-jo?"</span>, function_jo?
   <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>   <span class="type">xx</span> jo_to_type
   <span class="type">xx</span> <span class="keyword">literal</span>, explain$function
   <span class="type">xx</span> equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"exception-jo?"</span>, exception_jo?
   <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>   <span class="type">xx</span> jo_to_type
   <span class="type">xx</span> <span class="keyword">literal</span>, explain$exception
   <span class="type">xx</span> equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"variable-jo?"</span>, variable_jo?
   <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>   <span class="type">xx</span> jo_to_type
   <span class="type">xx</span> <span class="keyword">literal</span>, explain$variable
   <span class="type">xx</span> equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_primitive_function <span class="string">"end"</span>, <span class="keyword">end</span>
   pop_return_stack <span class="variable-name">rbx</span>
   pop_return_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">rax</span>
   pop_return_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">rax</span>
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"&lt;&gt;"</span>, <span class="keyword">taca</span>
   pop_return_stack <span class="variable-name">rbx</span>
   pop_return_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   pop_return_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">jmp</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>
<span class="rainbow-delimiters-depth-1">}</span>


<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"&lt;&gt;"</span>, <span class="keyword">taca</span>
   pop_return_stack <span class="variable-name">rbx</span>
   pop_return_stack <span class="variable-name">rcx</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rcx</span>
   pop_return_stack <span class="variable-name">rcx</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rcx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">jmp</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>

<span class="comment">;;;; old note
;; &gt;&lt;&gt;&lt;&gt;&lt; can not be the following
;; maybe still something wrong with pop_return_stack
;; but I care less about this now
;; define_primitive_function "&lt;&gt;", taca
;;    pop_return_stack ebx
;;    pop_return_stack eax
;;    mov [current_free_address$local_jo], eax
;;    mov eax, [ebx]
;;    jmp dword [eax]
</span>
<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__exit_with_tos:
   <span class="comment">;; &lt;&lt; exit-code -- &gt;&gt;
</span>   pop_argument_stack linux64_sys_1_rdi
   <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_exit
   <span class="builtin">syscall</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__exit_with_tos:
   <span class="comment">;; &lt;&lt; exit-code -- &gt;&gt;
</span>   pop_argument_stack linux32_sys_1_ebx
   <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_exit
   <span class="builtin">syscall</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__exit_with_zero:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">xor</span> linux64_sys_1_rdi, linux64_sys_1_rdi
   <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_exit
   <span class="builtin">syscall</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__exit_with_zero:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">xor</span> linux32_sys_1_ebx, linux32_sys_1_ebx
   <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_exit
   <span class="builtin">syscall</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__exit_with_six:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> linux64_sys_1_rdi, <span class="constant">6</span>
   <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_exit
   <span class="builtin">syscall</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__exit_with_six:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> linux32_sys_1_ebx, <span class="constant">6</span>
   <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_exit
   <span class="builtin">syscall</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__write_string:
   <span class="comment">;; &lt;&lt; address, length -- &gt;&gt;
</span>   pop_argument_stack linux64_sys_3_rdx     <span class="comment">;; max length to be write
</span>   pop_argument_stack linux64_sys_2_rsi     <span class="comment">;; address
</span>   <span class="builtin">mov</span> linux64_sys_1_rdi, <span class="constant">1</span>                 <span class="comment">;; stdout
</span>   <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_write
   <span class="builtin">syscall</span>
   <span class="builtin">ret</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__write_string:
   <span class="comment">;; &lt;&lt; address, length -- &gt;&gt;
</span>   pop_argument_stack linux32_sys_3_edx     <span class="comment">;; max length to be write
</span>   pop_argument_stack linux32_sys_2_ecx     <span class="comment">;; address
</span>   <span class="builtin">mov</span> linux32_sys_1_ebx, <span class="constant">1</span>                 <span class="comment">;; stdout
</span>   <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_write
   <span class="builtin">syscall</span>
   <span class="builtin">ret</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__reset_argument_stack:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> pointer$argument_stack,  address$argument_stack
   <span class="builtin">ret</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__reset_argument_stack:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, address$argument_stack
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">ret</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__reset_return_stack:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> pointer$return_stack,    address$return_stack
   <span class="builtin">ret</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

__reset_return_stack:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, address$return_stack
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">ret</span>

<span class="rainbow-delimiters-depth-1">}</span>

__reset_local_jo:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, address$local_jo
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">ret</span>

__reset_local_byte:
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, address$local_byte
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">ret</span>

<span class="preprocessor">match</span> =linux, platform <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">begin_to_interpret_threaded_code</span>:

   <span class="builtin">cld</span> <span class="comment">;; set DF = 0, then rsi and rdi are incremented
</span>
   <span class="builtin">call</span> __reset_argument_stack
   <span class="builtin">call</span> __reset_return_stack

   pop_return_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, jojo_for__report_return_stack_is_empty_and_exit
   push_return_stack <span class="variable-name">rax</span>

   <span class="builtin">mov</span> <span class="variable-name">rax</span>, address$local_byte
   push_return_stack <span class="variable-name">rax</span>

   <span class="builtin">mov</span> <span class="variable-name">rax</span>, address$local_jo
   push_return_stack <span class="variable-name">rax</span>

   <span class="builtin">mov</span> <span class="variable-name">rax</span>, first_jojo
   push_return_stack <span class="variable-name">rax</span>
   next

<span class="function-name">first_jojo</span>:
   <span class="comment">;; xx little_test
</span>   <span class="type">xx</span> initialization
   <span class="type">xx</span> load_core_file
   <span class="type">xx</span> <span class="keyword">taca</span>, basic_REPL

<span class="rainbow-delimiters-depth-1">}</span>

define_function <span class="string">"initialization"</span>, initialization
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> init__rule_set__make_jojo
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$report_return_stack_is_empty_and_exit</span>:
   <span class="type">db</span> <span class="string">"* the return-stack is empty now"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  good bye ^-^/"</span>, <span class="constant">10</span>
<span class="function-name">.end</span>:
length$report_return_stack_is_empty_and_exit = <span class="rainbow-delimiters-depth-1">(</span>.end - string$report_return_stack_is_empty_and_exit<span class="rainbow-delimiters-depth-1">)</span>

define_primitive_function <span class="string">"report-return-stack-is-empty-and-exit"</span>, report_return_stack_is_empty_and_exit
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, string$report_return_stack_is_empty_and_exit
   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, length$report_return_stack_is_empty_and_exit
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rcx</span>
   <span class="builtin">call</span> __write_string
   <span class="builtin">call</span> __exit_with_zero

<span class="function-name">jojo_for__report_return_stack_is_empty_and_exit</span>:
   <span class="type">xx</span> report_return_stack_is_empty_and_exit

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"reset-top-level-REPL"</span>, reset_top_level_REPL
   <span class="comment">;; &lt;&lt; top_level_REPL [jo] -- &gt;&gt;
</span>   <span class="builtin">call</span> __reset_return_stack
   <span class="builtin">call</span> __reset_local_jo
   <span class="builtin">call</span> __reset_local_byte
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">jmp</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"reset-top-level-REPL"</span>, reset_top_level_REPL
   <span class="comment">;; &lt;&lt; top_level_REPL [jo] -- &gt;&gt;
</span>   <span class="builtin">call</span> __reset_return_stack
   <span class="builtin">call</span> __reset_local_jo
   <span class="builtin">call</span> __reset_local_byte
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">jmp</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span><span class="rainbow-delimiters-depth-2">]</span>

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"bye"</span>, exit_with_TOS
   <span class="builtin">call</span> __exit_with_tos

define_variable <span class="string">""</span>, V__little_test_number
   <span class="type">xx</span> <span class="constant">3</span>

define_function <span class="string">"little_test"</span>, little_test

   <span class="comment">;;;; variable
</span>   <span class="comment">;; xx V__little_test_number
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; exit ocde : 3
</span>
   <span class="comment">;;;; literal
</span>   <span class="comment">;; xx literal, 4
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; exit ocde : 4
</span>
   <span class="comment">;;;; address
</span>   <span class="comment">;; xx address, V__little_test_number, fetch, add2
</span>   <span class="comment">;; xx address, V__little_test_number, save
</span>   <span class="comment">;; xx V__little_test_number
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; exit ocde : 5
</span>
   <span class="comment">;;;; end
</span>   <span class="comment">;; xx literal, 2, negate
</span>   <span class="comment">;; xx literal, 8
</span>   <span class="comment">;; xx addition
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; 6
</span>
   <span class="comment">;;;; taca
</span>   <span class="comment">;; xx literal, 2
</span>   <span class="comment">;; xx literal, 4
</span>   <span class="comment">;; xx power
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; exit ocde : 16
</span>
   <span class="comment">;;;; write_byte
</span>   <span class="comment">;; xx literal, 64, write_byte
</span>   <span class="comment">;; xx literal, 10, write_byte
</span>   <span class="comment">;; xx zero
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; @
</span>
   <span class="comment">;;;; read_byte
</span>   <span class="comment">;; xx read_byte, write_byte
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;;
</span>
   <span class="comment">;;;; branch
</span>   <span class="comment">;; xx read_byte, write_byte
</span>   <span class="comment">;; xx branch, -3
</span>   <span class="comment">;;;; read a string that ended by &lt;return&gt;
</span>   <span class="comment">;;;; write the readed string
</span>   <span class="comment">;;;; or we can say
</span>   <span class="comment">;;;; read line and write line
</span>   <span class="comment">;;;; or we can say
</span>   <span class="comment">;;;; echo line
</span>
   <span class="comment">;;;; false?branch
</span>   <span class="comment">;; xx false, false?branch, 9
</span>   <span class="comment">;; xx   literal, 64, write_byte
</span>   <span class="comment">;; xx   literal, 10, write_byte
</span>   <span class="comment">;; xx   zero
</span>   <span class="comment">;; xx   exit_with_TOS
</span>   <span class="comment">;; xx true, false?branch, 9
</span>   <span class="comment">;; xx   literal, 65, write_byte
</span>   <span class="comment">;; xx   literal, 10, write_byte
</span>   <span class="comment">;; xx   zero
</span>   <span class="comment">;; xx   exit_with_TOS
</span>   <span class="comment">;; xx zero
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; A
</span>
   <span class="comment">;;;; read_word &amp; write_string
</span>   <span class="comment">;; xx read_word, write_string
</span>   <span class="comment">;; xx literal, 10, write_byte
</span>   <span class="comment">;; xx read_word_for_REPL, write_string
</span>   <span class="comment">;; xx literal, 10, write_byte
</span>   <span class="comment">;; xx zero
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; read line
</span>   <span class="comment">;;;; write first two words of the line
</span>
   <span class="comment">;;;; string-&gt;integer
</span>   <span class="comment">;; xx read_word, string_to_integer
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; type 123
</span>   <span class="comment">;;;; exit code 123
</span>
   <span class="comment">;;;; use jo_to_name to test the macro make_name_string
</span>   <span class="comment">;; xx literal, jo_to_name, jo_to_name, write_string
</span>   <span class="comment">;; xx literal, 10, write_byte
</span>   <span class="comment">;; xx literal, addition, jo_to_name, write_string
</span>   <span class="comment">;; xx literal, 10, write_byte
</span>   <span class="comment">;; xx zero
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; print "jo-&gt;name"
</span>   <span class="comment">;;;; print "add"
</span>
   <span class="comment">;;;; xxoverxx
</span>   <span class="comment">;; xx literal, 1
</span>   <span class="comment">;; xx literal, 2
</span>   <span class="comment">;; xx literal, 3
</span>   <span class="comment">;; xx literal, 4
</span>   <span class="comment">;; xx xxoverxx
</span>   <span class="comment">;; xx pretty_write_integer
</span>   <span class="comment">;; xx pretty_write_integer
</span>   <span class="comment">;; xx pretty_write_integer
</span>   <span class="comment">;; xx pretty_write_integer
</span>   <span class="comment">;; xx pretty_write_integer
</span>   <span class="comment">;; xx pretty_write_integer
</span>   <span class="comment">;; xx zero
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; 2 1 4 3 2 1
</span>
   <span class="comment">;;;; find_jo__through_jo_link
</span>   <span class="comment">;; xx read_word, string_to_integer ;; number
</span>   <span class="comment">;; xx read_word, string_to_integer ;; number
</span>   <span class="comment">;; xx read_word, find_jo__through_jo_link ;; add
</span>   <span class="comment">;; xx drop ;; true
</span>   <span class="comment">;; xx execute_jo
</span>   <span class="comment">;; xx write_integer
</span>   <span class="comment">;; xx zero
</span>   <span class="comment">;; xx exit_with_TOS
</span>   <span class="comment">;;;; 1 2 add
</span>   <span class="comment">;;;; print "3"
</span>
   <span class="comment">;;;; basic-REPL (without the ability to define function)
</span>   <span class="comment">;;;; after this test
</span>   <span class="comment">;;;; we will use basic-REPL to do further tests
</span>   <span class="comment">;; xx basic_REPL
</span>   <span class="comment">;;;; 1 2 add .
</span>
define_primitive_function <span class="string">"instruction,literal"</span>, <span class="keyword">literal</span>
   <span class="comment">;; &lt;&lt; -- fixnum &gt;&gt;
</span>   pop_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-1">]</span>
     push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"instruction,address"</span>, <span class="keyword">address</span>
   <span class="comment">;; &lt;&lt; -- address &gt;&gt;
</span>   pop_return_stack <span class="variable-name">rbx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-1">]</span>
     <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
     push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"instruction,branch"</span>, <span class="keyword">branch</span>
   pop_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-1">]</span>
   <span class="builtin">imul</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
   push_return_stack <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"instruction,false?branch"</span>, <span class="keyword">false?branch</span>
   <span class="comment">;; &lt;&lt; true of false -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">test</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">jnz</span> help__false?branch__not_to_branch

   pop_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-1">]</span>
   <span class="builtin">imul</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
   push_return_stack <span class="variable-name">rbx</span>
   next

<span class="function-name">help__false?branch__not_to_branch</span>:
   pop_return_stack <span class="variable-name">rbx</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"instruction,prepare-for"</span>, prepare_for
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   pop_return_stack <span class="variable-name">rbx</span>

   pop_return_stack <span class="variable-name">rcx</span>
   pop_return_stack <span class="variable-name">rdx</span>

   push_return_stack pointer$argument_stack
   push_return_stack <span class="variable-name">rbx</span>

   push_return_stack <span class="variable-name">rdx</span>
   push_return_stack <span class="variable-name">rcx</span>

<span class="function-name">.next</span>:
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="keyword">end</span>
   <span class="builtin">je</span> .then
   <span class="builtin">jmp</span> .next
<span class="function-name">.then</span>:
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   push_return_stack <span class="variable-name">rbx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"instruction,prepare-for"</span>, prepare_for
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   pop_return_stack <span class="variable-name">ebx</span>

   pop_return_stack <span class="variable-name">ecx</span>
   pop_return_stack <span class="variable-name">edx</span>

   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   push_return_stack <span class="variable-name">eax</span>
   push_return_stack <span class="variable-name">ebx</span>

   push_return_stack <span class="variable-name">edx</span>
   push_return_stack <span class="variable-name">ecx</span>

<span class="function-name">.next</span>:
   <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">ebx</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">cmp</span> <span class="variable-name">eax</span>, <span class="keyword">end</span>
   <span class="builtin">je</span> .then
   <span class="builtin">jmp</span> .next
<span class="function-name">.then</span>:
   <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
   push_return_stack <span class="variable-name">ebx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"instruction,exception-head"</span>, exception_head
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   pop_return_stack <span class="variable-name">rax</span>
   pop_return_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"drop"</span>, drop
   <span class="comment">;; &lt;&lt; a -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"drop2"</span>, drop2
   <span class="comment">;; &lt;&lt; a b -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   pop_argument_stack <span class="variable-name">rax</span>
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"dup"</span>, <span class="keyword">dup</span>
   <span class="comment">;; &lt;&lt; a -- a, a &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"dup2"</span>, dup2
   <span class="comment">;; &lt;&lt; a b -- a b a b &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"dup"</span>, <span class="keyword">dup</span>
   <span class="comment">;; &lt;&lt; a -- a a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"dup2"</span>, dup2
   <span class="comment">;; &lt;&lt; a b -- a b a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"over"</span>, over
   <span class="comment">;; &lt;&lt; a b -- a b | a &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|over|xx"</span>, xoverxx
   <span class="comment">;; &lt;&lt; a | b c -- a | b c | a &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">3</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|over|x"</span>, xxoverx
   <span class="comment">;; &lt;&lt; a b | c -- a b | c | a b &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">3</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">3</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|over|xx"</span>, xxoverxx
   <span class="comment">;; &lt;&lt; a b | c d -- a b | c d | a b &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">4</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">4</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|over|xxx"</span>, xoverxxx
   <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">4</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|over|xxxx"</span>, xoverxxxx
   <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">5</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|over|xxxx"</span>, xxoverxxxx
   <span class="comment">;; &lt;&lt; a b | c d e f -- a b | c d e f | a b &gt;&gt;
</span>   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">6</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span>  <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">6</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"over"</span>, over
   <span class="comment">;; &lt;&lt; a b -- a b | a &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|over|xx"</span>, xoverxx
   <span class="comment">;; &lt;&lt; a | b c -- a | b c | a &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">3</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|over|x"</span>, xxoverx
   <span class="comment">;; &lt;&lt; a b | c -- a b | c | a b &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">3</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|over|xx"</span>, xxoverxx
   <span class="comment">;; &lt;&lt; a b | c d -- a b | c d | a b &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">4</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">3</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|over|xxx"</span>, xoverxxx
   <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">4</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|over|xxxx"</span>, xoverxxxx
   <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">5</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|over|xxxx"</span>, xxoverxxxx
   <span class="comment">;; &lt;&lt; a b | c d e f -- a b | c d e f | a b &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">6</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">5</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"tuck"</span>, tuck
   <span class="comment">;; &lt;&lt; a b -- b | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"x|tuck|xx"</span>, xtuckxx
   <span class="comment">;; &lt;&lt; a | b c -- b c | a | b c &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   next

define_primitive_function <span class="string">"xx|tuck|x"</span>, xxtuckx
   <span class="comment">;; &lt;&lt; a b | c -- c | a b | c &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   next

define_primitive_function <span class="string">"xx|tuck|xx"</span>, xxtuckxx
   <span class="comment">;; &lt;&lt; a b | c d -- c d | a b | c d &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   next

define_primitive_function <span class="string">"xxx|tuck|x"</span>, xxxtuckx
   <span class="comment">;; &lt;&lt; a b c | d -- d | a b c | d &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"swap"</span>, swap
   <span class="comment">;; &lt;&lt; a b -- b a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"x|swap|xx"</span>, xswapxx
   <span class="comment">;; &lt;&lt; a | b c -- b c | a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xx|swap|x"</span>, xxswapx
   <span class="comment">;; &lt;&lt; a b | c -- c | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"x|swap|xxx"</span>, xswapxxx
   <span class="comment">;; &lt;&lt; a | b c d -- b c d | a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xxx|swap|x"</span>, xxxswapx
   <span class="comment">;; &lt;&lt; a b c | d -- d | a b c &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   next

define_primitive_function <span class="string">"xx|swap|xx"</span>, xxswapxx
   <span class="comment">;; &lt;&lt; a b | c d -- c d | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   next


define_primitive_function <span class="string">"x|swap|xxxx"</span>, xswapxxxx
   <span class="comment">;; &lt;&lt; a | b c d e -- b c d e | a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"xxxx|swap|x"</span>, xxxxswapx
   <span class="comment">;; &lt;&lt; a b c d | e --  e | a b c d &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   next


define_primitive_function <span class="string">"xx|swap|xxxx"</span>, xxswapxxxx
   <span class="comment">;; &lt;&lt; a b | c d e f -- c d e f | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>   pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   push_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"xxxx|swap|xx"</span>, xxxxswapxx
   <span class="comment">;; &lt;&lt; a b c d | e f --  e f | a b c d &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>   pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>   push_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>   push_argument_stack <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rcx</span>
   push_argument_stack <span class="variable-name">rdx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"swap"</span>, swap
   <span class="comment">;; &lt;&lt; a b -- b a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">eax</span>
   next

define_primitive_function <span class="string">"x|swap|xx"</span>, xswapxx
   <span class="comment">;; &lt;&lt; a | b c -- b c | a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">eax</span>
   next

define_primitive_function <span class="string">"xx|swap|x"</span>, xxswapx
   <span class="comment">;; &lt;&lt; a b | c -- c | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   next

define_primitive_function <span class="string">"x|swap|xxx"</span>, xswapxxx
   <span class="comment">;; &lt;&lt; a | b c d -- b c d | a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">edx</span>
   push_argument_stack <span class="variable-name">eax</span>
   next

define_primitive_function <span class="string">"xxx|swap|x"</span>, xxxswapx
   <span class="comment">;; &lt;&lt; a b c | d -- d | a b c &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">edx</span>
   push_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">ecx</span>
   next

define_primitive_function <span class="string">"xx|swap|xx"</span>, xxswapxx
   <span class="comment">;; &lt;&lt; a b | c d -- c d | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">edx</span>
   push_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   next


define_primitive_function <span class="string">"x|swap|xxxx"</span>, xswapxxxx
   <span class="comment">;; &lt;&lt; a | b c d e -- b c d e | a &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>   <span class="builtin">push</span> <span class="variable-name">eax</span>

   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">edx</span>

   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
   push_argument_stack <span class="variable-name">eax</span>
   next

define_primitive_function <span class="string">"xxxx|swap|x"</span>, xxxxswapx
   <span class="comment">;; &lt;&lt; a b c d | e --  e | a b c d &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>   <span class="builtin">push</span> <span class="variable-name">eax</span>

   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>

   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
   push_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">edx</span>
   next


define_primitive_function <span class="string">"xx|swap|xxxx"</span>, xxswapxxxx
   <span class="comment">;; &lt;&lt; a b | c d e f -- c d e f | a b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>   <span class="builtin">push</span> <span class="variable-name">eax</span>

   pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>   <span class="builtin">push</span> <span class="variable-name">eax</span>

   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">edx</span>

   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>
   push_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   next

define_primitive_function <span class="string">"xxxx|swap|xx"</span>, xxxxswapxx
   <span class="comment">;; &lt;&lt; a b c d | e f --  e f | a b c d &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>   <span class="builtin">push</span> <span class="variable-name">eax</span>

   pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>   <span class="builtin">push</span> <span class="variable-name">eax</span>

   pop_argument_stack <span class="variable-name">edx</span>
   pop_argument_stack <span class="variable-name">ecx</span>
   pop_argument_stack <span class="variable-name">ebx</span>
   pop_argument_stack <span class="variable-name">eax</span>

   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
   <span class="builtin">pop</span> <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>
   push_argument_stack <span class="variable-name">eax</span>
   push_argument_stack <span class="variable-name">ebx</span>
   push_argument_stack <span class="variable-name">ecx</span>
   push_argument_stack <span class="variable-name">edx</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_variable <span class="string">"*the-stack*"</span>, V__the_stack
   <span class="type">xx</span> address$argument_stack

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_variable <span class="string">"*the-stack-pointer-snapshot*"</span>, V__the_stack_pointer_snapshot
   <span class="type">xx</span> address$argument_stack

define_primitive_function <span class="string">"snapshot-the-stack-pointer"</span>, snapshot_the_stack_pointer
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>V__the_stack_pointer_snapshot + jo_size<span class="rainbow-delimiters-depth-2">]</span>, pointer$argument_stack
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_variable <span class="string">"*the-stack-pointer-snapshot*"</span>, V__the_stack_pointer_snapshot
   <span class="type">xx</span> address$argument_stack

define_primitive_function <span class="string">"snapshot-the-stack-pointer"</span>, snapshot_the_stack_pointer
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>V__the_stack_pointer_snapshot + jo_size<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">eax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"false"</span>, false
   <span class="comment">;; &lt;&lt; -- false &gt;&gt;
</span>   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"true"</span>, true
   <span class="comment">;; &lt;&lt; -- true &gt;&gt;
</span>   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_function <span class="string">"false?"</span>, false?
   <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> false, equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"true?"</span>, true?
   <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> true, equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"not"</span>, CICADA__not
   <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> false, equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"and"</span>, CICADA__and
   <span class="comment">;; &lt;&lt; bool, bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.true-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   drop
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.true</span>:
   <span class="type">xx</span> <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"or"</span>, CICADA__or
   <span class="comment">;; &lt;&lt; bool, bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.false-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   drop
   <span class="type">xx</span>   true
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.false</span>:
   <span class="type">xx</span> <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"xor"</span>, CICADA__xor
   <span class="comment">;; &lt;&lt; bool, bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.false-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   CICADA__not
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.false</span>:
   <span class="type">xx</span> <span class="keyword">end</span>

define_primitive_function <span class="string">"zero"</span>, zero
   <span class="comment">;; &lt;&lt; -- 0 &gt;&gt;
</span>   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"one"</span>, one
   <span class="comment">;; &lt;&lt; -- 1 &gt;&gt;
</span>   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_function <span class="string">"zero?"</span>, zero?
   <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> zero, equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"one?"</span>, one?
   <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>   <span class="type">xx</span> one, equal?
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"add1"</span>, add1
   <span class="comment">;; &lt;&lt; n -- n+1 &gt;&gt;
</span>   <span class="builtin">inc</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   next

define_primitive_function <span class="string">"add2"</span>, add2
   <span class="comment">;; &lt;&lt; n -- n+2 &gt;&gt;
</span>   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">2</span>
   next

define_primitive_function <span class="string">"add3"</span>, add3
   <span class="comment">;; &lt;&lt; n -- n+3 &gt;&gt;
</span>   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">3</span>
   next

define_primitive_function <span class="string">"add4"</span>, add4
   <span class="comment">;; &lt;&lt; n -- n+4 &gt;&gt;
</span>   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">4</span>
   next

define_primitive_function <span class="string">"add8"</span>, add8
   <span class="comment">;; &lt;&lt; n -- n+8 &gt;&gt;
</span>   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">8</span>
   next


define_primitive_function <span class="string">"sub1"</span>, sub1
   <span class="comment">;; &lt;&lt; n -- n-1 &gt;&gt;
</span>   <span class="builtin">dec</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   next

define_primitive_function <span class="string">"sub2"</span>, sub2
   <span class="comment">;; &lt;&lt; n -- n-2 &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">2</span>
   next

define_primitive_function <span class="string">"sub3"</span>, sub3
   <span class="comment">;; &lt;&lt; n -- n-3 &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">3</span>
   next

define_primitive_function <span class="string">"sub4"</span>, sub4
   <span class="comment">;; &lt;&lt; n -- n-4 &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">4</span>
   next

define_primitive_function <span class="string">"sub8"</span>, sub8
   <span class="comment">;; &lt;&lt; n -- n-8 &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="constant">8</span>
   next


define_primitive_function <span class="string">"add"</span>, addition
   <span class="comment">;; &lt;&lt; a b -- a+b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub"</span>, subtraction
   <span class="comment">;; &lt;&lt; a b -- a-b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"add1"</span>, add1
   <span class="comment">;; &lt;&lt; n -- n+1 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"add2"</span>, add2
   <span class="comment">;; &lt;&lt; n -- n+2 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"add3"</span>, add3
   <span class="comment">;; &lt;&lt; n -- n+3 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"add4"</span>, add4
   <span class="comment">;; &lt;&lt; n -- n+4 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   <span class="builtin">inc</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"add8"</span>, add8
   <span class="comment">;; &lt;&lt; n -- n+8 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, <span class="constant">8</span>
   push_argument_stack <span class="variable-name">rax</span>
   next


define_primitive_function <span class="string">"sub1"</span>, sub1
   <span class="comment">;; &lt;&lt; n -- n-1 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub2"</span>, sub2
   <span class="comment">;; &lt;&lt; n -- n-2 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub3"</span>, sub3
   <span class="comment">;; &lt;&lt; n -- n-3 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub4"</span>, sub4
   <span class="comment">;; &lt;&lt; n -- n-4 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   <span class="builtin">dec</span> <span class="variable-name">rax</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub8"</span>, sub8
   <span class="comment">;; &lt;&lt; n -- n-8 &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="variable-name">rax</span>, <span class="constant">8</span>
   push_argument_stack <span class="variable-name">rax</span>
   next


define_primitive_function <span class="string">"add"</span>, addition
   <span class="comment">;; &lt;&lt; a b -- a+b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub"</span>, subtraction
   <span class="comment">;; &lt;&lt; a b -- a-b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"mul"</span>, multiple
   <span class="comment">;; &lt;&lt; a b -- a*b &gt;&gt;
</span>   pop_argument_stack  <span class="variable-name">rbx</span> <span class="comment">;; 2ed arg
</span>   pop_argument_stack  <span class="variable-name">rax</span> <span class="comment">;; 1st arg
</span>   <span class="builtin">imul</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
   <span class="comment">;; imul will ignore overflow
</span>   <span class="comment">;; when there are two registers as arg
</span>   <span class="comment">;; imul will save the result into the first register
</span>   push_argument_stack <span class="variable-name">rbx</span>
   next

define_function <span class="string">"negate"</span>, negate
   <span class="comment">;; &lt;&lt; n --  -n &gt;&gt;
</span>   <span class="type">xx</span> zero
   <span class="type">xx</span> swap, subtraction
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"power"</span>, power
   <span class="comment">;; n must be nature number for now
</span>   <span class="comment">;; &lt;&lt; a, n -- a^n &gt;&gt;
</span>   <span class="comment">;; 1. when a = 0, n =/= 0
</span>   <span class="comment">;;    the power__loop returns 0
</span>   <span class="comment">;; 2. when a = 0, n = 0
</span>   <span class="comment">;;    the power__loop returns 1
</span>   <span class="comment">;;    but I need it to return 0
</span>   <span class="type">xx</span> over, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   drop
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, swap <span class="comment">;; leave product
</span>   <span class="type">xx</span> power__loop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"power,loop"</span>, power__loop
   <span class="comment">;; &lt;&lt; a, product, n -- a^n &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop, swap, drop
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> sub1
   <span class="type">xx</span> swap
   <span class="type">xx</span>   xoverxx, multiple
   <span class="type">xx</span> swap
   <span class="type">xx</span> <span class="keyword">taca</span>, power__loop

define_primitive_function <span class="string">"moddiv"</span>, moddiv
   <span class="comment">;; &lt;&lt; a, b -- a mod b, quotient &gt;&gt;
</span>   <span class="comment">;; &lt;&lt; dividend, divisor -- remainder, quotient &gt;&gt;
</span>   <span class="comment">;; the arg of idiv is divisor
</span>   <span class="comment">;; the lower half of dividend is taken from rax
</span>   <span class="comment">;; the upper half of dividend is taken from rdx
</span>   <span class="builtin">xor</span>  <span class="variable-name">rdx</span>, <span class="variable-name">rdx</span>   <span class="comment">;; high-part of dividend is not used
</span>   pop_argument_stack  <span class="variable-name">rbx</span> <span class="comment">;; 2ed arg
</span>   pop_argument_stack  <span class="variable-name">rax</span> <span class="comment">;; 1st arg
</span>   <span class="builtin">idiv</span> <span class="variable-name">rbx</span>
   <span class="comment">;; the remainder is stored in rdx
</span>   <span class="comment">;; the quotient  is stored in rax
</span>   push_argument_stack <span class="variable-name">rdx</span> <span class="comment">;; remainder
</span>   push_argument_stack <span class="variable-name">rax</span> <span class="comment">;; quotient
</span>   next


define_function <span class="string">"divmod"</span>, divmod
   <span class="comment">;; &lt;&lt; a, b -- quotient, a mod b &gt;&gt;
</span>   <span class="type">xx</span> moddiv, swap
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"div"</span>, division
   <span class="comment">;; &lt;&lt; a, b -- quotient &gt;&gt;
</span>   <span class="type">xx</span> divmod, drop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"mod"</span>, modulo
   <span class="comment">;; &lt;&lt; a, b -- a mod b &gt;&gt;
</span>   <span class="type">xx</span> moddiv, drop
   <span class="type">xx</span> <span class="keyword">end</span>

define_primitive_function <span class="string">"equal?"</span>, equal?
   <span class="comment">;; &lt;&lt; a, b -- bool &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span>   <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
   <span class="builtin">sete</span>  <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"less-than?"</span>, less_than?
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   <span class="builtin">setl</span>  <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"greater-than?"</span>, greater_than?
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   <span class="builtin">setg</span>  <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack  <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"less-or-equal?"</span>, less_or_equal?
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   <span class="builtin">setle</span> <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"greater-or-equal?"</span>, greater_or_equal?
   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   <span class="builtin">setge</span> <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_function <span class="string">"equal2?"</span>, equal2?
   <span class="comment">;; &lt;&lt; a1, b1, a2, b2 -- bool &gt;&gt;
</span>   <span class="type">xx</span> xswapxx
   <span class="type">xx</span> equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"negative?"</span>, negative?
   <span class="comment">;; &lt;&lt; integer -- bool &gt;&gt;
</span>   <span class="type">xx</span> zero, less_than?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"positive?"</span>, positive?
   <span class="comment">;; &lt;&lt; integer -- bool &gt;&gt;
</span>   <span class="type">xx</span> zero, greater_than?
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"fetch"</span>, fetch
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack  <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"fetch-byte"</span>, fetch_byte
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span><span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"fetch-two-bytes"</span>, fetch_two_bytes
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">ax</span>, <span class="type">word</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"fetch-four-bytes"</span>, fetch_four_bytes
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"n-fetch"</span>, n_fetch
   <span class="comment">;; &lt;&lt; address, n -- value-1, ..., value-n &gt;&gt;
</span>   pop_argument_stack  <span class="variable-name">rcx</span>
   pop_argument_stack  <span class="variable-name">rdx</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rdx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rdx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"save"</span>, save
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"save-byte"</span>, save_byte
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">byte</span><span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">al</span>
   next

define_primitive_function <span class="string">"save-two-bytes"</span>, save_two_bytes
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">word</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">ax</span>
   next

define_primitive_function <span class="string">"save-four-bytes"</span>, save_four_bytes
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">eax</span>
   next

define_primitive_function <span class="string">"n-save"</span>, n_save
   <span class="comment">;; &lt;&lt; value-n, ..., value-1, address, n -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
   <span class="builtin">add</span> <span class="variable-name">rdx</span>, <span class="variable-name">rax</span>
   <span class="comment">;; for address is based on 0
</span>   <span class="comment">;; but n is based on 1
</span>   <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
<span class="function-name">.loop</span>:
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rdx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

define_primitive_function <span class="string">"add-save"</span>, add_save
   <span class="comment">;; ( number to add, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub-save"</span>, sub_save
   <span class="comment">;; ( number to sub, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"fetch"</span>, fetch
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack  <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"fetch-byte"</span>, fetch_byte
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span><span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"fetch-two-bytes"</span>, fetch_two_bytes
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">ax</span>, <span class="type">word</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"fetch-four-bytes"</span>, fetch_four_bytes
   <span class="comment">;; ( address -- value )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"n-fetch"</span>, n_fetch
   <span class="comment">;; &lt;&lt; address, n -- value-1, ..., value-n &gt;&gt;
</span>   pop_argument_stack  <span class="variable-name">rcx</span>
   pop_argument_stack  <span class="variable-name">rdx</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rdx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rdx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"save"</span>, save
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"save-byte"</span>, save_byte
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">byte</span><span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">al</span>
   next

define_primitive_function <span class="string">"save-two-bytes"</span>, save_two_bytes
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">word</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">ax</span>
   next

define_primitive_function <span class="string">"save-four-bytes"</span>, save_four_bytes
   <span class="comment">;; ( value, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">eax</span>
   next

define_primitive_function <span class="string">"n-save"</span>, n_save
   <span class="comment">;; &lt;&lt; value-n, ..., value-1, address, n -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
   <span class="builtin">add</span> <span class="variable-name">rdx</span>, <span class="variable-name">rax</span>
   <span class="comment">;; for address is based on 0
</span>   <span class="comment">;; but n is based on 1
</span>   <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
<span class="function-name">.loop</span>:
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rdx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

define_primitive_function <span class="string">"add-save"</span>, add_save
   <span class="comment">;; ( number to add, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"sub-save"</span>, sub_save
   <span class="comment">;; ( number to sub, address -- )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"clear-memory"</span>, clear_memory
   <span class="comment">;; &lt;&lt; size, address -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rdx</span>
   pop_argument_stack <span class="variable-name">rcx</span>
   <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="type">byte</span> <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rdx</span><span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">al</span>
   <span class="builtin">inc</span> <span class="variable-name">rdx</span>
   <span class="builtin">dec</span> <span class="variable-name">rcx</span>
   <span class="builtin">loop</span> .loop
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"bit-and"</span>, bit_and
   <span class="comment">;; &lt;&lt; a, b -- a and b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">and</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"bit-or"</span>, bit_or
   <span class="comment">;; &lt;&lt; a, b -- a or b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">or</span>  <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"bit-xor"</span>, bit_xor
   <span class="comment">;; &lt;&lt; a, b -- a xor b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">xor</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"bit-invert"</span>, bit_invert
   <span class="comment">;; &lt;&lt; a -- invert a &gt;&gt;
</span>   <span class="builtin">not</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"bit-and"</span>, bit_and
   <span class="comment">;; &lt;&lt; a, b -- a and b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">and</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"bit-or"</span>, bit_or
   <span class="comment">;; &lt;&lt; a, b -- a or b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">or</span>  <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"bit-xor"</span>, bit_xor
   <span class="comment">;; &lt;&lt; a, b -- a xor b &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">xor</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rbx</span>
   next

define_primitive_function <span class="string">"bit-invert"</span>, bit_invert
   <span class="comment">;; &lt;&lt; a -- invert a &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">not</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"bit-left"</span>, bit_left
   <span class="comment">;; ( fixnum, step -- fixnum * 2^step )
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">shl</span> <span class="variable-name">rax</span>, <span class="variable-name">cl</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"bit-right"</span>, bit_right
   <span class="comment">;; ( fixnum, step -- fixnum / 2^step )
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">shr</span> <span class="variable-name">rax</span>, <span class="variable-name">cl</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"bit-right,sign"</span>, bit_right__sign
   <span class="comment">;; ( fixnum, step -- new fixnum )
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sar</span> <span class="variable-name">rax</span>, <span class="variable-name">cl</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="comment">;; BT copies a bit from a given register to the carry flag
</span>define_primitive_function <span class="string">"get-bit"</span>, get_bit
   <span class="comment">;; ( fixnum, offset -- bit )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">bt</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   <span class="builtin">setc</span> <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"set-bit"</span>, set_bit
   <span class="comment">;; ( fixnum, offset -- fixnum )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">bts</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"clear-bit"</span>, clear_bit
   <span class="comment">;; ( fixnum, offset -- fixnum )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">btr</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"invert-bit"</span>, invert_bit
   <span class="comment">;; ( fixnum, offset -- fixnum )
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">btc</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"find-lowest-set-bit"</span>, find_lowest_set_bit
   <span class="comment">;; ( fixnum -- offset )
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">bsf</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">jz</span> @f
   push_argument_stack <span class="variable-name">rax</span>
   next
<span class="function-name">@@</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, -<span class="constant">1</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"find-highest-set-bit"</span>, find_highest_set_bit
   <span class="comment">;; ( fixnum -- offset )
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">bsr</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="builtin">jz</span> @f
   push_argument_stack <span class="variable-name">rax</span>
   next
<span class="function-name">@@</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, -<span class="constant">1</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">buffer$write_byte</span>:
   <span class="type">db</span> <span class="constant">0</span>

define_primitive_function <span class="string">"write-byte"</span>, write_byte
   <span class="comment">;; &lt;&lt; byte -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="comment">;; write can not just write the char in al to stdout
</span>   <span class="comment">;; write needs the address of the byte to write
</span>   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>buffer$write_byte<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">al</span>
   <span class="builtin">mov</span> linux64_sys_3_rdx, <span class="constant">1</span>                 <span class="comment">;; max length to be write
</span>   <span class="builtin">mov</span> linux64_sys_2_rsi, buffer$write_byte <span class="comment">;; address
</span>   <span class="builtin">mov</span> linux64_sys_1_rdi, <span class="constant">1</span>                 <span class="comment">;; stdout
</span>   <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_write
   <span class="builtin">syscall</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

<span class="function-name">buffer$write_byte</span>:
   <span class="type">db</span> <span class="constant">0</span>

define_primitive_function <span class="string">"write-byte"</span>, write_byte
   <span class="comment">;; &lt;&lt; byte -- &gt;&gt;
</span>   <span class="comment">;; just calls the Linux write system call
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="comment">;; write can not just write the char in al to stdout
</span>   <span class="comment">;; write needs the address of the byte to write
</span>   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span>buffer$write_byte<span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">al</span>
   <span class="builtin">mov</span> linux32_sys_3_edx, <span class="constant">1</span>                 <span class="comment">;; max length to be write
</span>   <span class="builtin">mov</span> linux32_sys_2_ecx, buffer$write_byte <span class="comment">;; address
</span>   <span class="builtin">mov</span> linux32_sys_1_ebx, <span class="constant">1</span>                 <span class="comment">;; stdout
</span>   <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_write
   <span class="builtin">syscall</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

size$reading_stack = <span class="constant">1024</span> * jo_size

   <span class="type">preserve</span> <span class="constant">64</span> * jo_size
address$reading_stack <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$reading_stack

<span class="function-name">pointer$reading_stack</span>:
   <span class="type">xx</span> address$reading_stack

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"push-reading-stack"</span>, push_reading_stack
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   next

define_primitive_function <span class="string">"pop-reading-stack"</span>, pop_reading_stack
   <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"drop-reading-stack"</span>, drop_reading_stack
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">qword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, <span class="rainbow-delimiters-depth-2">(</span>jo_size * <span class="constant">2</span><span class="rainbow-delimiters-depth-2">)</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"push-reading-stack"</span>, push_reading_stack
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rsi</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rsi</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   next

define_primitive_function <span class="string">"pop-reading-stack"</span>, pop_reading_stack
   <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rsi</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rsi</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_primitive_function <span class="string">"drop-reading-stack"</span>, drop_reading_stack
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="builtin">sub</span> <span class="type">dword</span> <span class="rainbow-delimiters-depth-2">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-2">]</span>, <span class="rainbow-delimiters-depth-2">(</span>jo_size * <span class="constant">2</span><span class="rainbow-delimiters-depth-2">)</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

define_primitive_function <span class="string">"tos-reading-stack"</span>, tos_reading_stack
   <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-1">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-1">]</span>
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-1">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-1">[</span>pointer$reading_stack<span class="rainbow-delimiters-depth-1">]</span>
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-1">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_function <span class="string">"reading-stack-empty?"</span>, reading_stack_empty?
   <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, pointer$reading_stack, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, address$reading_stack
   <span class="type">xx</span> equal?
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"read-line-from-stdin"</span>, read_line_from_stdin
   <span class="comment">;; &lt;&lt; buffer address, max length -- counter &gt;&gt;
</span>   pop_argument_stack linux64_sys_3_rdx
   pop_argument_stack linux64_sys_2_rsi
   <span class="builtin">xor</span> linux64_sys_1_rdi, linux64_sys_1_rdi <span class="comment">;; stdin
</span>   <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_read
   <span class="builtin">syscall</span>
   <span class="comment">;; the return value
</span>   <span class="comment">;; is a count of the number of bytes transferred
</span>   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"read-line-from-stdin"</span>, read_line_from_stdin
   <span class="comment">;; &lt;&lt; buffer address, max length -- counter &gt;&gt;
</span>   pop_argument_stack linux32_sys_3_edx
   pop_argument_stack linux32_sys_2_ecx
   <span class="builtin">xor</span> linux32_sys_1_ebx, linux32_sys_1_ebx <span class="comment">;; stdin
</span>   <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_read
   <span class="builtin">syscall</span>
   <span class="comment">;; the return value
</span>   <span class="comment">;; is a count of the number of bytes transferred
</span>   push_argument_stack <span class="variable-name">rax</span>
   next

<span class="rainbow-delimiters-depth-1">}</span>

max_input_length = <span class="constant">64</span> * <span class="constant">1024</span>

buffer$reading <span class="keyword">labeling</span>
   <span class="type">preserve</span> max_input_length

replace$reading <span class="keyword">labeling</span>
   <span class="type">preserve</span> <span class="constant">1024</span>

define_function <span class="string">"read-byte"</span>, read_byte
   <span class="comment">;; &lt;&lt; -- byte &gt;&gt;
</span>   <span class="type">xx</span> pop_reading_stack
   <span class="type">xx</span> dup2, empty_string?, CICADA__not, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.bad_tos-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   sub1, swap
   <span class="type">xx</span>   tuck
   <span class="type">xx</span>   add1, swap
   <span class="type">xx</span>   push_reading_stack
   <span class="type">xx</span>   fetch_byte
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.bad_tos</span>:
   <span class="type">xx</span> reading_stack_empty?, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.not_empty-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$reading
   <span class="type">xx</span>   <span class="keyword">literal</span>, max_input_length
   <span class="type">xx</span>   read_line_from_stdin
   <span class="type">xx</span>   <span class="keyword">dup</span>, positive?, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.read_error-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>     <span class="keyword">literal</span>, buffer$reading
   <span class="type">xx</span>     swap
   <span class="type">xx</span>     push_reading_stack
   <span class="type">xx</span>     <span class="keyword">taca</span>, read_byte
<span class="function-name">.read_error</span>:
   <span class="comment">;;   ignore &lt;end-of-file&gt;
</span>   <span class="comment">;;   ignore reading error
</span>   <span class="type">xx</span>   drop
   <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$reading
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
   <span class="type">xx</span>   push_reading_stack
   <span class="type">xx</span>   <span class="keyword">taca</span>, read_byte
<span class="function-name">.not_empty</span>:
   <span class="type">xx</span>   <span class="keyword">literal</span>, error$read_byte
   <span class="type">xx</span>   <span class="keyword">literal</span>, length$read_byte
   <span class="type">xx</span>   write_string
   <span class="type">xx</span>   <span class="keyword">literal</span>, replace$reading
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">1024</span>
   <span class="type">xx</span>   read_line_from_stdin
   <span class="type">xx</span>   <span class="keyword">literal</span>, replace$reading
   <span class="type">xx</span>   swap
   <span class="type">xx</span>   push_reading_stack
   <span class="type">xx</span>   <span class="keyword">taca</span>, read_byte

<span class="function-name">error$read_byte</span>:
   <span class="type">db</span> <span class="string">"* (read-byte) meets empty-string in reading-stack"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  and this empty-stack is not at the bottom of the reading-stack"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  you can type a line to replace this empty string"</span>, <span class="constant">10</span>
<span class="function-name">.end</span>:
length$read_byte = <span class="rainbow-delimiters-depth-1">(</span>.end - error$read_byte<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"load-core-file"</span>, load_core_file
   <span class="comment">;; &lt;&lt; unknown -- unknown &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, address$core_file
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="rainbow-delimiters-depth-1">(</span>end$core_file - address$core_file<span class="rainbow-delimiters-depth-1">)</span>
   <span class="type">xx</span> push_reading_stack
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"space-char?"</span>, space_char?
   <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">32</span>
   <span class="type">xx</span> less_or_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"bar-ket-char?"</span>, bar_ket_char?
   <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'('</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">')'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'['</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">']'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'{'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'}'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'"'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> drop, false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"digit-char?"</span>, digit_char?
   <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'0'</span>, less_than?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'9'</span>, less_or_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> drop, false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"digit-char-&gt;number"</span>, digit_char_to_number
   <span class="comment">;; &lt;&lt; char -- decimal-digit &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'0'</span>
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"number-&gt;digit-char"</span>, number_to_digit_char
   <span class="comment">;; &lt;&lt; decimal-digit -- char &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'0'</span>
   <span class="type">xx</span> addition
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="comment">;; return false when length == 0
</span>define_primitive_function <span class="string">"compare-buffer"</span>, compare_buffer
   <span class="comment">;; &lt;&lt; address, address, length -- bool &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdi</span>
   pop_argument_stack <span class="variable-name">rsi</span>
   <span class="builtin">repe</span> <span class="builtin">cmpsb</span>
   <span class="builtin">sete</span> <span class="variable-name">al</span>
   <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

define_function <span class="string">"cursor-&gt;next-matching-byte"</span>, cursor_to_next_matching_byte
   <span class="comment">;; &lt;&lt; cursor, byte -- cursor new address &gt;&gt;
</span>   <span class="type">xx</span> over, add1, fetch_byte
   <span class="type">xx</span> over, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop, add1
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> swap
   <span class="type">xx</span> add1, swap
   <span class="type">xx</span> <span class="keyword">taca</span>, cursor_to_next_matching_byte

define_function <span class="string">"write-string"</span>, write_string
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> sub1, swap
   <span class="type">xx</span> <span class="keyword">dup</span>, fetch_byte, write_byte
   <span class="type">xx</span> add1, swap
   <span class="type">xx</span> <span class="keyword">taca</span>, write_string

define_function <span class="string">".s"</span>, ALIAS__write_string
   <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"pretty-write-string"</span>, pretty_write_string
   <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>
   <span class="type">xx</span> write_byte
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"empty-string?"</span>, empty_string?
  <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>  <span class="type">xx</span> swap, drop
  <span class="type">xx</span> zero?
  <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"string-equal?"</span>, string_equal?
   <span class="comment">;; &lt;&lt; string[address, length], string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> xoverxx, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   swap
   <span class="type">xx</span>   compare_buffer
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> drop, drop2
   <span class="type">xx</span> false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"string-head,char"</span>, string_head__char
   <span class="comment">;; &lt;&lt; string[address, length] -- char &gt;&gt;
</span>   <span class="type">xx</span> drop, fetch_byte
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"string-tail,char"</span>, string_tail__char
   <span class="comment">;; &lt;&lt; string[address, length] -- [address + 1, length + 1] &gt;&gt;
</span>   <span class="type">xx</span> sub1, swap
   <span class="type">xx</span> add1
   <span class="type">xx</span> swap
   <span class="type">xx</span> <span class="keyword">end</span>

define_primitive_function <span class="string">"string-&gt;buffer!"</span>, string_to_buffer!
   <span class="comment">;; ( string[address, length], buffer[address] -- )
</span>   pop_argument_stack <span class="variable-name">rdi</span> <span class="comment">;; destination
</span>   pop_argument_stack <span class="variable-name">rcx</span> <span class="comment">;; counter
</span>   pop_argument_stack <span class="variable-name">rsi</span> <span class="comment">;; source
</span>   <span class="builtin">rep</span> <span class="builtin">movsb</span>
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

buffer$string_reverse! <span class="keyword">labeling</span>
   <span class="type">preserve</span> <span class="constant">1024</span>


define_primitive_function <span class="string">"string-reverse!"</span>, string_reverse!
   <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rdi</span>, buffer$string_reverse!
   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">rep</span> <span class="builtin">movsb</span>

   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">dec</span> <span class="variable-name">rdi</span> <span class="comment">;; cursor back into string in buffer$string_reverse!
</span>   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rdi</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="type">byte</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rsi</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">al</span>
   <span class="builtin">dec</span> <span class="variable-name">rdi</span>
   <span class="builtin">inc</span> <span class="variable-name">rsi</span>
   <span class="builtin">loop</span> .loop

   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

buffer$string_reverse! <span class="keyword">labeling</span>
   <span class="type">preserve</span> <span class="constant">1024</span>


define_primitive_function <span class="string">"string-reverse!"</span>, string_reverse!
   <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$argument_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rdi</span>, buffer$string_reverse!
   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">rep</span> <span class="builtin">movsb</span>

   <span class="builtin">mov</span> <span class="variable-name">rcx</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">1</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">dec</span> <span class="variable-name">rdi</span> <span class="comment">;; cursor back into string in buffer$string_reverse!
</span>   <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rdi</span><span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="type">byte</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rsi</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">al</span>
   <span class="builtin">dec</span> <span class="variable-name">rdi</span>
   <span class="builtin">inc</span> <span class="variable-name">rsi</span>
   <span class="builtin">loop</span> .loop

   next

<span class="rainbow-delimiters-depth-1">}</span>

define_function <span class="string">"char-string?"</span>, char_string?
   <span class="comment">;; &lt;&lt; string[address, length], char -- bool &gt;&gt;
</span>   <span class="type">xx</span> xxswapx
   <span class="type">xx</span> <span class="keyword">dup</span>, one?, false?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop2, drop
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> string_head__char, equal?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"zero-string?"</span>, zero_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> dup2, <span class="keyword">literal</span>, <span class="default">'0'</span>, char_string?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_head__char, <span class="keyword">literal</span>, <span class="default">'-'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> string_tail__char, <span class="keyword">literal</span>, <span class="default">'0'</span>, char_string?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"digit-string?"</span>, digit_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> over, fetch_byte, digit_char?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   string_tail__char
   <span class="type">xx</span>   <span class="keyword">taca</span>, digit_string?
   <span class="type">xx</span> drop2, false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"integer-string?"</span>, integer_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, <span class="keyword">literal</span>, <span class="default">'-'</span>, char_string?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char, <span class="keyword">literal</span>, <span class="default">'-'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   string_tail__char
   <span class="type">xx</span>   digit_string?
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> digit_string?
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">sum$digit_string_to_number</span>:
   <span class="type">xx</span> <span class="constant">0</span>

<span class="function-name">counter$digit_string_to_number</span>:
   <span class="type">xx</span> <span class="constant">0</span>

define_function <span class="string">"digit-string-&gt;number"</span>, digit_string_to_number
   <span class="comment">;; &lt;&lt; string[address, length] -- integer &gt;&gt;
</span>   <span class="type">xx</span> zero, <span class="keyword">literal</span>, sum$digit_string_to_number, save
   <span class="type">xx</span> zero, <span class="keyword">literal</span>, counter$digit_string_to_number, save

   <span class="type">xx</span> dup2, string_reverse!
   <span class="type">xx</span>   help__digit_string_to_number
   <span class="type">xx</span> string_reverse!, drop2

   <span class="type">xx</span> <span class="keyword">literal</span>, sum$digit_string_to_number
   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"help,digit-string-&gt;number"</span>, help__digit_string_to_number
   <span class="comment">;; &lt;&lt; reversed-string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> dup2, string_head__char, digit_char_to_number
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">10</span>
   <span class="type">xx</span>   <span class="keyword">literal</span>, counter$digit_string_to_number, fetch
   <span class="type">xx</span>     one
   <span class="type">xx</span>     <span class="keyword">literal</span>, counter$digit_string_to_number
   <span class="type">xx</span>     add_save
   <span class="type">xx</span>   power
   <span class="type">xx</span> multiple

   <span class="type">xx</span> <span class="keyword">literal</span>, sum$digit_string_to_number
   <span class="type">xx</span> add_save

   <span class="type">xx</span> string_tail__char
   <span class="type">xx</span> <span class="keyword">taca</span>, help__digit_string_to_number

define_function <span class="string">"string-&gt;integer"</span>, string_to_integer
   <span class="comment">;; &lt;&lt; string[address, length] -- integer &gt;&gt;
</span>   <span class="type">xx</span> dup2, string_head__char, <span class="keyword">literal</span>, <span class="default">'-'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   digit_string_to_number
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> string_tail__char
   <span class="type">xx</span> digit_string_to_number
   <span class="type">xx</span> negate
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"string,find-char"</span>, string__find_char
  <span class="comment">;; &lt;&lt; string[address, length], char
</span>  <span class="comment">;;    -- address, true
</span>  <span class="comment">;;    -- false &gt;&gt;
</span>  <span class="type">xx</span> over, zero?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
  <span class="type">xx</span>   drop, drop2
  <span class="type">xx</span>   false
  <span class="type">xx</span>   <span class="keyword">end</span>
  <span class="type">xx</span> xoverxx, fetch_byte
  <span class="type">xx</span> over, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
  <span class="type">xx</span>   drop2
  <span class="type">xx</span>   true
  <span class="type">xx</span>   <span class="keyword">end</span>
  <span class="type">xx</span> xxswapx
  <span class="type">xx</span> string_tail__char
  <span class="type">xx</span> xswapxx
  <span class="type">xx</span> <span class="keyword">taca</span>, string__find_char

<span class="comment">;; 2 ^ 64 = 18446744073709551616
;; which is of length 20
;; so
;; I use 32 to align to 16
</span>
buffer$write_number <span class="keyword">labeling</span>
   <span class="type">preserve</span> <span class="constant">32</span>

<span class="function-name">counter$write_number</span>:
   <span class="type">xx</span> <span class="constant">0</span>

define_function <span class="string">"write-number"</span>, write_number
   <span class="comment">;; &lt;&lt; number -- &gt;&gt;
</span>   <span class="type">xx</span> write_number__fill_buffer
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"write-number,fill-buffer"</span>, write_number__fill_buffer
   <span class="comment">;; &lt;&lt; number -- string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> zero
   <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_number, save

   <span class="type">xx</span> write_number__loop

   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$write_number
   <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_number, fetch
   <span class="type">xx</span> string_reverse!
   <span class="type">xx</span> <span class="keyword">end</span>


define_function <span class="string">"write-number,loop"</span>, write_number__loop
   <span class="comment">;; &lt;&lt; rest-number -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, divmod

   <span class="type">xx</span> number_to_digit_char
   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$write_number
   <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_number, fetch
   <span class="type">xx</span> addition
   <span class="type">xx</span> save_byte

   <span class="type">xx</span> one
   <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_number
   <span class="type">xx</span> add_save

   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   drop
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">taca</span>, write_number__loop

define_function <span class="string">"write-integer"</span>, write_integer
   <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, negative?, false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   write_number
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'-'</span>, write_byte
   <span class="type">xx</span> negate
   <span class="type">xx</span> write_number
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"pretty-write-integer"</span>, pretty_write_integer
   <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>   <span class="type">xx</span> write_integer
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">32</span>
   <span class="type">xx</span> write_byte
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"."</span>, ALIAS__pretty_write_integer
   <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>   <span class="type">xx</span> pretty_write_integer
   <span class="type">xx</span> <span class="keyword">end</span>

max_word_length = <span class="constant">512</span>

buffer$read_word <span class="keyword">labeling</span>
   <span class="type">preserve</span> max_word_length

buffer$read_word_for_REPL <span class="keyword">labeling</span>
   <span class="type">preserve</span> max_word_length

define_function <span class="string">"read-word-begin-char"</span>, read_word_begin_char
   <span class="comment">;; &lt;&lt; -- non-blank-char &gt;&gt;
</span>   <span class="type">xx</span> read_byte
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">32</span> <span class="comment">;; ascii.space
</span>   <span class="type">xx</span> greater_than?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> drop
   <span class="type">xx</span> <span class="keyword">taca</span>, read_word_begin_char

define_function <span class="string">"read-word-&gt;buffer"</span>, read_word_to_buffer
   <span class="comment">;; &lt;&lt; buffer -- word[address, length] &gt;&gt;
</span>   <span class="type">xx</span> pop_reading_stack
   <span class="type">xx</span> dup2, space_string?, CICADA__not, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.bad_tos-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   dup2, string_tail__word, push_reading_stack
   <span class="type">xx</span>   string_head__word
   <span class="type">xx</span>   xoverxx, xxoverx
   <span class="type">xx</span>   xswapxx
   <span class="type">xx</span>   string_to_buffer!
   <span class="type">xx</span>   swap, drop
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.bad_tos</span>:
   <span class="type">xx</span> reading_stack_empty?, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.not_empty-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$reading
   <span class="type">xx</span>   <span class="keyword">literal</span>, max_input_length
   <span class="type">xx</span>   read_line_from_stdin
   <span class="type">xx</span>   <span class="keyword">dup</span>, positive?, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.read_error-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>     <span class="keyword">literal</span>, buffer$reading
   <span class="type">xx</span>     swap
   <span class="type">xx</span>     push_reading_stack
   <span class="type">xx</span>     <span class="keyword">taca</span>, read_word_to_buffer
<span class="function-name">.read_error</span>:
   <span class="comment">;;   ignore &lt;end-of-file&gt;
</span>   <span class="comment">;;   ignore reading error
</span>   <span class="type">xx</span>   drop
   <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$reading
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
   <span class="type">xx</span>   push_reading_stack
   <span class="type">xx</span>   <span class="keyword">taca</span>, read_word_to_buffer
<span class="function-name">.not_empty</span>:
   <span class="type">xx</span>   <span class="keyword">literal</span>, error$read_word_to_buffer
   <span class="type">xx</span>   <span class="keyword">literal</span>, length$read_word_to_buffer
   <span class="type">xx</span>   write_string
   <span class="type">xx</span>   <span class="keyword">literal</span>, replace$reading
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">1024</span>
   <span class="type">xx</span>   read_line_from_stdin
   <span class="type">xx</span>   <span class="keyword">literal</span>, replace$reading
   <span class="type">xx</span>   swap
   <span class="type">xx</span>   push_reading_stack
   <span class="type">xx</span>   <span class="keyword">taca</span>, read_word_to_buffer

<span class="function-name">error$read_word_to_buffer</span>:
   <span class="type">db</span> <span class="string">"* (read-word-&gt;buffer) meets empty-string in reading-stack"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  and this empty-stack is not at the bottom of the reading-stack"</span>, <span class="constant">10</span>
   <span class="type">db</span> <span class="string">"  you can type a line to replace this empty string"</span>, <span class="constant">10</span>
<span class="function-name">.end</span>:
length$read_word_to_buffer = <span class="rainbow-delimiters-depth-1">(</span>.end - error$read_word_to_buffer<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"read-word"</span>, read_word
   <span class="comment">;; &lt;&lt; -- word[address of buffer$read_word, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$read_word, read_word_to_buffer
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"read-word-for-REPL"</span>, read_word_for_REPL
   <span class="comment">;; &lt;&lt; -- word[address of buffer$read_word_for_REPL, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$read_word_for_REPL, read_word_to_buffer
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"space-string?"</span>, space_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char, space_char?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   string_tail__char
   <span class="type">xx</span>   <span class="keyword">taca</span>, space_string?
   <span class="type">xx</span> drop2, false
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"string-&gt;word-begin"</span>, string_to_word_begin
   <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="comment">;;   no error handling
</span>   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char
   <span class="type">xx</span> space_char?, false?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> string_tail__char
   <span class="type">xx</span> <span class="keyword">taca</span>, string_to_word_begin

define_function <span class="string">"string-&gt;word-end"</span>, string_to_word_end
   <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="comment">;;   no error handling
</span>   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char
   <span class="type">xx</span> bar_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   string_tail__char
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> help__string_to_word_end
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"help,string-&gt;word-end"</span>, help__string_to_word_end
   <span class="comment">;; &lt;&lt; string[address, length] -- address &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="comment">;;   no error handling
</span>   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char
   <span class="type">xx</span> space_char?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char
   <span class="type">xx</span> bar_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> string_tail__char
   <span class="type">xx</span> <span class="keyword">taca</span>, help__string_to_word_end

define_function <span class="string">"string-head,word"</span>, string_head__word
   <span class="comment">;; &lt;&lt; string[address, length] -- word[address, length] &gt;&gt;
</span>   <span class="type">xx</span> string_to_word_begin
   <span class="type">xx</span> dup2, string_to_word_end
   <span class="type">xx</span> swap, drop
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"string-tail,word"</span>, string_tail__word
   <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> string_to_word_begin
   <span class="type">xx</span> string_to_word_end
   <span class="type">xx</span> <span class="keyword">end</span>

define_variable <span class="string">"*first-jo-in-jotionary*"</span>, V__first_jo_in_jotionary
   <span class="type">xx</span> <span class="rainbow-delimiters-depth-1">(</span>last_link + jo_size<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"find-jo,through-jo-link"</span>, find_jo__through_jo_link
   <span class="comment">;; &lt;&lt; word[address, length]
</span>   <span class="comment">;;    -- jo, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> V__first_jo_in_jotionary
   <span class="type">xx</span> find_jo__through_jo_link__loop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"find-jo,through-jo-link,loop"</span>, find_jo__through_jo_link__loop
   <span class="comment">;; &lt;&lt; word[address, length], jo
</span>   <span class="comment">;;    -- jo, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> xxtuckx

   <span class="type">xx</span> jo_to_name, xxoverxx

   <span class="comment">;; for debug
</span>   <span class="comment">;; xx jo_to_name
</span>   <span class="comment">;; xx   dup2
</span>   <span class="comment">;; xx   dup, write_integer, literal, 32, write_byte
</span>   <span class="comment">;; xx   write_string, literal, 10, write_byte
</span>   <span class="comment">;; xx xxoverxx
</span>   <span class="comment">;; xx   dup2
</span>   <span class="comment">;; xx   dup, write_integer, literal, 32, write_byte
</span>   <span class="comment">;; xx   write_string, literal, 10, write_byte
</span>
   <span class="type">xx</span> string_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> xswapxx
   <span class="type">xx</span> <span class="keyword">dup</span>, last_jo__jotionary?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop, drop2
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> jo_to_pre_jo
   <span class="type">xx</span> <span class="keyword">taca</span>, find_jo__through_jo_link__loop

define_function <span class="string">"execute-word"</span>, execute_word
   <span class="comment">;; &lt;&lt; word[address, length] -- unknown &gt;&gt;
</span>   <span class="type">xx</span> dup2, integer_string?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   string_to_integer
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="comment">;; maybe more
</span>
   <span class="type">xx</span> dup2 <span class="comment">;; for to report undefined word
</span>
   <span class="type">xx</span> find_jo__through_jo_link, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   xxswapx, drop2
   <span class="type">xx</span>   execute_jo
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> write_undefined_word_report__for_execute_word
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>
   <span class="type">xx</span> write_byte
   <span class="type">xx</span> <span class="keyword">end</span>


define_function <span class="string">"write-undefined-word-report,for-execute-word"</span>, write_undefined_word_report__for_execute_word
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_execute_word
   <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_execute_word
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$undefined_word_report__for_execute_word</span>:
   <span class="type">db</span> <span class="string">"* (execute-word) meets undefined word : "</span>
<span class="function-name">.end</span>:
length$undefined_word_report__for_execute_word = <span class="rainbow-delimiters-depth-1">(</span>.end - string$undefined_word_report__for_execute_word<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"basic-REPL"</span>, basic_REPL
   <span class="comment">;; &lt;&lt; unknown -- unknown &gt;&gt;
</span>   <span class="type">xx</span> read_word_for_REPL
   <span class="type">xx</span> execute_word
   <span class="type">xx</span> <span class="keyword">taca</span>, basic_REPL

define_function <span class="string">"current-defining-word"</span>, current_defining_word
   <span class="comment">;; &lt;&lt; -- word[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
   <span class="type">xx</span> <span class="keyword">literal</span>, length$colon, fetch
   <span class="type">xx</span> string_head__word
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"current-defining-body"</span>, current_defining_body
   <span class="comment">;; &lt;&lt; -- word[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
   <span class="type">xx</span> <span class="keyword">literal</span>, length$colon, fetch
   <span class="type">xx</span> string_tail__word
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"colon-string?"</span>, colon_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">':'</span>
   <span class="type">xx</span> char_string?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"semicolon-string?"</span>, semicolon_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">';'</span>
   <span class="type">xx</span> char_string?
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$comment_begin</span>:
   <span class="type">db</span> <span class="string">"&lt;&lt;"</span>

define_function <span class="string">"comment-begin-string?"</span>, comment_begin_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$comment_begin
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>


<span class="function-name">string$comment_end</span>:
   <span class="type">db</span> <span class="string">"&gt;&gt;"</span>

define_function <span class="string">"comment-end-string?"</span>, comment_end_string?
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$comment_end
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

buffer$colon <span class="keyword">labeling</span>
   <span class="type">preserve</span> <span class="constant">1024</span> * <span class="constant">1024</span>

<span class="function-name">cursor$colon</span>:
   <span class="type">xx</span> <span class="constant">0</span>

<span class="function-name">length$colon</span>:
   <span class="type">xx</span> <span class="constant">0</span>


define_function <span class="string">":"</span>, colon
   <span class="comment">;; &lt;&lt; -- string[address of buffer$colon, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, save
   <span class="type">xx</span> help__loop__colon
   <span class="comment">;; address
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
   <span class="comment">;; length
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, length$colon, save
   <span class="type">xx</span> <span class="keyword">end</span>


define_function <span class="string">""</span>, help__loop__colon
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> read_byte
   <span class="type">xx</span> help__save_byte__colon
   <span class="type">xx</span> help__meet_end__colon?, <span class="keyword">false?branch</span>, <span class="constant">7</span>
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">3</span> <span class="comment">;; for the string " ; "
</span>   <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$colon
   <span class="type">xx</span>   sub_save
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> help__meet_comment__colon?, <span class="keyword">false?branch</span>, <span class="constant">9</span>
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">4</span> <span class="comment">;; for the string " &lt;&lt; "
</span>   <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$colon
   <span class="type">xx</span>   sub_save
   <span class="type">xx</span>   ignore_comment
   <span class="type">xx</span>   <span class="keyword">taca</span>, help__loop__colon
   <span class="type">xx</span> <span class="keyword">taca</span>, help__loop__colon


define_function <span class="string">""</span>, help__save_byte__colon
   <span class="comment">;; &lt;&lt; byte -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> save_byte
   <span class="type">xx</span> one
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon
   <span class="type">xx</span> add_save
   <span class="type">xx</span> <span class="keyword">end</span>


define_function <span class="string">""</span>, help__meet_end__colon?
   <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">3</span>, subtraction
   <span class="type">xx</span> fetch_byte, space_char?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, subtraction
   <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">';'</span>, equal?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, subtraction
   <span class="type">xx</span> fetch_byte, space_char?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> true
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">""</span>, help__meet_comment__colon?
   <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">4</span>, subtraction
   <span class="type">xx</span> fetch_byte, space_char?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">3</span>, subtraction
   <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">'&lt;'</span>, equal?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, subtraction
   <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">'&lt;'</span>, equal?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, subtraction
   <span class="type">xx</span> fetch_byte, space_char?
   <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> true
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"&lt;&lt;"</span>, ignore_comment
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> read_word_for_REPL
   <span class="type">xx</span> dup2, comment_begin_string?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>     ignore_comment <span class="comment">;; for the new nested-comment
</span>   <span class="type">xx</span>   <span class="keyword">taca</span>, ignore_comment <span class="comment">;; for the rest-comment
</span>   <span class="type">xx</span> dup2, comment_end_string?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> drop2
   <span class="type">xx</span> <span class="keyword">taca</span>, ignore_comment

size$jo_area = <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size

define_variable <span class="string">"*jo-area*"</span>, V__jo_area
  <span class="type">xx</span> address$jo_area

define_variable <span class="string">"*size,jo-area*"</span>, V__size__jo_area
  <span class="type">xx</span> size$jo_area


address$jo_area <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$jo_area

define_variable <span class="string">"*current-free-address,jo-area*"</span>, V__current_free_address__jo_area
   <span class="type">xx</span> address$jo_area

define_function <span class="string">"save-into,name-string-area"</span>, save_into__name_string_area
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, V__current_free_address__name_string_area
   <span class="type">xx</span> save_two_bytes

   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
   <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__name_string_area
   <span class="type">xx</span> add_save

   <span class="type">xx</span> tuck
   <span class="type">xx</span> V__current_free_address__name_string_area
   <span class="type">xx</span> string_to_buffer!

   <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__name_string_area
   <span class="type">xx</span> add_save
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"save-into,jo-area"</span>, save_into__jo_area
   <span class="comment">;; &lt;&lt; number -- &gt;&gt;
</span>   <span class="type">xx</span> V__current_free_address__jo_area
   <span class="type">xx</span> save

   <span class="type">xx</span> <span class="keyword">literal</span>, jo_size
   <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__jo_area
   <span class="type">xx</span> add_save
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="type">preserve</span> jo_size * <span class="constant">64</span>
address$syntax_stack <span class="keyword">labeling</span>
   <span class="type">preserve</span> jo_size * <span class="constant">1024</span>

define_variable <span class="string">"*pointer-syntax-stack*"</span>, V__pointer_syntax_stack
   <span class="type">xx</span> address$syntax_stack

define_function <span class="string">"push-syntax-stack"</span>, push_syntax_stack
   <span class="comment">;; &lt;&lt; syntax-set[address] -- &gt;&gt;
</span>   <span class="type">xx</span> V__pointer_syntax_stack
   <span class="type">xx</span> save
   <span class="type">xx</span> V__jo_size
   <span class="type">xx</span> <span class="keyword">address</span>, V__pointer_syntax_stack
   <span class="type">xx</span> add_save
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"pop-syntax-stack"</span>, pop_syntax_stack
   <span class="comment">;; &lt;&lt; -- syntax-set[address] &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size
   <span class="type">xx</span> <span class="keyword">address</span>, V__pointer_syntax_stack
   <span class="type">xx</span> sub_save
   <span class="type">xx</span> V__pointer_syntax_stack, fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"tos-syntax-stack"</span>, tos_syntax_stack
   <span class="comment">;; &lt;&lt; -- syntax-set[address] &gt;&gt;
</span>   <span class="type">xx</span> V__pointer_syntax_stack
   <span class="type">xx</span> V__jo_size
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"drop-syntax-stack"</span>, drop_syntax_stack
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size
   <span class="type">xx</span> <span class="keyword">address</span>, V__pointer_syntax_stack
   <span class="type">xx</span> sub_save
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax-stack-empty?"</span>, syntax_stack_empty?
   <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>   <span class="type">xx</span> V__pointer_syntax_stack
   <span class="type">xx</span> <span class="keyword">literal</span>, address$syntax_stack
   <span class="type">xx</span> equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"find-syntax"</span>, find_syntax
   <span class="comment">;; &lt;&lt; word[address, length]
</span>   <span class="comment">;;    -- function, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> syntax_stack_empty?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> tos_syntax_stack
   <span class="type">xx</span> find_rule
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"rule-set,fetch-border"</span>, rule_set__fetch_border
   <span class="comment">;; &lt;&lt; rule-set -- border &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"rule-set,save-border"</span>, rule_set__save_border
   <span class="comment">;; &lt;&lt; border, rule-set -- &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> save
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"cursor-&gt;rule"</span>, cursor_to_rule
   <span class="comment">;; &lt;&lt; cursor -- rule[predicate, function] &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
   <span class="type">xx</span> n_fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"cursor-&gt;predicate"</span>, cursor_to_predicate
   <span class="comment">;; &lt;&lt; cursor -- predicate &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"cursor-&gt;function"</span>, cursor_to_function
   <span class="comment">;; &lt;&lt; cursor -- function &gt;&gt;
</span>   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> fetch
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"add-rule"</span>, add_rule
   <span class="comment">;; &lt;&lt; rule[predicate, function], rule-set -- &gt;&gt;
</span>   <span class="type">xx</span> xxtuckx
   <span class="type">xx</span> rule_set__fetch_border
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
   <span class="type">xx</span> n_save
   <span class="type">xx</span> <span class="keyword">dup</span>
   <span class="type">xx</span> rule_set__fetch_border
   <span class="type">xx</span> V__jo_size, addition
   <span class="type">xx</span> V__jo_size, addition
   <span class="type">xx</span> swap
   <span class="type">xx</span> rule_set__save_border
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">cursor$find_rule</span>:
   <span class="type">xx</span> <span class="constant">0</span>

define_function <span class="string">"find-rule"</span>, find_rule
   <span class="comment">;; &lt;&lt; word[address, length], rule-set
</span>   <span class="comment">;;    -- function, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, rule_set__fetch_border
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_rule, save
   <span class="type">xx</span> find_rule__loop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"find-rule,loop"</span>, find_rule__loop
   <span class="comment">;; &lt;&lt; word[address, length], rule-set
</span>   <span class="comment">;;    -- function, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_rule, fetch
   <span class="type">xx</span> over, equal?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop, drop2
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> xxoverx
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_rule, fetch
   <span class="type">xx</span> cursor_to_predicate
   <span class="type">xx</span> execute_jo, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.not_found-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   drop, drop2
   <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$find_rule, fetch
   <span class="type">xx</span>   cursor_to_function
   <span class="type">xx</span>   true
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.not_found</span>:
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_rule, fetch
   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> V__jo_size, subtraction
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_rule, save
   <span class="type">xx</span> <span class="keyword">taca</span>, find_rule__loop

size$rule_set__make_jojo = <span class="constant">1024</span> * jo_size

<span class="function-name">cursor$rule_set__make_jojo</span>:
   <span class="type">xx</span> address$rule_set__make_jojo
<span class="function-name">address$rule_set__make_jojo</span>:
   <span class="keyword">times</span> size$rule_set__make_jojo <span class="type">db</span> <span class="constant">0</span>

define_variable <span class="string">"*rule-set,make-jojo*"</span>, V__rule_set__make_jojo
   <span class="type">xx</span> address$rule_set__make_jojo

define_function <span class="string">"init,rule-set,make-jojo"</span>, init__rule_set__make_jojo
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, integer_string?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__integer_string__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, word_is_address?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__address__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, word_is_jo?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__jo__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, word_is_branch?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__branch__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, word_is_false?branch?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__false?branch__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, word_is_double_quote?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__double_quote__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, local_variable_save_string?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__local_variable_save__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">literal</span>, local_variable_fetch_string?
   <span class="type">xx</span> <span class="keyword">literal</span>, syntax__local_variable_fetch__make_jojo
   <span class="type">xx</span> V__rule_set__make_jojo, add_rule

   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,integer-string,make-jojo"</span>, syntax__integer_string__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span> string_to_integer
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$word_is_address?</span>:
   <span class="type">db</span> <span class="string">"address"</span>
<span class="function-name">.end</span>:
length$word_is_address? = <span class="rainbow-delimiters-depth-1">(</span>.end - string$word_is_address?<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"word:address?"</span>, word_is_address?
   <span class="comment">;; &lt;&lt; word[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$word_is_address?
   <span class="type">xx</span> <span class="keyword">literal</span>, length$word_is_address?
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,address,make-jojo"</span>, syntax__address__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word:address --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> drop2

   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">address</span>
   <span class="type">xx</span> save_into__jo_area

   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_head__word
   <span class="type">xx</span> find_jo__through_jo_link, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span>   string_tail__word
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> write_undefined_word_report__for_address
   <span class="type">xx</span> dup2, string_head__word, write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo


define_function <span class="string">"write-undefined-word-report,for-address"</span>, write_undefined_word_report__for_address
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_address
   <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_address
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$undefined_word_report__for_address</span>:
   <span class="type">db</span> <span class="string">"* (make-jojo (address)) the word follows (address) is undefined : "</span>
<span class="function-name">.end</span>:
length$undefined_word_report__for_address = <span class="rainbow-delimiters-depth-1">(</span>.end - string$undefined_word_report__for_address<span class="rainbow-delimiters-depth-1">)</span>

<span class="function-name">string$word_is_jo?</span>:
   <span class="type">db</span> <span class="string">"jo"</span>
<span class="function-name">.end</span>:
length$word_is_jo? = <span class="rainbow-delimiters-depth-1">(</span>.end - string$word_is_jo?<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"word:jo?"</span>, word_is_jo?
   <span class="comment">;; &lt;&lt; word[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$word_is_jo?
   <span class="type">xx</span> <span class="keyword">literal</span>, length$word_is_jo?
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,jo,make-jojo"</span>, syntax__jo__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word:jo --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> drop2

   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span> save_into__jo_area

   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_head__word
   <span class="type">xx</span> find_jo__through_jo_link, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span>   string_tail__word
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> write_undefined_word_report__for_jo
   <span class="type">xx</span> dup2, string_head__word, write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo


define_function <span class="string">"write-undefined-word-report,for-jo"</span>, write_undefined_word_report__for_jo
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_jo
   <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_jo
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$undefined_word_report__for_jo</span>:
   <span class="type">db</span> <span class="string">"* (syntax,jo,make-jojo) the word follows (jo) is undefined : "</span>
<span class="function-name">.end</span>:
length$undefined_word_report__for_jo = <span class="rainbow-delimiters-depth-1">(</span>.end - string$undefined_word_report__for_jo<span class="rainbow-delimiters-depth-1">)</span>

<span class="function-name">string$word_is_branch?</span>:
   <span class="type">db</span> <span class="string">"branch"</span>
<span class="function-name">.end</span>:
length$word_is_branch? = <span class="rainbow-delimiters-depth-1">(</span>.end - string$word_is_branch?<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"word:branch?"</span>, word_is_branch?
   <span class="comment">;; &lt;&lt; word[branch, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$word_is_branch?
   <span class="type">xx</span> <span class="keyword">literal</span>, length$word_is_branch?
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,branch,make-jojo"</span>, syntax__branch__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word:jo --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> drop2

   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">branch</span>
   <span class="type">xx</span> save_into__jo_area

   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_head__word
   <span class="type">xx</span> dup2, integer_string?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   string_to_integer
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span>   string_tail__word
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> write_not_integer_string_report__for_branch
   <span class="type">xx</span> dup2, string_head__word, write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo


define_function <span class="string">"write-not-integer-string-report,for-branch"</span>, write_not_integer_string_report__for_branch
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$not_integer_string_report__for_branch
   <span class="type">xx</span> <span class="keyword">literal</span>, length$not_integer_string_report__for_branch
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$not_integer_string_report__for_branch</span>:
   <span class="type">db</span> <span class="string">"* (syntax,branch,make-jojo) the word follows (branch) must be a integer string : "</span>
<span class="function-name">.end</span>:
length$not_integer_string_report__for_branch = <span class="rainbow-delimiters-depth-1">(</span>.end - string$not_integer_string_report__for_branch<span class="rainbow-delimiters-depth-1">)</span>

<span class="function-name">string$word_is_false?branch?</span>:
   <span class="type">db</span> <span class="string">"false?branch"</span>
<span class="function-name">.end</span>:
length$word_is_false?branch? = <span class="rainbow-delimiters-depth-1">(</span>.end - string$word_is_false?branch?<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"word:false?branch?"</span>, word_is_false?branch?
   <span class="comment">;; &lt;&lt; word[false?branch, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$word_is_false?branch?
   <span class="type">xx</span> <span class="keyword">literal</span>, length$word_is_false?branch?
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,false?branch,make-jojo"</span>, syntax__false?branch__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word:jo --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> drop2

   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">false?branch</span>
   <span class="type">xx</span> save_into__jo_area

   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_head__word
   <span class="type">xx</span> dup2, integer_string?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   string_to_integer
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span>   string_tail__word
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> write_not_integer_string_report__for_false?branch
   <span class="type">xx</span> dup2, string_head__word, write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo


define_function <span class="string">"write-not-integer-string-report,for-false?branch"</span>, write_not_integer_string_report__for_false?branch
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$not_integer_string_report__for_false?branch
   <span class="type">xx</span> <span class="keyword">literal</span>, length$not_integer_string_report__for_false?branch
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$not_integer_string_report__for_false?branch</span>:
   <span class="type">db</span> <span class="string">"* (syntax,false?branch,make-jojo) the word follows (false?branch) must be a integer string : "</span>
<span class="function-name">.end</span>:
length$not_integer_string_report__for_false?branch = <span class="rainbow-delimiters-depth-1">(</span>.end - string$not_integer_string_report__for_false?branch<span class="rainbow-delimiters-depth-1">)</span>

<span class="function-name">string$word_is_double_quote?</span>:
   <span class="type">db</span> <span class="default">'"'</span>
<span class="function-name">.end</span>:
length$word_is_double_quote? = <span class="rainbow-delimiters-depth-1">(</span>.end - string$word_is_double_quote?<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"word:double-quote?"</span>, word_is_double_quote?
   <span class="comment">;; &lt;&lt; word[double-quote, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$word_is_double_quote?
   <span class="type">xx</span> <span class="keyword">literal</span>, length$word_is_double_quote?
   <span class="type">xx</span> string_equal?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,double-quote,make-jojo"</span>, syntax__double_quote__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word:double-quote --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> drop2

   <span class="type">xx</span> dup2
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'"'</span>, string__find_char
   <span class="type">xx</span> <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.not_found-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="type">xx</span>   xoverxx, subtraction
   <span class="comment">;;   &lt;&lt; string[address, length], length &gt;&gt;
</span>
   <span class="comment">;; address
</span>   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>     save_into__jo_area
   <span class="type">xx</span>   V__current_free_address__name_string_area, add2
   <span class="type">xx</span>     save_into__jo_area
   <span class="type">xx</span>   xoverxx, over
   <span class="type">xx</span>     save_into__name_string_area

   <span class="comment">;; length
</span>   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>     save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">dup</span>
   <span class="type">xx</span>     save_into__jo_area

   <span class="type">xx</span>   tuck, subtraction
   <span class="type">xx</span>   xxswapx
   <span class="type">xx</span>   addition
   <span class="type">xx</span>   swap

   <span class="type">xx</span>   string_tail__char <span class="comment">;; over the ending double-quote
</span>   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="function-name">.not_found</span>:
   <span class="type">xx</span> write_not_integer_string_report__for_double_quote
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo


define_function <span class="string">"write-not-integer-string-report,for-double-quote"</span>, write_not_integer_string_report__for_double_quote
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$not_integer_string_report__for_double_quote
   <span class="type">xx</span> <span class="keyword">literal</span>, length$not_integer_string_report__for_double_quote
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$not_integer_string_report__for_double_quote</span>:
   <span class="type">db</span> <span class="string">"* (syntax,double-quote,make-jojo) can not find the ending double-quote"</span>
<span class="function-name">.end</span>:
length$not_integer_string_report__for_double_quote = <span class="rainbow-delimiters-depth-1">(</span>.end - string$not_integer_string_report__for_double_quote<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"make-jojo,dispatch-syntax-word"</span>, make_jojo__dispatch_syntax_word
   <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> dup2
   <span class="type">xx</span> find_syntax, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   execute_jo
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2
   <span class="type">xx</span> find_jo__through_jo_link, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   xxswapx, drop2 <span class="comment">;; drop word
</span>   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> write_undefined_word_report__for_make_jojo
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo

define_function <span class="string">"write-undefined-word-report,for-make-jojo"</span>, write_undefined_word_report__for_make_jojo
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_make_jojo
   <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_make_jojo
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$undefined_word_report__for_make_jojo</span>:
   <span class="type">db</span> <span class="string">"* (make-jojo) meets undefined word : "</span>
<span class="function-name">.end</span>:
length$undefined_word_report__for_make_jojo = <span class="rainbow-delimiters-depth-1">(</span>.end - string$undefined_word_report__for_make_jojo<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"make-jojo"</span>, make_jojo
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> local_variable_table__clear
   <span class="type">xx</span> V__rule_set__make_jojo, push_syntax_stack
   <span class="type">xx</span> make_jojo__loop
   <span class="type">xx</span> drop_syntax_stack
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"make-jojo,loop"</span>, make_jojo__loop
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> dup2, space_string?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_tail__word
   <span class="type">xx</span> xxswapxx
   <span class="type">xx</span> string_head__word
   <span class="comment">;; &lt;&lt; tail[address, length], head[address, length] &gt;&gt;
</span>   <span class="type">xx</span> make_jojo__dispatch_syntax_word
   <span class="type">xx</span> <span class="keyword">taca</span>, make_jojo__loop

define_exception <span class="string">"!undo-make-jojo"</span>, !undo_make_jojo
   <span class="comment">;; &lt;&lt; old V__current_free_address__name_string_area
</span>   <span class="comment">;;    old V__current_free_address__jo_area
</span>   <span class="comment">;;    old V__first_jo_in_jotionary
</span>   <span class="comment">;;    string[address, length]
</span>   <span class="comment">;;    -- &gt;&gt;
</span>   <span class="type">xx</span> exception_reset_stack, !undo_make_jojo

   <span class="type">xx</span> drop_syntax_stack

   <span class="type">xx</span> <span class="keyword">literal</span>, string$undo_make_jojo_report
   <span class="type">xx</span> <span class="keyword">literal</span>, length$undo_make_jojo_report
   <span class="type">xx</span> write_string

   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">';'</span>, write_byte
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte

   <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_jotionary, save
   <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__jo_area, save
   <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__name_string_area
   <span class="type">xx</span> save
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$undo_make_jojo_report</span>:
   <span class="type">db</span> <span class="string">"  the following jojo is not made :"</span>
   <span class="type">db</span> <span class="constant">10</span>
   <span class="type">db</span> <span class="string">": "</span>
<span class="function-name">.end</span>:
length$undo_make_jojo_report = <span class="rainbow-delimiters-depth-1">(</span>.end - string$undo_make_jojo_report<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"define-function"</span>, CICADA__define_function
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> V__current_free_address__name_string_area, xxswapx
   <span class="type">xx</span> V__current_free_address__jo_area, xxswapx
   <span class="type">xx</span> V__first_jo_in_jotionary, xxswapx
   <span class="comment">;; &lt;&lt; old V__current_free_address__name_string_area
</span>   <span class="comment">;;    old V__current_free_address__jo_area
</span>   <span class="comment">;;    old V__first_jo_in_jotionary
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>
   <span class="type">xx</span> prepare_for
   <span class="type">xx</span>   exception_head
   <span class="type">xx</span>   !undo_make_jojo
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> V__current_free_address__name_string_area
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span> dup2, string_head__word
   <span class="type">xx</span>   save_into__name_string_area

   <span class="type">xx</span> V__first_jo_in_jotionary
   <span class="type">xx</span> jo_to_link
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> V__current_free_address__jo_area
   <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_jotionary
   <span class="type">xx</span> save

   <span class="type">xx</span> <span class="keyword">literal</span>, explain$function
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_tail__word
   <span class="type">xx</span> make_jojo

   <span class="type">xx</span> drop2
   <span class="type">xx</span> drop
   <span class="type">xx</span> drop
   <span class="type">xx</span> drop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"define-exception"</span>, CICADA__define_exception
   <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> V__current_free_address__name_string_area, xxswapx
   <span class="type">xx</span> V__current_free_address__jo_area, xxswapx
   <span class="type">xx</span> V__first_jo_in_jotionary, xxswapx
   <span class="comment">;; &lt;&lt; old V__current_free_address__name_string_area
</span>   <span class="comment">;;    old V__current_free_address__jo_area
</span>   <span class="comment">;;    old V__first_jo_in_jotionary
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>
   <span class="type">xx</span> prepare_for
   <span class="type">xx</span>   exception_head
   <span class="type">xx</span>   !undo_make_jojo
   <span class="type">xx</span>   <span class="keyword">end</span>

   <span class="type">xx</span> V__current_free_address__name_string_area
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span> dup2, string_head__word
   <span class="type">xx</span>   save_into__name_string_area

   <span class="type">xx</span> V__first_jo_in_jotionary
   <span class="type">xx</span> jo_to_link
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> V__current_free_address__jo_area
   <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_jotionary
   <span class="type">xx</span> save

   <span class="type">xx</span> <span class="keyword">literal</span>, explain$exception
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> dup2
   <span class="type">xx</span> string_tail__word
   <span class="type">xx</span> make_jojo

   <span class="type">xx</span> drop2
   <span class="type">xx</span> drop
   <span class="type">xx</span> drop
   <span class="type">xx</span> drop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"define-variable,with-tos"</span>, CICADA__define_variable__with_tos
   <span class="comment">;; &lt;&lt; variable, string[address, length] -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> V__current_free_address__name_string_area
   <span class="type">xx</span>   save_into__jo_area
   <span class="type">xx</span> dup2, string_head__word
   <span class="type">xx</span>   save_into__name_string_area

   <span class="type">xx</span> V__first_jo_in_jotionary
   <span class="type">xx</span> jo_to_link
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> V__current_free_address__jo_area
   <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_jotionary
   <span class="type">xx</span> save

   <span class="type">xx</span> <span class="keyword">literal</span>, explain$variable
   <span class="type">xx</span>   save_into__jo_area

   <span class="type">xx</span> drop2
   <span class="type">xx</span> save_into__jo_area
   <span class="type">xx</span> <span class="keyword">end</span>

size$local_jo = <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size

address$local_jo <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$local_jo

<span class="function-name">current_free_address$local_jo</span>:
   <span class="type">xx</span> address$local_jo

define_primitive_function <span class="string">"local-data-allocate,jo"</span>, local_data_allocate__jo
   <span class="comment">;; &lt;&lt; number -- &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">imul</span> <span class="variable-name">rax</span>, jo_size
   <span class="builtin">add</span> <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_jo<span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">rax</span>
   next

<span class="preprocessor">match</span> =64bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"n-fetch,local-jo"</span>, n_fetch__local_jo
   <span class="comment">;; &lt;&lt; offset, n -- value-1, ..., value-n &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$return_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>

   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

define_primitive_function <span class="string">"n-save,local-jo"</span>, n_save__local_jo
   <span class="comment">;; &lt;&lt; value-n, ..., value-1, offset, n -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$return_stack - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>

   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
     <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
     <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
     <span class="comment">;; for address is based on 0
</span>     <span class="comment">;; but n is based on 1
</span>     <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
<span class="function-name">.loop</span>:
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =32bit, machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"n-fetch,local-jo"</span>, n_fetch__local_jo
   <span class="comment">;; &lt;&lt; offset, n -- value-1, ..., value-n &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>

   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
<span class="function-name">.loop</span>:
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

define_primitive_function <span class="string">"n-save,local-jo"</span>, n_save__local_jo
   <span class="comment">;; &lt;&lt; value-n, ..., value-1, offset, n -- &gt;&gt;
</span>   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-2">[</span>pointer$return_stack<span class="rainbow-delimiters-depth-2">]</span>
   <span class="builtin">mov</span> <span class="variable-name">rbx</span>, <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rax</span> - <span class="rainbow-delimiters-depth-3">(</span><span class="constant">2</span> * jo_size<span class="rainbow-delimiters-depth-3">)</span><span class="rainbow-delimiters-depth-2">]</span>

   pop_argument_stack <span class="variable-name">rcx</span>
   pop_argument_stack <span class="variable-name">rdx</span>
   <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
     <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
     <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
     <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
     <span class="comment">;; for address is based on 0
</span>     <span class="comment">;; but n is based on 1
</span>     <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
<span class="function-name">.loop</span>:
   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">mov</span> <span class="rainbow-delimiters-depth-2">[</span><span class="variable-name">rbx</span><span class="rainbow-delimiters-depth-2">]</span>, <span class="variable-name">rax</span>
   <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="builtin">loop</span> .loop
   next

<span class="rainbow-delimiters-depth-1">}</span>

size$local_variable_table = <span class="constant">100</span> * <span class="constant">1024</span>

address$local_variable_table <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$local_variable_table

<span class="function-name">border$local_variable_table</span>:
   <span class="type">xx</span> address$local_variable_table

<span class="function-name">offset$local_variable_table</span>:
   <span class="type">xx</span> <span class="constant">0</span>

define_function <span class="string">"local-variable-table,clear"</span>, local_variable_table__clear
   <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, address$local_variable_table
   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, save
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, offset$local_variable_table, save
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"local-variable-table,insert"</span>, local_variable_table__insert
   <span class="comment">;; &lt;&lt; string[address, length] -- offset &gt;&gt;
</span>
   <span class="comment">;; leave offset
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, offset$local_variable_table, fetch
   <span class="type">xx</span>   xxtuckx <span class="comment">;; return value
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch, save
   <span class="type">xx</span> V__jo_size
   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, add_save

   <span class="comment">;; update offset$local_variable_table
</span>   <span class="type">xx</span> dup2
   <span class="type">xx</span>   count_front_colon
   <span class="type">xx</span>   V__jo_size, multiple
   <span class="type">xx</span>   <span class="keyword">literal</span>, offset$local_variable_table, add_save

   <span class="comment">;; leave length
</span>   <span class="type">xx</span> <span class="keyword">dup</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch, save
   <span class="type">xx</span> V__jo_size
   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, add_save

   <span class="type">xx</span> tuck <span class="comment">;; for to update border$local_variable_table
</span>
   <span class="comment">;; leave string
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch
   <span class="type">xx</span> string_to_buffer!

   <span class="comment">;; update border$local_variable_table
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, add_save

   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">cursor$local_variable_table</span>:
   <span class="type">xx</span> address$local_variable_table

define_function <span class="string">"local-variable-table,find"</span>, local_variable_table__find
   <span class="comment">;; &lt;&lt; string[address, length]
</span>   <span class="comment">;;    -- offset, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, address$local_variable_table
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, save
   <span class="type">xx</span> local_variable_table__find__loop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"local-variable-table,find,loop"</span>, local_variable_table__find__loop
   <span class="comment">;; &lt;&lt; string[address, length]
</span>   <span class="comment">;;    -- offset, true
</span>   <span class="comment">;;    -- false &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
   <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch
   <span class="type">xx</span> greater_or_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
   <span class="type">xx</span>   V__jo_size, addition
   <span class="type">xx</span>   V__jo_size, addition <span class="comment">;; address of string
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
   <span class="type">xx</span>   V__jo_size, addition
   <span class="type">xx</span>   fetch <span class="comment">;; length of string
</span>   <span class="type">xx</span> string_equal?, <span class="keyword">false?branch</span>, <span class="constant">8</span>
   <span class="type">xx</span>   drop2
   <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$local_variable_table, fetch
   <span class="type">xx</span>     fetch <span class="comment">;; offset
</span>   <span class="type">xx</span>   true
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
   <span class="type">xx</span>   V__jo_size, addition
   <span class="type">xx</span>   fetch <span class="comment">;; length of string
</span>   <span class="type">xx</span> V__jo_size, addition
   <span class="type">xx</span> V__jo_size, addition
   <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, add_save
   <span class="type">xx</span> <span class="keyword">taca</span>, local_variable_table__find__loop

define_function <span class="string">"count-front-colon"</span>, count_front_colon
   <span class="comment">;; &lt;&lt; string[address, length] -- number &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span> <span class="comment">;; counter
</span>   <span class="type">xx</span> count_front_colon__loop
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"count-front-colon,loop"</span>, count_front_colon__loop
   <span class="comment">;; &lt;&lt; string[address, length], counter -- number &gt;&gt;
</span>   <span class="type">xx</span> over, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   xxswapx, drop2
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> xxoverx, string_head__char
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">':'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   xxswapx, drop2
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> add1, xxswapx
   <span class="type">xx</span> string_tail__char, xswapxx
   <span class="type">xx</span> <span class="keyword">taca</span>, count_front_colon__loop

define_function <span class="string">"local-variable-fetch-string?"</span>, local_variable_fetch_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, addition, sub1
   <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">':'</span>
   <span class="type">xx</span> equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, count_front_colon
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?, false?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop, drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> swap, drop
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,local-variable-fetch,make-jojo"</span>, syntax__local_variable_fetch__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> dup2
   <span class="type">xx</span> local_variable_table__find, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.not_found-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="comment">;;   literal, &lt;offese&gt;, literal, n, n_fetch__local_jo
</span>   <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>       save_into__jo_area
   <span class="comment">;;     offset
</span>   <span class="type">xx</span>       save_into__jo_area
   <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>       save_into__jo_area
   <span class="comment">;;     n
</span>   <span class="type">xx</span>     count_front_colon
   <span class="type">xx</span>       save_into__jo_area
   <span class="type">xx</span>     <span class="keyword">literal</span>, n_fetch__local_jo
   <span class="type">xx</span>       save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.not_found</span>:
   <span class="type">xx</span> write_local_variable_not_bound_report
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
   <span class="type">xx</span> !undo_make_jojo

define_function <span class="string">"write-local-variable-not-bound-report"</span>, write_local_variable_not_bound_report
   <span class="type">xx</span> <span class="keyword">literal</span>, string$local_variable_not_bound_report
   <span class="type">xx</span> <span class="keyword">literal</span>, length$local_variable_not_bound_report
   <span class="type">xx</span> write_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$local_variable_not_bound_report</span>:
   <span class="type">db</span> <span class="string">"* local-variable not bound : "</span>
<span class="function-name">.end</span>:
length$local_variable_not_bound_report = <span class="rainbow-delimiters-depth-1">(</span>.end - string$local_variable_not_bound_report<span class="rainbow-delimiters-depth-1">)</span>

define_function <span class="string">"local-variable-save-string?"</span>, local_variable_save_string?
   <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, addition, sub1
   <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">':'</span>
   <span class="type">xx</span> equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> dup2, string_head__char
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'&gt;'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
   <span class="type">xx</span>   drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> string_tail__char
   <span class="type">xx</span> dup2, count_front_colon
   <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?, false?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
   <span class="type">xx</span>   drop, drop2, false
   <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="type">xx</span> subtraction
   <span class="type">xx</span> swap, drop
   <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?
   <span class="type">xx</span> <span class="keyword">end</span>

define_function <span class="string">"syntax,local-variable-save,make-jojo"</span>, syntax__local_variable_save__make_jojo
   <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>   <span class="comment">;;    string[address, length] &gt;&gt;
</span>   <span class="type">xx</span> string_tail__char
   <span class="type">xx</span> dup2
   <span class="type">xx</span> local_variable_table__find, <span class="keyword">false?branch</span>, <span class="rainbow-delimiters-depth-1">(</span>.not_found-$<span class="rainbow-delimiters-depth-1">)</span>/jo_size
   <span class="comment">;;   literal, &lt;offese&gt;, literal, n, n_save__local_jo
</span>   <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>       save_into__jo_area
   <span class="comment">;;     offset
</span>   <span class="type">xx</span>       save_into__jo_area
   <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>       save_into__jo_area
   <span class="comment">;;     n
</span>   <span class="type">xx</span>     count_front_colon
   <span class="type">xx</span>       save_into__jo_area
   <span class="type">xx</span>     <span class="keyword">literal</span>, n_save__local_jo
   <span class="type">xx</span>       save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">end</span>
<span class="function-name">.not_found</span>:
   <span class="type">xx</span> dup2
   <span class="type">xx</span> local_variable_table__insert
   <span class="type">xx</span> xxswapx
   <span class="type">xx</span> count_front_colon
   <span class="comment">;; literal, &lt;number&gt;, local_data_allocate__jo
</span>   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>     save_into__jo_area
   <span class="comment">;;   number of jo
</span>   <span class="type">xx</span>     <span class="keyword">dup</span>, save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">literal</span>, local_data_allocate__jo
   <span class="type">xx</span>     save_into__jo_area
   <span class="comment">;; literal, &lt;offese&gt;, literal, n, save_local_data
</span>   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>     save_into__jo_area
   <span class="comment">;;   offset
</span>   <span class="type">xx</span>   swap
   <span class="type">xx</span>     save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
   <span class="type">xx</span>     save_into__jo_area
   <span class="comment">;;   n
</span>   <span class="type">xx</span>     save_into__jo_area
   <span class="type">xx</span>   <span class="keyword">literal</span>, n_save__local_jo
   <span class="type">xx</span>     save_into__jo_area
   <span class="type">xx</span> <span class="keyword">end</span>

size$local_byte = <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size

address$local_byte <span class="keyword">labeling</span>
   <span class="type">preserve</span> size$local_byte

<span class="function-name">current_free_address$local_byte</span>:
   <span class="type">xx</span> address$local_byte

define_primitive_function <span class="string">"allocate-local-memory"</span>, allocate_local_memory
   <span class="comment">;; &lt;&lt; size -- address &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rbx</span>
   <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-1">]</span>
   push_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">add</span> <span class="rainbow-delimiters-depth-1">[</span>current_free_address$local_byte<span class="rainbow-delimiters-depth-1">]</span>, <span class="variable-name">rbx</span>
   next

<span class="function-name">string$string_to_syscall_string</span>:
   <span class="keyword">times</span> <span class="constant">256</span> <span class="type">db</span> <span class="constant">0</span>

define_function <span class="string">"string-&gt;syscall-string"</span>, string_to_syscall_string
   <span class="comment">;; &lt;&lt; string[address, length] -- syscall-string[address] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>
   <span class="type">xx</span>   <span class="keyword">literal</span>, string$string_to_syscall_string
   <span class="type">xx</span>   addition
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
   <span class="type">xx</span>   swap, save_byte
   <span class="type">xx</span> <span class="keyword">literal</span>, string$string_to_syscall_string
   <span class="type">xx</span> string_to_buffer!
   <span class="type">xx</span> <span class="keyword">literal</span>, string$string_to_syscall_string
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$string_to_syscall_string_2</span>:
   <span class="keyword">times</span> <span class="constant">256</span> <span class="type">db</span> <span class="constant">0</span>

define_function <span class="string">"string-&gt;syscall-string-2"</span>, string_to_syscall_string_2
   <span class="comment">;; &lt;&lt; string[address, length] -- syscall-string[address] &gt;&gt;
</span>   <span class="type">xx</span> <span class="keyword">dup</span>
   <span class="type">xx</span>   <span class="keyword">literal</span>, string$string_to_syscall_string_2
   <span class="type">xx</span>   addition
   <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
   <span class="type">xx</span>   swap, save_byte
   <span class="type">xx</span> <span class="keyword">literal</span>, string$string_to_syscall_string_2
   <span class="type">xx</span> string_to_buffer!
   <span class="type">xx</span> <span class="keyword">literal</span>, string$string_to_syscall_string_2
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="preprocessor">match</span> =linux =64bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"syscall"</span>, CICADA__syscall
   <span class="comment">;; &lt;&lt; ..., argument2, argument1,
</span>   <span class="comment">;;    syscall-number,
</span>   <span class="comment">;;    number-of-arguments
</span>   <span class="comment">;;    -- return-value &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">0</span>
   <span class="builtin">je</span> __syscall_with_0
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">1</span>
   <span class="builtin">je</span> __syscall_with_1
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">2</span>
   <span class="builtin">je</span> __syscall_with_2
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">3</span>
   <span class="builtin">je</span> __syscall_with_3
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">4</span>
   <span class="builtin">je</span> __syscall_with_4
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">5</span>
   <span class="builtin">je</span> __syscall_with_5
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">6</span>
   <span class="builtin">je</span> __syscall_with_6
   <span class="builtin">jmp</span> __syscall_with_too_many

__syscall_with_0:
   pop_argument_stack linux64_sys_n_rax
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_1:
   pop_argument_stack linux64_sys_n_rax
   pop_argument_stack linux64_sys_1_rdi
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_2:
   pop_argument_stack linux64_sys_n_rax
   pop_argument_stack linux64_sys_1_rdi
   pop_argument_stack linux64_sys_2_rsi
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_3:
   pop_argument_stack linux64_sys_n_rax
   pop_argument_stack linux64_sys_1_rdi
   pop_argument_stack linux64_sys_2_rsi
   pop_argument_stack linux64_sys_3_rdx
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_4:
   pop_argument_stack linux64_sys_n_rax
   pop_argument_stack linux64_sys_1_rdi
   pop_argument_stack linux64_sys_2_rsi
   pop_argument_stack linux64_sys_3_rdx
   pop_argument_stack linux64_sys_4_r10
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_5:
   pop_argument_stack linux64_sys_n_rax
   pop_argument_stack linux64_sys_1_rdi
   pop_argument_stack linux64_sys_2_rsi
   pop_argument_stack linux64_sys_3_rdx
   pop_argument_stack linux64_sys_4_r10
   pop_argument_stack linux64_sys_5_r9
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_6:
   pop_argument_stack linux64_sys_n_rax
   pop_argument_stack linux64_sys_1_rdi
   pop_argument_stack linux64_sys_2_rsi
   pop_argument_stack linux64_sys_3_rdx
   pop_argument_stack linux64_sys_4_r10
   pop_argument_stack linux64_sys_5_r9
   pop_argument_stack linux64_sys_6_r8
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_too_many:
   <span class="builtin">call</span> __exit_with_six

<span class="rainbow-delimiters-depth-1">}</span>

<span class="preprocessor">match</span> =linux =32bit, platform machine <span class="rainbow-delimiters-depth-1">{</span>

define_primitive_function <span class="string">"syscall"</span>, CICADA__syscall
   <span class="comment">;; &lt;&lt; ..., argument2, argument1,
</span>   <span class="comment">;;    syscall-number,
</span>   <span class="comment">;;    number-of-arguments
</span>   <span class="comment">;;    -- return-value &gt;&gt;
</span>   pop_argument_stack <span class="variable-name">rax</span>
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">0</span>
   <span class="builtin">je</span> __syscall_with_0
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">1</span>
   <span class="builtin">je</span> __syscall_with_1
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">2</span>
   <span class="builtin">je</span> __syscall_with_2
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">3</span>
   <span class="builtin">je</span> __syscall_with_3
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">4</span>
   <span class="builtin">je</span> __syscall_with_4
   <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">5</span>
   <span class="builtin">je</span> __syscall_with_5
   <span class="builtin">jmp</span> __syscall_with_too_many

__syscall_with_0:
   pop_argument_stack linux32_sys_n_eax
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_1:
   pop_argument_stack linux32_sys_n_eax
   pop_argument_stack linux32_sys_1_ebx
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_2:
   pop_argument_stack linux32_sys_n_eax
   pop_argument_stack linux32_sys_1_ebx
   pop_argument_stack linux32_sys_2_ecx
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_3:
   pop_argument_stack linux32_sys_n_eax
   pop_argument_stack linux32_sys_1_ebx
   pop_argument_stack linux32_sys_2_ecx
   pop_argument_stack linux32_sys_3_edx
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_4:
   pop_argument_stack linux32_sys_n_eax
   pop_argument_stack linux32_sys_1_ebx
   pop_argument_stack linux32_sys_2_ecx
   pop_argument_stack linux32_sys_3_edx
   pop_argument_stack linux32_sys_4_esi
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_5:
   pop_argument_stack linux32_sys_n_eax
   pop_argument_stack linux32_sys_1_ebx
   pop_argument_stack linux32_sys_2_ecx
   pop_argument_stack linux32_sys_3_edx
   pop_argument_stack linux32_sys_4_esi
   pop_argument_stack linux32_sys_5_edi
   <span class="builtin">syscall</span>
   push_argument_stack <span class="variable-name">rax</span>
   next

__syscall_with_too_many:
   <span class="builtin">call</span> __exit_with_six

<span class="rainbow-delimiters-depth-1">}</span>

define_variable <span class="string">"*explainer,function*"</span>, CICADA__explain$function
   <span class="type">xx</span> explain$function

define_variable <span class="string">"*explainer,exception*"</span>, CICADA__explain$exception
   <span class="type">xx</span> explain$exception

define_variable <span class="string">"*explainer,variable*"</span>, CICADA__explain$variable
   <span class="type">xx</span> explain$variable

define_function <span class="string">"platform"</span>, the_platform
   <span class="type">xx</span> <span class="keyword">literal</span>, string$platform
   <span class="type">xx</span> <span class="keyword">literal</span>, length$platform
   <span class="type">xx</span> <span class="keyword">end</span>

<span class="function-name">string$platform</span>:

<span class="preprocessor">match</span> =linux, platform <span class="rainbow-delimiters-depth-1">{</span>
   <span class="type">db</span> <span class="string">"linux"</span>
<span class="rainbow-delimiters-depth-1">}</span>

<span class="function-name">.end</span>:
length$platform = <span class="rainbow-delimiters-depth-1">(</span>.end - string$platform<span class="rainbow-delimiters-depth-1">)</span>

define_variable <span class="string">"*un-initialized-memory*"</span>, V__un_initialized_memory
  <span class="type">xx</span> address$un_initialized_memory

define_variable <span class="string">"*size,un-initialized-memory*"</span>, V__size__un_initialized_memory
  <span class="type">xx</span> size$un_initialized_memory

define_variable <span class="string">"*current-free-address,un-initialized-memory*"</span>, V__current_free_address__un_initialized_memory
  <span class="type">xx</span> current_free_address$un_initialized_memory

define_variable <span class="string">"*current-free-address,name-string-area*"</span>, V__current_free_address__name_string_area
   <span class="type">xx</span> current_free_address$name_string_area

last_link = link

size$un_initialized_memory = <span class="constant">88</span> * <span class="constant">1024</span> * <span class="constant">1024</span> <span class="comment">;; (byte)
</span>
<span class="preprocessor">match</span> =linux, platform <span class="rainbow-delimiters-depth-1">{</span>

<span class="keyword">segment</span> <span class="keyword">readable</span> <span class="keyword">writeable</span>
<span class="function-name">address$un_initialized_memory</span>:
   <span class="type">rb</span> size$un_initialized_memory

<span class="rainbow-delimiters-depth-1">}</span>
</pre>
  </body>
</html>
