---
---
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>core.org</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
    <!--
      body {
        color: #f8f8f0;
        background-color: #1b1d1e;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .cicada-nymph-comment {
        /* cicada-nymph-comment-face */
        color: #FF8888;
      }
      .cicada-nymph-end {
        /* cicada-nymph-end-face */
        color: #00ffff;
        font-weight: bold;
      }
      .cicada-nymph-lexicographer {
        /* cicada-nymph-lexicographer-face */
        color: #ae81ff;
        font-weight: bold;
      }
      .cicada-nymph-number {
        /* cicada-nymph-number-face */
        color: #fd971f;
        font-weight: bold;
      }
      .cicada-nymph-sentence-reader {
        /* cicada-nymph-sentence-reader-face */
        color: #ffff00;
        font-weight: bold;
      }
      .cicada-nymph-string {
        /* cicada-nymph-string-face */
        color: #e6db74;
      }
      .cicada-nymph-syntax-key-word {
        /* cicada-nymph-syntax-key-word-face */
        color: #f92672;
        font-weight: bold;
      }
      .cicada-nymph-variable {
        /* cicada-nymph-variable-face */
        color: #fd971f;
      }
      .cicada-nymph-word-to-define {
        /* cicada-nymph-word-to-define-face */
        color: #ef5939;
        font-weight: bold;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #FF8888;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #FF8888;
      }
      .org-document-info {
        /* org-document-info */
        color: #afeeee;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-weight: bold;
      }
      .org-done {
        /* org-done */
        color: #98fb98;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #a6e22e;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #fd971f;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
{% include in-org-head.html %}
  </head>
  <body>
    {% include before-pre.html %}
<pre>
<span class="org-document-info-keyword">#+TITLE:</span>  <span class="org-document-title">core of cicada-nymph
</span><span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">&#35613;&#23431;&#24646; / XIE Yuheng
</span><span class="org-document-info-keyword">#+EMAIL:</span>  <span class="org-document-info">xyheme@gmail.com
</span>
<span class="org-level-1">* </span><span class="org-done">todo</span>
<span class="org-level-2">** syntax for exception handling in cicada-nymph</span>
<span class="org-level-2">** re-factoring read_byte to make it easier to implement eval-string</span>
<span class="org-level-2">** eval-string</span>
<span class="org-level-2">** load-file</span>
<span class="org-level-1">* ===================================</span>
<span class="org-level-1">* misc</span>
<span class="org-block-begin-line">  #+begin_src cicada-nymph :tangle core.cn
</span>  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">cr</span> <span class="cicada-nymph-comment">&lt;&lt; cr denotes carriage return &gt;&gt;</span>
    <span class="cicada-nymph-comment">&lt;&lt; -- &gt;&gt;</span>
    <span class="cicada-nymph-number">10</span> write-byte
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">  #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* if &amp; else &amp; then</span>
  * one predicate can make two branchs
    three predicates can make four branchs
    three predicates may only make three branchs
    but indeed there must be an invisible branch
<span class="org-block-begin-line">  #+begin_src cicada-nymph :tangle core.cn
</span>  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-syntax-key-word">if</span>
    <span class="cicada-nymph-comment">&lt;&lt; string[address, length] --
       address, string[address, length] &gt;&gt;</span>
    <span class="cicada-nymph-variable">*false?branch*</span> save-into,jo-heap
    <span class="cicada-nymph-variable">*current-free-address,jo-heap*</span> xx|swap|x
    <span class="cicada-nymph-number">0</span> save-into,jo-heap
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-macro</span>

  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-syntax-key-word">else</span>
    <span class="cicada-nymph-comment">&lt;&lt; address, string[address, length] --
       address, string[address, length] &gt;&gt;</span>
    <span class="cicada-nymph-variable">*branch*</span> save-into,jo-heap
    x|swap|xx
    <span class="cicada-nymph-variable">*current-free-address,jo-heap*</span> xxx|swap|x
    <span class="cicada-nymph-number">0</span> save-into,jo-heap
    <span class="cicada-nymph-comment">&lt;&lt; address, string[address, length], address &gt;&gt;</span>
    <span class="cicada-nymph-variable">*current-free-address,jo-heap*</span>
    over sub <span class="cicada-nymph-variable">*jo-size*</span> div
    swap save
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-macro</span>

  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-syntax-key-word">then</span>
    <span class="cicada-nymph-comment">&lt;&lt; address, string[address, length] --
       string[address, length] &gt;&gt;</span>
    x|swap|xx
    <span class="cicada-nymph-variable">*current-free-address,jo-heap*</span>
    over sub <span class="cicada-nymph-variable">*jo-size*</span> div
    swap save
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-macro</span>
<span class="org-block-end-line">  #+end_src
</span><span class="org-level-1">* </span><span class="org-done">test</span>
<span class="org-block-begin-line">  #+begin_src cicada-nymph
</span>  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">kkk</span>
    <span class="cicada-nymph-string">"kkk took my baby away !"</span> write-string
    cr
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">factorial</span>
    <span class="cicada-nymph-comment">&lt;&lt; number -- number &gt;&gt;</span>
    dup
    one? <span class="cicada-nymph-syntax-key-word">if</span>
      <span class="cicada-nymph-end">end</span>
    <span class="cicada-nymph-syntax-key-word">then</span>
    dup sub1 factorial
    mul
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>


  <span class="cicada-nymph-number">1</span> factorial .
  <span class="cicada-nymph-number">2</span> factorial .
  <span class="cicada-nymph-number">3</span> factorial .
  <span class="cicada-nymph-number">4</span> factorial .
  <span class="cicada-nymph-number">5</span> factorial .
  <span class="cicada-nymph-number">6</span> factorial .
  <span class="cicada-nymph-number">7</span> factorial .
  <span class="cicada-nymph-number">8</span> factorial .
  <span class="cicada-nymph-number">9</span> factorial .
  <span class="cicada-nymph-number">10</span> factorial .
  <span class="cicada-nymph-number">11</span> factorial .
  <span class="cicada-nymph-number">12</span> factorial .
  <span class="cicada-nymph-number">13</span> factorial .
  <span class="cicada-nymph-number">14</span> factorial .
  <span class="cicada-nymph-number">15</span> factorial .
  <span class="cicada-nymph-number">16</span> factorial .
  <span class="cicada-nymph-number">17</span> factorial .
  <span class="cicada-nymph-number">18</span> factorial .
  <span class="cicada-nymph-number">19</span> factorial .
  <span class="cicada-nymph-number">20</span> factorial .


  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">.12</span>
    <span class="cicada-nymph-comment">&lt;&lt; 1 2 -- &gt;&gt;</span>
    <span class="cicada-nymph-number">2</span> equal? <span class="cicada-nymph-syntax-key-word">if</span>
      <span class="cicada-nymph-string">"(^-^)"</span> write-string
      <span class="cicada-nymph-number">1</span> equal? <span class="cicada-nymph-syntax-key-word">if</span>
        <span class="cicada-nymph-string">"\^o^/"</span> write-string
      <span class="cicada-nymph-syntax-key-word">else</span>
        <span class="cicada-nymph-string">"     "</span> write-string
      <span class="cicada-nymph-syntax-key-word">then</span>
    <span class="cicada-nymph-syntax-key-word">else</span>
      <span class="cicada-nymph-string">"     "</span> write-string
      <span class="cicada-nymph-number">1</span> equal? <span class="cicada-nymph-syntax-key-word">if</span>
        <span class="cicada-nymph-string">"\^o^/"</span> write-string
      <span class="cicada-nymph-syntax-key-word">else</span>
        <span class="cicada-nymph-string">"     "</span> write-string
      <span class="cicada-nymph-syntax-key-word">then</span>
    <span class="cicada-nymph-syntax-key-word">then</span>
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

  cr
  <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-number">2</span> .12 cr
  <span class="cicada-nymph-number">6</span> <span class="cicada-nymph-number">2</span> .12 cr
  <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-number">6</span> .12 cr
  <span class="cicada-nymph-number">6</span> <span class="cicada-nymph-number">6</span> .12 cr
<span class="org-block-end-line">  #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* re-define execute-word &amp; basic-REPL</span>
  * to protect macro &amp; exception from be called from basic-REPL
<span class="org-block-begin-line">  #+begin_src cicada-nymph :tangle core.cn
</span>  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">execute-word</span>
    <span class="cicada-nymph-comment">&lt;&lt; word[address, length] -- unknown &gt;&gt;</span>
    dup2 integer-string? <span class="cicada-nymph-syntax-key-word">if</span>
      string-&gt;integer
      <span class="cicada-nymph-end">end</span>
    <span class="cicada-nymph-syntax-key-word">then</span>
    dup2
    find <span class="cicada-nymph-syntax-key-word">if</span>
      dup macro-jo? <span class="cicada-nymph-syntax-key-word">if</span>
        drop
        <span class="cicada-nymph-string">"* (execute-word) CAN NOT EXECUTE MACRO DIRECTLY : "</span> write-string
        write-string cr
        <span class="cicada-nymph-end">end</span>
      <span class="cicada-nymph-syntax-key-word">then</span>
      dup exception-jo? <span class="cicada-nymph-syntax-key-word">if</span>
        drop
        <span class="cicada-nymph-string">"* (execute-word) CAN NOT EXECUTE EXCEPTION DIRECTLY : "</span> write-string
        write-string cr
        <span class="cicada-nymph-end">end</span>
      <span class="cicada-nymph-syntax-key-word">then</span>
      <span class="cicada-nymph-comment">&lt;&lt; function &amp; primitive-function &amp; variable &gt;&gt;</span>
      xx|swap|x drop2
      execute-jo
      <span class="cicada-nymph-end">end</span>
    <span class="cicada-nymph-syntax-key-word">else</span>
    <span class="cicada-nymph-string">"* (execute-word) MEETS UNDEFINED WORD : "</span> write-string
    write-string cr
    <span class="cicada-nymph-syntax-key-word">then</span>
    <span class="cicada-nymph-end">end</span>
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

  <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">basic-REPL</span>
    <span class="cicada-nymph-comment">&lt;&lt; unknown -- unknown &gt;&gt;</span>
    read-word-for-REPL
    execute-word
    <span class="cicada-nymph-end">&lt;&gt;</span> basic-REPL
  <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

  basic-REPL
<span class="org-block-end-line">  #+end_src
</span><span class="org-level-1">* report</span>
<span class="org-level-2">** show-dictionary</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph :tangle core.cn
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">loop,show-dictionary</span>
     <span class="cicada-nymph-comment">&lt;&lt; jo -- &gt;&gt;</span>
     dup last-jo,dictionary? <span class="cicada-nymph-syntax-key-word">if</span>
       jo-&gt;name
       write-string cr
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     dup jo-&gt;name
     dup2 space-string? <span class="cicada-nymph-syntax-key-word">if</span>
       drop2
     <span class="cicada-nymph-syntax-key-word">else</span>
       write-string cr
     <span class="cicada-nymph-syntax-key-word">then</span>
     jo-&gt;pre-jo
     <span class="cicada-nymph-end">&lt;&gt;</span> loop,show-dictionary
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">show-dictionary</span>
     <span class="cicada-nymph-comment">&lt;&lt; -- &gt;&gt;</span>
     <span class="cicada-nymph-variable">*first-jo-in-dictionary*</span>
     loop,show-dictionary
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** report-memory</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph :tangle core.cn
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">report-memory</span>
     <span class="cicada-nymph-comment">&lt;&lt; -- &gt;&gt;</span>
     <span class="cicada-nymph-string">"* *un-initialized-memory*"</span> write-string cr
     <span class="cicada-nymph-string">"  * SIZE : "</span> write-string
          <span class="cicada-nymph-variable">*size,un-initialized-memory*</span>
          . cr
     <span class="cicada-nymph-string">"  * USED : "</span> write-string
          <span class="cicada-nymph-variable">*current-free-address,un-initialized-memory*</span>
          <span class="cicada-nymph-variable">*un-initialized-memory*</span>
          sub . cr
     <span class="cicada-nymph-string">"  * FREE : "</span> write-string
          <span class="cicada-nymph-variable">*size,un-initialized-memory*</span>
          <span class="cicada-nymph-variable">*current-free-address,un-initialized-memory*</span>
          <span class="cicada-nymph-variable">*un-initialized-memory*</span>
          sub sub . cr
     <span class="cicada-nymph-string">"* *primitive-string-heap*"</span> write-string cr
     <span class="cicada-nymph-string">"  * SIZE : "</span> write-string
          <span class="cicada-nymph-variable">*size,primitive-string-heap*</span>
          . cr
     <span class="cicada-nymph-string">"  * USED : "</span> write-string
          <span class="cicada-nymph-variable">*current-free-address,primitive-string-heap*</span>
          <span class="cicada-nymph-variable">*primitive-string-heap*</span>
          sub . cr
     <span class="cicada-nymph-string">"  * FREE : "</span> write-string
          <span class="cicada-nymph-variable">*size,primitive-string-heap*</span>
          <span class="cicada-nymph-variable">*current-free-address,primitive-string-heap*</span>
          <span class="cicada-nymph-variable">*primitive-string-heap*</span>
          sub sub . cr
     <span class="cicada-nymph-string">"* *jo-heap*"</span> write-string cr
     <span class="cicada-nymph-string">"  * SIZE : "</span> write-string
          <span class="cicada-nymph-variable">*size,jo-heap*</span> . cr
     <span class="cicada-nymph-string">"  * USED : "</span> write-string
          <span class="cicada-nymph-variable">*current-free-address,jo-heap*</span>
          <span class="cicada-nymph-variable">*jo-heap*</span>
          sub . cr
     <span class="cicada-nymph-string">"  * FREE : "</span> write-string
          <span class="cicada-nymph-variable">*size,jo-heap*</span>
          <span class="cicada-nymph-variable">*current-free-address,jo-heap*</span>
          <span class="cicada-nymph-variable">*jo-heap*</span>
          sub sub . cr
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* an interface of </span><span class="org-level-1"><span class="bold">*un-initialized-memory*</span></span>
<span class="org-level-2">** allocate</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph :tangle core.cn
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">allocate</span>
     <span class="cicada-nymph-comment">&lt;&lt; size -- address &gt;&gt;</span>
     <span class="cicada-nymph-variable">*un-initialized-memory*</span> tuck
     add <span class="cicada-nymph-syntax-key-word">address</span> <span class="cicada-nymph-variable">*un-initialized-memory*</span> save
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* ===================================</span>
</pre>
  </body>
</html>
