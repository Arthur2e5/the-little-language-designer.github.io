---
---
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>cicada-nymph.org</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
    <!--
      body {
        color: #f8f8f0;
        background-color: #1b1d1e;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #a6e22e;
      }
      .cicada-nymph-bool {
        /* cicada-nymph-bool-face */
        color: #fd971f;
        font-weight: bold;
      }
      .cicada-nymph-comment {
        /* cicada-nymph-comment-face */
        color: #FF8888;
      }
      .cicada-nymph-end {
        /* cicada-nymph-end-face */
        color: #00ffff;
        font-weight: bold;
      }
      .cicada-nymph-fetch-local-variable-1 {
        /* cicada-nymph-fetch-local-variable-1-face */
        color: #83EA83;
        font-weight: bold;
      }
      .cicada-nymph-fetch-local-variable-2 {
        /* cicada-nymph-fetch-local-variable-2-face */
        color: #5CDD5C;
        font-weight: bold;
      }
      .cicada-nymph-lexicographer {
        /* cicada-nymph-lexicographer-face */
        color: #ae81ff;
        font-weight: bold;
      }
      .cicada-nymph-number {
        /* cicada-nymph-number-face */
        color: #fd971f;
        font-weight: bold;
      }
      .cicada-nymph-save-local-variable-1 {
        /* cicada-nymph-save-local-variable-1-face */
        color: #FF4C4C;
        font-weight: bold;
      }
      .cicada-nymph-save-local-variable-2 {
        /* cicada-nymph-save-local-variable-2-face */
        color: #dc322f;
        font-weight: bold;
      }
      .cicada-nymph-save-local-variable-X {
        /* cicada-nymph-save-local-variable-@-face */
        color: #AE7C3B;
        font-weight: bold;
      }
      .cicada-nymph-sentence-reader {
        /* cicada-nymph-sentence-reader-face */
        color: #ffff00;
        font-weight: bold;
      }
      .cicada-nymph-syntax-key-word {
        /* cicada-nymph-syntax-key-word-face */
        color: #f92672;
        font-weight: bold;
      }
      .cicada-nymph-variable {
        /* cicada-nymph-variable-face */
        color: #fd971f;
      }
      .cicada-nymph-word-to-define {
        /* cicada-nymph-word-to-define-face */
        color: #ef5939;
        font-weight: bold;
      }
      .comment {
        /* font-lock-comment-face */
        color: #FF8888;
      }
      .constant {
        /* font-lock-constant-face */
        color: #ae81ff;
      }
      .default {
        /* default */
        color: #f8f8f0;
        background-color: #1b1d1e;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #a6e22e;
      }
      .italic {
        /* italic */
        text-decoration: underline;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #f92672;
        font-weight: bold;
      }
      .org-block {
        /* org-block */
        color: #b3b3b3;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #FF8888;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #FF8888;
      }
      .org-document-info {
        /* org-document-info */
        color: #afeeee;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-weight: bold;
      }
      .org-done {
        /* org-done */
        color: #98fb98;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #a6e22e;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #fd971f;
      }
      .org-level-3 {
        /* org-level-3 */
        color: #f92672;
        font-weight: bold;
      }
      .org-link {
        /* org-link */
        color: #00ffff;
        text-decoration: underline;
      }
      .org-special-keyword {
        /* org-special-keyword */
        color: #f92672;
        font-weight: bold;
      }
      .org-table {
        /* org-table */
        color: #87cefa;
      }
      .org-tag {
        /* org-tag */
        font-weight: bold;
      }
      .org-todo {
        /* org-todo */
        color: #ffc0cb;
        font-weight: bold;
      }
      .preprocessor {
        /* font-lock-preprocessor-face */
        color: #a6e22e;
      }
      .rainbow-delimiters-depth-1 {
        /* rainbow-delimiters-depth-1-face */
        color: #8c8c8c;
      }
      .return-stack-bar-ket {
        /* return-stack-bar-ket-face */
        color: #dc322f;
        font-weight: bold;
      }
      .return-stack-end {
        /* return-stack-end-face */
        color: #00ffff;
        font-weight: bold;
      }
      .return-stack-jo {
        /* return-stack-jo-face */
        color: #ef5939;
        font-weight: bold;
      }
      .return-stack-line {
        /* return-stack-line-face */
        color: #ae81ff;
        font-weight: bold;
      }
      .return-stack-the-jo {
        /* return-stack-the-jo-face */
        color: #fd971f;
        font-weight: bold;
      }
      .string {
        /* font-lock-string-face */
        color: #e6db74;
      }
      .type {
        /* font-lock-type-face */
        color: #66d9ef;
        font-weight: bold;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #fd971f;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
{% include in-org-head.html %}
  </head>
  <body>
    {% include before-pre.html %}
<pre>
<span class="org-document-info-keyword">#+TITLE:</span>  <span class="org-document-title">&#23567;&#34796;&#35486; / cicada-nymph
</span><span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">&#35613;&#23431;&#24646; / XIE Yuheng
</span><span class="org-document-info-keyword">#+EMAIL:</span>  <span class="org-document-info">xyheme@gmail.com
</span>
<span class="org-level-1">* </span><span class="org-done">todo</span>
<span class="org-level-2">** add more notes about the limitations of the program</span>
<span class="org-level-2">** add more notes about exception handling on io functions</span>
<span class="org-level-2">** implement all macro by dispatch-word-stack </span><span class="org-level-2"><span class="org-tag">:maybe:</span></span>
<span class="org-level-2">** optimize local-variable by new instruction</span>
   * too many literal is too waste of memory
<span class="org-level-2">** code clean-up &amp; documentation update</span>
<span class="org-level-2">** bare-metal version of cicada-nymph for x86 </span><span class="org-level-2"><span class="org-tag">:maybe:</span></span>
<span class="org-level-2">** better error handling of load-file</span>
<span class="org-level-2">** make instruction a type of jo      </span><span class="org-level-2"><span class="org-tag">:maybe:</span></span>
   this is needed when doing report of the dictionary
<span class="org-level-1">* ===================================</span>
<span class="org-level-1">* </span><span class="org-todo">note</span>
<span class="org-level-2">** jo &amp; jojo</span>
   * use "jo" to denote bead
     and use "jojo" to denote a thread of beads
     [which reads like "&#29664;&#29664;" in Chinese]
<span class="org-level-2">** naming convention</span>
   * a predicate of a type
     which denotes a subtype of that type
     uses that type as postfix
     such as
     "space-char?"
   * a function of a type
     uses that type as prefix
     such as
     "string-reverse"
     "string-equal?"
   * side-effect of structured data is postfixed by "!"
<span class="org-level-2">** convention in assembly code</span>
   * using underline to compose big word from small words
   * using "$" as prefix and postfix separator
   * indentation level = 3
   * naming convention of jo
     <span class="org-table">| convention   | jo type  |</span>
     <span class="org-table">|--------------+----------|</span>
     <span class="org-table">| prefix "V__" | variable |</span>
     <span class="org-table">| prefix "M__" | macro    |</span>
   * but I use
     1. "zero" instead of "V__zero"
     2. "true" instead of "V__true"
<span class="org-level-2">** convention in cicada-nymph code</span>
   * using dash to compose big word from small words
   * using "," as prefix and postfix separator
   * indentation style = free
   * words are separated by space
     except for bar-ket
     every bar-ket is viewed as a word
<span class="org-level-2">** syntax of cicada-nymph</span>
   * syntax &amp;  semantic
     <span class="org-table">| syntax          | semantic                  |</span>
     <span class="org-table">|-----------------+---------------------------|</span>
     <span class="org-table">| borderfix "* *" | variable                  |</span>
     <span class="org-table">| borderfix "+ +" | [maybe use]               |</span>
     <span class="org-table">| bar-ket ( )     | not use                   |</span>
     <span class="org-table">| bar-ket [ ]     | not use                   |</span>
     <span class="org-table">| bar-ket { }     | macro call                |</span>
     <span class="org-table">|                 | (for macros of which      |</span>
     <span class="org-table">|                 | the number of             |</span>
     <span class="org-table">|                 | arguments is not fix)     |</span>
     <span class="org-table">| double-quote    | viewed as special bar-ket |</span>
     <span class="org-table">|                 | (bar is the same as ket)  |</span>
     <span class="org-table">|                 | to support string literal |</span>
     <span class="org-table">| prefix "!"      | exception                 |</span>
     <span class="org-table">| postfix "!"     | some of the side-effect   |</span>
     <span class="org-table">| postfix "?"     | predicate                 |</span>
   * but I use
     1. "true" instead of "<span class="bold">*true*</span>"
     2. "false" instead of "<span class="bold">*false*</span>"
<span class="org-level-2">** unique id</span>
   * if one wish to get a named unique id
     a jo maybe used
     for a jo is an address in memory
     it is unique as a memory address
   * but there is not effort made
     to distinguish address and fixnum
     as different type of things
     thus
     this kind of unique id is not fit
     for some tasks
<span class="org-level-2">** different from the re-designed cicada-language</span>
    * simplifications are for teaching purpose only
    * first and foremost
      function programming will NOT be supported in this implementation
    * a helper function must be defined before it is used
    * no mixfix-notation
      * function call is "function" instead of "(function)"
      * no such thing like
        1 2 (add) = 1 (add 2) = (add 1 2)
    * no named local argument
      * thus no inited local argument
    * no title-name-table
      * thus in this implementation
        we only use single name space
      * thus in this implementation
        we do NOT have the concept of "context"
        so
        the syntax is not as flexible as it will be in cicada-language
    * no type
      * no type inference
      * no dynamic type tag
      * no static type declaration
    * global linked-list for naming
      * not hash-table
      * by the way
        in classical forth
        the linked-list of jo is called dictionary
    * no dynamic-memory-management
      * no garbage-collector
    * about comment
      * the comment of the argument &amp; return value of function
        is allowed to be written in free style normal comment
<span class="org-level-1">* </span><span class="org-todo">note</span><span class="org-level-1"> instar</span>
<span class="org-level-2">** 1st-instar</span>
   * indirect-threaded-code interpreter
     1. macro about argument_stack &amp; return_stack
     2. macro about jo &amp; jojo
     3. macro about next
     4. the way to do memory allocation
     5. begin_to_interpret_threaded_code
     6. little_test
<span class="org-level-2">** 2ed-instar</span>
   * instruction as special primitive function
     1. literal
     2. address
   * and primitive functions about
     1. the stack
     2. bool
     3. fixnum
     4. memory
   * and taca for explicit tail-call
   * false?branch and taca are needed for "power"
<span class="org-level-2">** 3rd-instar</span>
   * primitive function about io
     1. write_byte
     2. read_byte
<span class="org-level-2">** 4th-instar</span>
   * more function about io
     1. about word
     2. about string
     3. about number
   * more function
     1. jo
     2. char
     3. buffer
   * more in epilog
     1. last_link
   * function about dictionary
     1. find
     2. execute-word
   * basic-REPL as postfix-notation function executer
     1. basic-REPL
<span class="org-level-2">** 5th-instar</span>
   * type of jo
   * more in epilog
     1. <span class="bold">*current-free-address,primitive-string-heap*</span>
   * colon semicolon
     1. ":" and ";" are used to read a string of words for compiler
        [looks like bar-ket but special]
     2. comment is handled here
        "&lt;&lt; &gt;&gt;" as the only way to do comment
   * compiler
     * make-jojo
       and macro for make-jojo
       1. macro system
       2. exception handling system
     * function about definition
       which leave data into memory
<span class="org-level-2">** 6th-instar</span>
   * local-variable
<span class="org-level-1">* </span><span class="org-todo">&#35352;</span><span class="org-level-1"> &#25976;&#25818;&#32080;&#27083;&#33287;&#21475;&#32317;&#32080;</span>
<span class="org-level-2">** jojo</span>
   * jo &#30340;&#25976;&#32068;
     &#27599;&#20491;&#25976;&#32068;&#22806;&#21152;&#19968;&#20123;&#20803;&#25976;&#25818;
<span class="org-level-2">** dictionary of jojo</span>
   * &#21934;&#38917;&#37832;&#25509;&#30340;&#37832;&#34920;
<span class="org-level-2">** primitive-string</span>
<span class="org-level-2">** argument-stack</span>
<span class="org-level-2">** return-stack</span>
   * jo &#30340;&#35438;&#37323;&#32773;
     &#27770;&#23450;&#20102; &#22914;&#20309;&#20837;&#36889;&#20491;&#26855;
   * &#32080;&#23614;&#35422;
     &#27770;&#23450;&#20102; &#22914;&#20309;&#20986;&#36889;&#20491;&#26855;
<span class="org-level-2">** eval-string-stack</span>
   * &#20841;&#20491;&#19968;&#23565;
<span class="org-level-2">** dispatch-word-stack</span>
   * &#20841;&#20491;&#19968;&#23565;
     &#27599;&#23565;&#29234;
     [&#35486;&#27861;&#34389;&#29702;&#20989;&#25976;, &#20316;&#29992;&#26044;&#23383;&#31526;&#20018;&#30340;&#35586;&#35422;]
<span class="org-level-2">** local-variable-table</span>
   * a heap like table of string
   * &#21482;&#26377;&#19968;&#20491; local-variable-table
     &#29992;&#20197;&#22312;&#32232;&#35695;&#26178;&#26399;&#35299;&#27770;&#23616;&#37096;&#35722;&#20803;&#30340;&#21517;&#33287;&#20540;&#30340;&#23565;&#25033;
     &#36889;&#20491;&#25976;&#25818;&#32080;&#27083;&#34987; M__local_variable_save_string
     &#21644; M__local_variable_fetch_string &#25152;&#20351;&#29992;
   * &#20854;&#20013;&#20445;&#23384;
     * offset-in-local-data-heap
     * length-of-string
     * address-of-string
   * &#20006;&#19988;&#27599;&#27425;&#22312;&#23450;&#32681;&#19968;&#20491;&#26032;&#30340;&#20989;&#25976;&#39636;&#30340;&#26178;&#20505;
     &#36889;&#20491; local-variable-table &#26371;&#34987;&#21021;&#22987;&#21270;
   * &#22522;&#26412;&#30340;&#25509;&#21475;&#26159;
     * clear
       &#28165;&#31354; offset &#21644; border
     * insert
       &#25554;&#20837;&#23383;&#31526;&#20018; &#21644; offset-in-local-data-heap
     * find
       &#36890;&#36942;&#23383;&#31526;&#20018;&#23563;&#25214; offset-in-local-data-heap
     &#26377;&#20841;&#20491;&#20840;&#23616;&#35722;&#37327;&#24171;&#21161;&#23526;&#29694;&#36889;&#20123;&#25509;&#21475;
     * cursor
       &#27599;&#27425; find &#30340;&#26178;&#20505;&#20351;&#29992;&#19968;&#20491;&#26032;&#30340; cursor &#20358;&#20570;&#24490;&#29872;
     * border
       insert &#26371;&#25844;&#22823; border
       find &#20197; border &#29234;&#37002;&#30028;
     &#21478;&#22806; &#36996;&#26377;&#19968;&#20491;&#20840;&#23616;&#35722;&#37327;
     * offset
       &#29992;&#20197;&#35336;&#31639; offset-in-local-data-heap
<span class="org-level-1">* </span><span class="org-todo">&#35352;</span><span class="org-level-1"> &#24615;&#29376;&#32317;&#32080;</span>
<span class="org-level-2">** &#33258;&#21205;&#31649;&#29702;&#21152;&#36617;&#25991;&#20214;&#26178;&#25152;&#20351;&#29992;&#30340;&#25628;&#32034;&#36335;&#24465;&#21015;&#34920;</span>
   * &#21407;&#29702;&#22914;&#19979;
     * &#22312; cicada-nymph &#20013; load &#19968;&#20491; file &#30340;&#26178;&#20505;
       &#38656;&#35201;&#25351;&#23450;&#20986;&#36889;&#20491; &#34987; load &#30340; file &#30340;&#36335;&#24465;
     * &#32173;&#35703;&#19968;&#20491;&#38656;&#35201;&#34987;&#25628;&#32034;&#30340;&#36335;&#24465;&#30340;&#21015;&#34920;
       &#20197;&#20351;&#24471; load &#30340; file &#30340;&#26178;&#20505;
       &#19981;&#24517;&#20351;&#29992;&#23436;&#25972;&#30340;&#36335;&#24465;
     * &#25552;&#20379;&#33258;&#21205;&#31649;&#29702;&#25628;&#32034;&#36335;&#24465;&#30340;&#27231;&#21046;
   * &#32173;&#35703;&#25628;&#32034;&#36335;&#24465;&#30340;&#21015;&#34920;&#30340;&#26041;&#24335;&#26159;
     &#21033;&#29992;&#25991;&#20214;&#31995;&#32113;&#20013;&#30340;&#19968;&#20491;&#26576;&#20491;&#22266;&#23450;&#36335;&#24465;
     &#20063;&#23601;&#26159;&#35498; &#21482;&#26377;&#21807;&#19968;&#30340;&#19968;&#20491;&#38656;&#35201;&#34987;&#25214;&#21040;&#30340;&#36335;&#24465;
     &#32780;&#20854;&#20182;&#30340;&#36335;&#24465;&#37117;&#26159;&#34987;&#33258;&#21205;&#31649;&#29702;&#30340;
     &#36889;&#20491;&#36335;&#24465;&#23559;&#26377;&#19968;&#20491;&#40664;&#35469;&#20540;
     &#20006;&#19988;&#21487;&#20197;&#34987;&#29872;&#22659;&#35722;&#37327;&#35206;&#33995;
   * &#38480;&#21046;&#21152;&#36617;&#25991;&#20214;&#30340;&#26041;&#24335;
     &#20351;&#24471;&#21482;&#33021;&#20351;&#29992;&#25152;&#25552;&#20379;&#30340;&#21205;&#24907;&#31649;&#29702;&#27231;&#21046;&#20358;&#21152;&#36617;&#25991;&#20214;
     &#36889;&#27171;&#23601;&#21487;&#20197;&#28187;&#36629;&#29702;&#35299;&#36889;&#20491;&#31995;&#32113;&#30340;&#22256;&#38627;
<span class="org-level-2">** </span><span class="org-todo">&gt;&lt;</span><span class="org-level-2"> &#23616;&#37096;&#35722;&#20803;</span>
<span class="org-level-1">* </span><span class="org-todo">note</span><span class="org-level-1"> problem</span>
<span class="org-level-2">** about div                          </span><span class="org-level-2"><span class="org-tag">:bug:</span></span>
   * div can not handle the following
     -8 2 div .
<span class="org-level-2">** about inline comment               </span><span class="org-level-2"><span class="org-tag">:bug:</span></span>
   * inline comment such as
     add1 &lt;&lt; dup . &gt;&gt; swap
     will be viewed as
     add1swap
<span class="org-level-2">** about comment in string            </span><span class="org-level-2"><span class="org-tag">:bug:</span></span>
   * &lt;&lt; &gt;&gt; can not be in ""
<span class="org-level-2">** about stack                        </span><span class="org-level-2"><span class="org-tag">:limit:</span></span>
   * there are 64 positions below the all those stacks
     when you are belowing-stack so much
     bad things happen
<span class="org-level-2">** local-variable                     </span><span class="org-level-2"><span class="org-tag">:design:</span></span>
   * &#24819;&#35201;&#21152;&#20837;
     @:address &lt;number&gt;
     &#25110;&#32773;
     &lt;number&gt; %&gt;:address
   * &#20294;&#26159;
     &#30001;&#26044;&#23565; offset &#30340;&#35336;&#31639;&#26159;&#22312;&#32232;&#35695;&#26178;&#36914;&#34892;&#30340;
     &#25152;&#20197;&#26681;&#26412;&#23601;&#27794;&#21033;&#29992;&#21040;&#36889;&#35023;&#25152;&#33021;&#24471;&#21040;&#30340;&#26368;&#22823;&#30340;&#38728;&#27963;&#24615;
     &#20197;&#33267;&#26044;&#27794;&#27861;&#20197;&#33391;&#22909;&#30340;&#26041;&#24335;&#23526;&#29694;
     &#22312; local_data_heap &#20013;&#21205;&#24907;&#22320;&#20998;&#37197;&#35722;&#38263;&#30340;&#20839;&#23384;
   * &#24418;&#25104;&#36889;&#31278;&#23616;&#38754;&#30340;&#21407;&#22240;&#22312;&#26044;
     &#23565;&#23616;&#37096;&#35722;&#20803;&#30340;&#21517;&#23383;&#21644;&#20540;&#30340;&#38364;&#20418;&#30340;&#34389;&#29702;
     &#26159;&#22312;&#32232;&#35695;&#26178;&#26399;&#36914;&#34892;&#30340;
   * &#30001;&#26044;&#36889;&#20013;&#21839;&#38988;&#29986;&#29983;&#26044;&#20841;&#31278;&#20998;&#37197;&#20839;&#23384;&#26041;&#24335;&#30340;&#20132;&#32340;
     &#25152;&#20197;
     &#20854;&#35299;&#27770;&#36774;&#27861;&#20063;&#35377;&#26159;
     &#20877;&#22810;&#20837;&#36820;&#22238;&#31449;&#19968;&#20491;&#25351;&#37341;
     &#36889;&#20491;&#25351;&#37341;&#25152;&#25351;&#21521;&#30340;&#25976;&#25818;&#21312;&#20013;&#30340;&#25976;&#25818;
     &#26159;&#32020;&#31929;&#22312;&#36939;&#34892;&#26178;&#21205;&#24907;&#20998;&#37197;&#30340;
     &#20294;&#26159;&#36889;&#20123;&#25976;&#25818;&#27794;&#26377;&#21517;&#23383;
     [&#21517;&#23383;&#30340;&#21839;&#38988;&#26159;&#21478;&#22806;&#19968;&#20491;&#25351;&#37341;&#32080;&#23616;&#30340;]
<span class="org-level-1">* ===================================</span>
<span class="org-level-1">* prolog</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> conditional preprocessing</span>
   * flower bar-ket can not be nested in fasm's "match"
     so
     1. when defining macro conditionally
        one should use "if eq" &amp; "finish if"
     2. when doing "define" or "equ"
        one should use "match { }"
<span class="org-level-2">** platform configuration</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="comment">;;;; before you compile the code
</span>   <span class="comment">;;;; do not forget to choose your platform
</span>   <span class="comment">;;;; in the following code
</span>
   <span class="preprocessor">include</span> <span class="string">"platform-configuration.inc"</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** misc</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="comment">;; in fasm, "dup" is a reserved word
</span>   <span class="keyword">dup</span> <span class="preprocessor">equ</span> duplicate

   <span class="comment">;; in fasm, "end" is a reserved word
</span>   <span class="keyword">finish</span> <span class="preprocessor">equ</span> <span class="keyword">end</span>
   <span class="keyword">end</span> <span class="preprocessor">equ</span> exit
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** jo_size                            </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   jo_size = <span class="constant">8</span> <span class="comment">;; (byte)
</span>   <span class="type">xx</span> <span class="preprocessor">equ</span> <span class="type">dq</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** jo_size                            </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   jo_size = <span class="constant">4</span> <span class="comment">;; (byte)
</span>   <span class="type">xx</span> <span class="preprocessor">equ</span> <span class="type">dd</span>

   <span class="variable-name">rax</span> <span class="preprocessor">equ</span> <span class="variable-name">eax</span>
   <span class="variable-name">rbx</span> <span class="preprocessor">equ</span> <span class="variable-name">ebx</span>
   <span class="variable-name">rcx</span> <span class="preprocessor">equ</span> <span class="variable-name">ecx</span>
   <span class="variable-name">rdx</span> <span class="preprocessor">equ</span> <span class="variable-name">edx</span>
   <span class="variable-name">rsp</span> <span class="preprocessor">equ</span> <span class="variable-name">esp</span>
   <span class="variable-name">rbp</span> <span class="preprocessor">equ</span> <span class="variable-name">ebp</span>
   <span class="variable-name">rsi</span> <span class="preprocessor">equ</span> <span class="variable-name">esi</span>
   <span class="variable-name">rdi</span> <span class="preprocessor">equ</span> <span class="variable-name">edi</span>

   <span class="builtin">syscall</span> <span class="preprocessor">equ</span> <span class="builtin">int</span> <span class="constant">80h</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** header                             </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
   * /usr/include/asm/unistd_64.h (on archlinux)
   * <span class="org-link"><a href="http://blog.rchapman.org/post/36801038863/linux-system-call-table-for-x86-64">http://blog.rchapman.org/post/36801038863/linux-system-call-table-for-x86-64</a></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   <span class="preprocessor">define</span> linux64_sys_6_r8  <span class="variable-name">r8</span>
   <span class="preprocessor">define</span> linux64_sys_5_r9  <span class="variable-name">r9</span>
   <span class="preprocessor">define</span> linux64_sys_4_r10 <span class="variable-name">r10</span>
   <span class="preprocessor">define</span> linux64_sys_3_rdx <span class="variable-name">rdx</span>
   <span class="preprocessor">define</span> linux64_sys_2_rsi <span class="variable-name">rsi</span>
   <span class="preprocessor">define</span> linux64_sys_1_rdi <span class="variable-name">rdi</span>
   <span class="preprocessor">define</span> linux64_sys_n_rax <span class="variable-name">rax</span>

   <span class="preprocessor">define</span> linux64_syscall_read   <span class="constant">0</span>
   <span class="preprocessor">define</span> linux64_syscall_write  <span class="constant">1</span>
   <span class="preprocessor">define</span> linux64_syscall_open   <span class="constant">2</span>
   <span class="preprocessor">define</span> linux64_syscall_close  <span class="constant">3</span>
   <span class="preprocessor">define</span> linux64_syscall_getpid <span class="constant">39</span>
   <span class="preprocessor">define</span> linux64_syscall_exit   <span class="constant">60</span>
   <span class="comment">;; about open &amp; read &amp; write
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** format                             </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   <span class="keyword">format</span> ELF64 <span class="keyword">executable</span> <span class="constant">3</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** entry                              </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   <span class="keyword">entry</span> begin_to_interpret_threaded_code
   <span class="keyword">segment</span> <span class="keyword">readable</span> <span class="keyword">executable</span> <span class="keyword">writeable</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** header                             </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
   * /usr/include/asm/unistd_32.h (on archlinux)
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   <span class="preprocessor">define</span> linux32_sys_6_ebp <span class="variable-name">ebp</span>
   <span class="preprocessor">define</span> linux32_sys_5_edi <span class="variable-name">edi</span>
   <span class="preprocessor">define</span> linux32_sys_4_esi <span class="variable-name">esi</span>
   <span class="preprocessor">define</span> linux32_sys_3_edx <span class="variable-name">edx</span>
   <span class="preprocessor">define</span> linux32_sys_2_ecx <span class="variable-name">ecx</span>
   <span class="preprocessor">define</span> linux32_sys_1_ebx <span class="variable-name">ebx</span>
   <span class="preprocessor">define</span> linux32_sys_n_eax <span class="variable-name">eax</span>

   <span class="preprocessor">define</span> linux32_syscall_exit    <span class="constant">1</span>
   <span class="preprocessor">define</span> linux32_syscall_read    <span class="constant">3</span>
   <span class="preprocessor">define</span> linux32_syscall_write   <span class="constant">4</span>
   <span class="preprocessor">define</span> linux32_syscall_open    <span class="constant">5</span>
   <span class="preprocessor">define</span> linux32_syscall_close   <span class="constant">6</span>
   <span class="preprocessor">define</span> linux32_syscall_getpid  <span class="constant">20</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** format                             </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   <span class="keyword">format</span> ELF <span class="keyword">executable</span> <span class="constant">3</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** entry                              </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   <span class="keyword">entry</span> begin_to_interpret_threaded_code
   <span class="keyword">segment</span> <span class="keyword">readable</span> <span class="keyword">executable</span> <span class="keyword">writeable</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** memory allocation in un_initialized_memory</span>
   * implemented as a memory map
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   current_free_address$un_initialized_memory = address$un_initialized_memory

   <span class="keyword">labeling</span>  <span class="preprocessor">equ</span> = current_free_address$un_initialized_memory
   <span class="type">preserve</span>  <span class="preprocessor">equ</span> current_free_address$un_initialized_memory = current_free_address$un_initialized_memory +
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* </span><span class="org-todo">note</span><span class="org-level-1"> stack</span>
  * when doing "push"
    a stack-pointer moves to lower address
  * note that another style is that
    when doing "push"
    a stack-pointer moves to higher address
  * the stack-pointer
    always stores the address of current-free-address of the stack
  * note that another style is that
    under the stack-pointer
    there always stores the value of the-top-of-the-stack
<span class="org-level-1">* argument_stack</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** memory allocation</span>
   * for we do not build border-check
     into the interface of pop and push
     we allocation some memory below the stacks
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>      <span class="type">preserve</span> <span class="constant">64</span> * jo_size
   address$argument_stack <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** pointer                            </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   <span class="comment">;; if you want to extend cicada in assembly
</span>   <span class="comment">;; the following registers must NOT be used
</span>
   <span class="preprocessor">define</span> pointer$argument_stack <span class="variable-name">r15</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** push &amp; pop                         </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   <span class="preprocessor">macro</span> <span class="function-name">push_argument_stack</span> register \{
      <span class="builtin">mov</span> [pointer$argument_stack], register
      <span class="builtin">add</span> pointer$argument_stack, jo_size
   \}

   <span class="preprocessor">macro</span> <span class="function-name">pop_argument_stack</span> register \{
      <span class="builtin">sub</span> pointer$argument_stack, jo_size
      <span class="builtin">mov</span> register, [pointer$argument_stack]
   \}

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** pointer                            </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   <span class="function-name">pointer$argument_stack</span>:
      <span class="type">xx</span> address$argument_stack

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** push &amp; pop                         </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   <span class="preprocessor">macro</span> <span class="function-name">push_argument_stack</span> register \{
      <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
      <span class="builtin">push</span> <span class="variable-name">ebx</span>
      <span class="builtin">mov</span> <span class="variable-name">ebx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> [<span class="variable-name">ebx</span>], register
      <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
      <span class="builtin">mov</span> [pointer$argument_stack], <span class="variable-name">ebx</span>
      <span class="builtin">pop</span> <span class="variable-name">ebx</span>
      <span class="keyword">else</span>
      <span class="builtin">push</span> <span class="variable-name">eax</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> [<span class="variable-name">eax</span>], register
      <span class="builtin">add</span> <span class="variable-name">eax</span>, jo_size
      <span class="builtin">mov</span> [pointer$argument_stack], <span class="variable-name">eax</span>
      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      <span class="keyword">finish</span> <span class="keyword">if</span>
   \}

   <span class="preprocessor">macro</span> <span class="function-name">pop_argument_stack</span> register \{
      <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
      <span class="builtin">push</span> <span class="variable-name">ebx</span>
      <span class="builtin">mov</span> <span class="variable-name">ebx</span>, [pointer$argument_stack]
      <span class="builtin">sub</span> <span class="variable-name">ebx</span>, jo_size
      <span class="builtin">mov</span> register, [<span class="variable-name">ebx</span>]
      <span class="builtin">mov</span> [pointer$argument_stack], <span class="variable-name">ebx</span>
      <span class="builtin">pop</span> <span class="variable-name">ebx</span>
      <span class="keyword">else</span>
      <span class="builtin">push</span> <span class="variable-name">eax</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [pointer$argument_stack]
      <span class="builtin">sub</span> <span class="variable-name">eax</span>, jo_size
      <span class="builtin">mov</span> register, [<span class="variable-name">eax</span>]
      <span class="builtin">mov</span> [pointer$argument_stack], <span class="variable-name">eax</span>
      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      <span class="keyword">finish</span> <span class="keyword">if</span>
   \}

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* return_stack</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>      <span class="type">preserve</span> <span class="constant">64</span> * jo_size
   address$return_stack <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** pointer                            </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   <span class="comment">;; if you want to extend cicada in assembly
</span>   <span class="comment">;; the following registers must NOT be used
</span>
   <span class="preprocessor">define</span> pointer$return_stack <span class="variable-name">r14</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** push &amp; pop                         </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   <span class="preprocessor">macro</span> <span class="function-name">push_return_stack</span> register \{
      <span class="builtin">mov</span> [pointer$return_stack], register
      <span class="builtin">add</span> pointer$return_stack, jo_size
   \}

   <span class="preprocessor">macro</span> <span class="function-name">pop_return_stack</span> register \{
      <span class="builtin">sub</span> pointer$return_stack, jo_size
      <span class="builtin">mov</span> register, [pointer$return_stack]
   \}

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** pointer                            </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   <span class="function-name">pointer$return_stack</span>:
      <span class="type">xx</span> address$return_stack

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** push &amp; pop                         </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   <span class="preprocessor">macro</span> <span class="function-name">push_return_stack</span> register \{
      <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
      <span class="builtin">push</span> <span class="variable-name">ebx</span>
      <span class="builtin">mov</span> <span class="variable-name">ebx</span>, [pointer$return_stack]
      <span class="builtin">mov</span> [<span class="variable-name">ebx</span>], register
      <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
      <span class="builtin">mov</span> [pointer$return_stack], <span class="variable-name">ebx</span>
      <span class="builtin">pop</span> <span class="variable-name">ebx</span>
      <span class="keyword">else</span>
      <span class="builtin">push</span> <span class="variable-name">eax</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [pointer$return_stack]
      <span class="builtin">mov</span> [<span class="variable-name">eax</span>], register
      <span class="builtin">add</span> <span class="variable-name">eax</span>, jo_size
      <span class="builtin">mov</span> [pointer$return_stack], <span class="variable-name">eax</span>
      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      <span class="keyword">finish</span> <span class="keyword">if</span>
   \}

   <span class="preprocessor">macro</span> <span class="function-name">pop_return_stack</span> register \{
      <span class="keyword">if</span> register <span class="builtin">in</span> &lt;eax&gt;
      <span class="builtin">mov</span> <span class="variable-name">ebx</span>, [pointer$return_stack]
      <span class="builtin">sub</span> <span class="variable-name">ebx</span>, jo_size
      <span class="builtin">mov</span> register, [<span class="variable-name">ebx</span>]
      <span class="builtin">mov</span> [pointer$return_stack], <span class="variable-name">ebx</span>
      <span class="keyword">else</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [pointer$return_stack]
      <span class="builtin">sub</span> <span class="variable-name">eax</span>, jo_size
      <span class="builtin">mov</span> register, [<span class="variable-name">eax</span>]
      <span class="builtin">mov</span> [pointer$return_stack], <span class="variable-name">eax</span>
      <span class="keyword">finish</span> <span class="keyword">if</span>
   \}

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* next</span>
<span class="org-block-begin-line">  #+begin_src fasm :tangle cicada-nymph.fasm
</span>  <span class="preprocessor">match</span> =64bit, machine {

  <span class="preprocessor">macro</span> <span class="function-name">next</span> \{
     pop_return_stack <span class="variable-name">rbx</span>
       <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
     <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
     push_return_stack <span class="variable-name">rbx</span>
       <span class="builtin">jmp</span> <span class="type">qword</span> [<span class="variable-name">rax</span>]
  \}

  }


  <span class="preprocessor">match</span> =32bit, machine {

  <span class="preprocessor">macro</span> <span class="function-name">next</span> \{
     pop_return_stack <span class="variable-name">rbx</span>
       <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
     <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
     push_return_stack <span class="variable-name">rbx</span>
       <span class="builtin">jmp</span> <span class="type">dword</span> [<span class="variable-name">rax</span>]
  \}

  }
<span class="org-block-end-line">  #+end_src
</span><span class="org-level-1">* </span><span class="org-todo">note</span><span class="org-level-1"> play with jo &amp; jojo</span>
  1. at the beginning
     * argument-stack
       &lt;&lt; 2 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(square)</span> <span class="return-stack-bar-ket">]</span>
           <span class="return-stack-jo">(square)</span>
           <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">       #+end_src
</span>  2. next
     * argument-stack
       &lt;&lt; 2 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>           <span class="return-stack-jo">(square)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(square)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(dup)</span> <span class="return-stack-bar-ket">]</span>
           <span class="return-stack-end">(end)</span>          <span class="return-stack-jo">(mul)</span>
                          <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">       #+end_src
</span>  3. next
     * argument-stack
       &lt;&lt; 2, 2 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>           <span class="return-stack-jo">(square)</span>       <span class="return-stack-jo">(dup)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(square)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(mul)</span> <span class="return-stack-bar-ket">]</span>
           <span class="return-stack-end">(end)</span>          <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">       #+end_src
</span>  4. next
     * argument-stack &lt;&lt; 4 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>                          <span class="return-stack-jo">(dup)</span>
           <span class="return-stack-jo">(square)</span>       <span class="return-stack-jo">(mul)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(square)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span>
           <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">       #+end_src
</span>  5. next
     * argument-stack &lt;&lt; 4 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>           <span class="return-stack-jo">(square)</span>
           <span class="return-stack-jo">(square)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(dup)</span> <span class="return-stack-bar-ket">]</span>
                       <span class="return-stack-jo">(mul)</span>
                       <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">       #+end_src
</span>  6. next
     * argument-stack
       &lt;&lt; 4, 4 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>           <span class="return-stack-jo">(square)</span>
           <span class="return-stack-jo">(square)</span>    <span class="return-stack-jo">(dup)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(mul)</span> <span class="return-stack-bar-ket">]</span>
                       <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">       #+end_src
</span>  7. next
     * argument-stack
       &lt;&lt; 16 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>           <span class="return-stack-jo">(square)</span>    <span class="return-stack-jo">(dup)</span>
           <span class="return-stack-jo">(square)</span>    <span class="return-stack-jo">(mul)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span>
<span class="org-block-end-line">       #+end_src
</span>  8. next
     * argument-stack
       &lt;&lt; 16 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>           <span class="return-stack-jo">(square)</span>
           <span class="return-stack-jo">(square)</span>
       <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span>
<span class="org-block-end-line">       #+end_src
</span>  9. next
     * argument-stack
       &lt;&lt; 16 &gt;&gt;
     * return-stack
<span class="org-block-begin-line">       #+begin_src return-stack
</span>       <span class="return-stack-line">-</span> [  ]
<span class="org-block-end-line">       #+end_src
</span>  10. it is really simple
      ^-^
      is it not ?
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* helper function in assembly code</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** __exit_with_TOS                    </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   __exit_with_TOS:
      pop_argument_stack linux64_sys_1_rdi
      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_exit
      <span class="builtin">syscall</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** __exit_with_zero                   </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   __exit_with_zero:
      <span class="builtin">xor</span> linux64_sys_1_rdi, linux64_sys_1_rdi
      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_exit
      <span class="builtin">syscall</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** __exit_with_six                    </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   __exit_with_six:
      <span class="builtin">mov</span> linux64_sys_1_rdi, <span class="constant">6</span>
      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_exit
      <span class="builtin">syscall</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** __exit_with_TOS                    </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   __exit_with_TOS:
      pop_argument_stack linux32_sys_1_ebx
      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_exit
      <span class="builtin">syscall</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** __exit_with_zero                   </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   __exit_with_zero:
      <span class="builtin">xor</span> linux32_sys_1_ebx, linux32_sys_1_ebx
      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_exit
      <span class="builtin">syscall</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** __exit_with_six                    </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   __exit_with_six:
      <span class="builtin">mov</span> linux32_sys_1_ebx, <span class="constant">6</span>
      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_exit
      <span class="builtin">syscall</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* macro for jo &amp; explainer</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** link</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="comment">;; initial link to point to 0 (as null)
</span>   link = <span class="constant">0</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> primitive_string_heap</span>
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   size$primitive_string_heap = <span class="constant">64</span> * <span class="constant">1024</span> <span class="comment">;; (byte)
</span>
   <span class="function-name">address$primitive_string_heap</span>:
      <span class="keyword">times</span> size$primitive_string_heap <span class="type">db</span> <span class="constant">0</span>

   current_free_address$primitive_string_heap = address$primitive_string_heap
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** make_primitive_string</span>
   * 2 bytes for length of name_string
   * note that
     the following is using local label
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">macro</span> <span class="function-name">make_primitive_string</span> string {

   <span class="keyword">virtual</span> <span class="keyword">at</span> <span class="constant">0</span>
   <span class="function-name">.start$string</span>:
      <span class="type">db</span> string
   <span class="function-name">.end$string</span>:
      <span class="type">dw</span> (.end$string - .start$string)
      <span class="keyword">load</span> .length <span class="type">word</span> <span class="keyword">from</span> (.end$string)
   <span class="keyword">finish</span> <span class="keyword">virtual</span>
   <span class="keyword">store</span> <span class="type">word</span> .length <span class="keyword">at</span> (current_free_address$primitive_string_heap)

   current_free_address$primitive_string_heap = current_free_address$primitive_string_heap + <span class="constant">2</span>

   <span class="keyword">repeat</span> .length
      <span class="keyword">virtual</span> <span class="keyword">at</span> <span class="constant">0</span>
         <span class="type">db</span> string
         <span class="keyword">load</span> .char <span class="type">byte</span> <span class="keyword">from</span> (% - <span class="constant">1</span>)
      <span class="keyword">finish</span> <span class="keyword">virtual</span>
      <span class="keyword">store</span> <span class="type">byte</span> .char <span class="keyword">at</span> (current_free_address$primitive_string_heap)
      current_free_address$primitive_string_heap = current_free_address$primitive_string_heap + <span class="constant">1</span>
   <span class="keyword">finish</span> <span class="keyword">repeat</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * note that
     after a "next" "jmp" to a explainer
     the "rax" stores the value of the jo to be explained
     so
     "rax" is used as an inexplicit argument
     of the following functions
   * explain$function is used as jojo-head
     and explains the meaning of the jojo as function
   * a jojo-head identifies one type of jo
<span class="org-level-2">** define_function</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">macro</span> <span class="function-name">define_function</span> string, <span class="builtin">jo</span> {

   define_function__#<span class="builtin">jo</span>:

   name__#<span class="builtin">jo</span>:
      <span class="type">xx</span> current_free_address$primitive_string_heap

      make_primitive_string string

   link__#<span class="builtin">jo</span>:
      <span class="type">xx</span> link
      link = link__#<span class="builtin">jo</span>

   <span class="builtin">jo</span>:
      <span class="type">xx</span> explain$function

      <span class="comment">;; here follows a jojo as function-body
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** explain$function</span>
   * find a jojo from a function-jo
     and push the jojo to return-stack
   * a jojo can not be of size 0
   * use rax as an argument
     which stores a jo
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">explain$function</span>:
      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [current_free_address$local_data_heap]
      push_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
      push_return_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * primitive functions are special
     they explain themself
     and their type is not identified by jojo-head
<span class="org-level-2">** define_primitive_function</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">macro</span> <span class="function-name">define_primitive_function</span> string, <span class="builtin">jo</span> {

   define_primitive_function__#<span class="builtin">jo</span>:

   name__#<span class="builtin">jo</span>:
      <span class="type">xx</span> current_free_address$primitive_string_heap

      make_primitive_string string

   link__#<span class="builtin">jo</span>:
      <span class="type">xx</span> link
      link = link__#<span class="builtin">jo</span>

   <span class="builtin">jo</span>:
      <span class="type">xx</span> assembly_code__#<span class="builtin">jo</span>

   assembly_code__#<span class="builtin">jo</span>:

      <span class="comment">;; here follows assembly code
</span>      <span class="comment">;; as primitive function body
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * no constant
     only variable
   * when a variable jo in the jojo
     it push the value of the variable to argument_stack
   * when wish to change a variable's value
     use key_word "address" to get the address of the variable
<span class="org-level-2">** define_variable</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">macro</span> <span class="function-name">define_variable</span> string, <span class="builtin">jo</span> {

   define_variable__#<span class="builtin">jo</span>:

   name__#<span class="builtin">jo</span>:
      <span class="type">xx</span> current_free_address$primitive_string_heap

      make_primitive_string string

   link__#<span class="builtin">jo</span>:
      <span class="type">xx</span> link
      link = link__#<span class="builtin">jo</span>

   <span class="builtin">jo</span>:
      <span class="type">xx</span> explain$variable

      <span class="comment">;; here follows a value of jo_size
</span>      <span class="comment">;; only one value is allowed
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** explain$variable</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">explain$variable</span>:
      <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [<span class="variable-name">rax</span>]
      push_argument_stack <span class="variable-name">rbx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* macro for make-jojo</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * the same as function
     we need to redefine it
     for the value of explainer
     is used to decide the type of the jo
<span class="org-level-2">** define_macro</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">macro</span> <span class="function-name">define_macro</span> string, <span class="builtin">jo</span> {

   define_macro__#<span class="builtin">jo</span>:

   name__#<span class="builtin">jo</span>:
      <span class="type">xx</span> current_free_address$primitive_string_heap

      make_primitive_string string

   link__#<span class="builtin">jo</span>:
      <span class="type">xx</span> link
      link = link__#<span class="builtin">jo</span>

   <span class="builtin">jo</span>:
      <span class="type">xx</span> explain$macro

      <span class="comment">;; here follows a jojo as function-body
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** explain$macro</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">explain$macro</span>:
      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [current_free_address$local_data_heap]
      push_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
      push_return_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * explain$exception will
     1. search the return-stack for that exception
     2. special side-effect on return-stack
        to do exception handling
<span class="org-level-2">** define_exception</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">macro</span> <span class="function-name">define_exception</span> string, <span class="builtin">jo</span> {

   define_exception__#<span class="builtin">jo</span>:

   name__#<span class="builtin">jo</span>:
      <span class="type">xx</span> current_free_address$primitive_string_heap

      make_primitive_string string

   link__#<span class="builtin">jo</span>:
      <span class="type">xx</span> link
      link = link__#<span class="builtin">jo</span>

   <span class="builtin">jo</span>:
      <span class="type">xx</span> explain$exception

      <span class="comment">;; here follows a jojo as function-body
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> return-stack in action</span>
   1. when "explain$exception" is called
      jojo by jojo
      it searchs the jo stored in "rax" in the return-stack
      of course
      only jojo with "exception_head" as head needs to be searched
   2. for example
      we have
<span class="org-block-begin-line">      #+begin_src fasm
</span>      define_exception <span class="string">"!exception-1"</span>, !exception_1
         <span class="type">xx</span> fun1
         <span class="type">xx</span> fun2
         <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">      #+end_src
</span>   3. return-stack
<span class="org-block-begin-line">      #+begin_src return-stack
</span>                                               <span class="return-stack-jo">(prepare_for)</span>
                                                 <span class="return-stack-jo">(exception_head)</span>
                                                 <span class="return-stack-jo">(!exception_1)</span>
                                                 <span class="return-stack-jo">(!exception_2)</span>
                                                 <span class="return-stack-jo">(end_of_prepare)</span>
                      <span class="return-stack-jo">(prepare_for)</span>            <span class="return-stack-jo">(function_1)</span>
      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">pointer</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(exception_head)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(function_2)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(!exception_1)</span> <span class="return-stack-bar-ket">]</span>
                        <span class="return-stack-jo">(!exception_1)</span>         <span class="return-stack-end">(end)</span>              <span class="return-stack-end">(end)</span>
                        <span class="return-stack-jo">(!exception_2)</span>
                        <span class="return-stack-jo">(end_of_prepare)</span>
                      <span class="return-stack-jo">(function_1)</span>
                      <span class="return-stack-jo">(function_2)</span>
                      <span class="return-stack-end">(end)</span>

      the pointer above is into argument-stack
<span class="org-block-end-line">      #+end_src
</span>   4. next
      * pointer$argument_stack
        should be set to the pointer above
      * and
        to call "next" again
        the return-stack should be change to
<span class="org-block-begin-line">        #+begin_src return-stack
</span>        <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(fun1)</span> <span class="return-stack-bar-ket">]</span>
            <span class="return-stack-jo">(fun2)</span>
            <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">        #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> the plan</span>
   * so
     we need a two-level loop
   * note that
     although
     we have to use assembly code
     to write primitive functions
     but
     we still can use argument-stack
     to pass arguments
<span class="org-level-2">** explain$exception                  </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
   * no error handling for now
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   <span class="function-name">explain$exception</span>:
      <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="variable-name">rax</span>

   <span class="function-name">.next_jojo</span>:
      pop_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> [<span class="variable-name">rbx</span>]
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, exception_head
      <span class="builtin">je</span> .next_jo
      <span class="builtin">cmp</span> pointer$return_stack, address$return_stack
      <span class="builtin">je</span> .not_found
      <span class="builtin">jmp</span> .next_jojo


   <span class="function-name">.next_jo</span>:
      <span class="comment">;; expecting
</span>      <span class="comment">;;   rbx jojo
</span>      <span class="comment">;;   rsi jo (to cmp)
</span>      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> [<span class="variable-name">rbx</span>]
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="variable-name">rsi</span>
      <span class="builtin">je</span> .found
      <span class="builtin">test</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">jz</span> .next_jojo
      <span class="builtin">jmp</span> .next_jo


   <span class="function-name">.found</span>:
      <span class="comment">;; expecting
</span>      <span class="comment">;;   pointer$return_stack
</span>      <span class="comment">;;   rsi jo
</span>      pop_return_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> pointer$argument_stack, <span class="variable-name">rax</span>

      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [current_free_address$local_data_heap]
      push_return_stack <span class="variable-name">rbx</span>

      <span class="builtin">add</span> <span class="variable-name">rsi</span>, jo_size
      push_return_stack <span class="variable-name">rsi</span>
      next

   <span class="function-name">.not_found</span>:
      <span class="builtin">call</span> __exit_with_six

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** explain$exception                  </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
   * no error handling for now
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   <span class="function-name">explain$exception</span>:
      <span class="builtin">mov</span> <span class="variable-name">rsi</span>, <span class="variable-name">rax</span>

   <span class="function-name">.next_jojo</span>:
      pop_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">dword</span> [<span class="variable-name">rbx</span>]
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, exception_head
      <span class="builtin">je</span> .next_jo
      <span class="builtin">mov</span> <span class="variable-name">rdx</span>, [pointer$return_stack]
      <span class="builtin">cmp</span> <span class="variable-name">rdx</span>, address$return_stack
      <span class="builtin">je</span> .not_found
      <span class="builtin">jmp</span> .next_jojo


   <span class="function-name">.next_jo</span>:
      <span class="comment">;; expecting
</span>      <span class="comment">;;   rbx jojo
</span>      <span class="comment">;;   rsi jo (to cmp)
</span>      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">dword</span> [<span class="variable-name">rbx</span>]
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="variable-name">rsi</span>
      <span class="builtin">je</span> .found
      <span class="builtin">test</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">jz</span> .next_jojo
      <span class="builtin">jmp</span> .next_jo


   <span class="function-name">.found</span>:
      <span class="comment">;; expecting
</span>      <span class="comment">;;   pointer$return_stack
</span>      <span class="comment">;;   rsi jo
</span>      pop_return_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [pointer$argument_stack], <span class="variable-name">rax</span>

      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [current_free_address$local_data_heap]
      push_return_stack <span class="variable-name">rbx</span>

      <span class="builtin">add</span> <span class="variable-name">rsi</span>, jo_size
      push_return_stack <span class="variable-name">rsi</span>
      next

   <span class="function-name">.not_found</span>:
      <span class="builtin">call</span> __exit_with_six

      }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* execute-jo &amp; structure of jo</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** execute-jo</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"execute-jo"</span>, execute_jo
      <span class="comment">;; &lt;&lt; jo -- unknown &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">jmp</span> <span class="type">qword</span> [<span class="variable-name">rax</span>]

   }


   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"execute-jo"</span>, execute_jo
      <span class="comment">;; &lt;&lt; jo -- unknown &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">eax</span>
      <span class="builtin">jmp</span> <span class="type">dword</span> [<span class="variable-name">eax</span>]

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-level-2"><span class="bold">*jo-size*</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*jo-size*"</span>, V__jo_size
      <span class="type">xx</span> jo_size
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** jo-&gt;name</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"jo-&gt;name"</span>, jo_to_name
      <span class="comment">;; &lt;&lt; jo -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, jo_size, subtraction
      <span class="type">xx</span> <span class="keyword">literal</span>, jo_size, subtraction
      <span class="type">xx</span> fetch
      <span class="type">xx</span> address_to_primitive_string
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** jo-&gt;link</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"jo-&gt;link"</span>, jo_to_link
      <span class="comment">;; &lt;&lt; jo -- link &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, jo_size
      <span class="type">xx</span> subtraction
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** last-jo,dictionary?</span>
   * first jo in assembly code
     is the last jo in dictionary
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"last-jo,dictionary?"</span>, last_jo__dictionary?
      <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>      <span class="type">xx</span> jo_to_link
      <span class="type">xx</span> fetch
      <span class="type">xx</span> zero?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** jo-&gt;pre-jo</span>
   * treat last-jo,dictionary specially
     i.e. return zero on that case
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"jo-&gt;pre-jo"</span>, jo_to_pre_jo
      <span class="comment">;; &lt;&lt; jo -- pre-jo &gt;&gt;
</span>      <span class="type">xx</span> jo_to_link
      <span class="type">xx</span> fetch
      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, jo_size
      <span class="type">xx</span> addition
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** jo-&gt;type</span>
   * the type of primitive function jo
     is encoded by 0
   * other types of jo
     are encoded by their explainers
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"jo-&gt;type"</span>, jo_to_type
      <span class="comment">;; &lt;&lt; jo -- type &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>

      <span class="type">xx</span> <span class="keyword">dup</span>, fetch
      <span class="type">xx</span> swap, subtraction, <span class="keyword">literal</span>, jo_size, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, zero
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="type">xx</span> fetch
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* primitive-string-heap</span>
<span class="org-level-2">** </span><span class="org-level-2"><span class="bold">*primitive-string-heap*</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*primitive-string-heap*"</span>, V__primitive_string_heap
      <span class="type">xx</span> address$primitive_string_heap

   define_variable <span class="string">"*size,primitive-string-heap*"</span>, V__size__primitive_string_heap
      <span class="type">xx</span> size$primitive_string_heap

   <span class="comment">;; *current-free-address,primitive-string-heap*
</span>   <span class="comment">;; is at epilog
</span><span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** address-&gt;primitive-string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"address-&gt;primitive-string"</span>, address_to_primitive_string
      <span class="comment">;; &lt;&lt; address -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, addition  <span class="comment">;; address
</span>      <span class="type">xx</span> swap, fetch_two_bytes <span class="comment">;; length
</span>      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* type of jo</span>
<span class="org-level-2">** primitive-function-jo?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"primitive-function-jo?"</span>, primitive_function_jo?
      <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>      <span class="type">xx</span> jo_to_type
      <span class="type">xx</span> zero?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** function-jo?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"function-jo?"</span>, function_jo?
      <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>      <span class="type">xx</span> jo_to_type
      <span class="type">xx</span> <span class="keyword">literal</span>, explain$function
      <span class="type">xx</span> equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** macro-jo?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"macro-jo?"</span>, macro_jo?
      <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>      <span class="type">xx</span> jo_to_type
      <span class="type">xx</span> <span class="keyword">literal</span>, explain$macro
      <span class="type">xx</span> equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** exception-jo?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"exception-jo?"</span>, exception_jo?
      <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>      <span class="type">xx</span> jo_to_type
      <span class="type">xx</span> <span class="keyword">literal</span>, explain$exception
      <span class="type">xx</span> equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** variable-jo?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"variable-jo?"</span>, variable_jo?
      <span class="comment">;; &lt;&lt; jo -- bool &gt;&gt;
</span>      <span class="type">xx</span> jo_to_type
      <span class="type">xx</span> <span class="keyword">literal</span>, explain$variable
      <span class="type">xx</span> equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* end &amp; taca</span>
<span class="org-level-2">** end</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"end"</span>, <span class="keyword">end</span>
      pop_return_stack <span class="variable-name">rbx</span>
      pop_return_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [current_free_address$local_data_heap], <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** taca</span>
   * tail-call
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"&lt;&gt;"</span>, <span class="keyword">taca</span>
      pop_return_stack <span class="variable-name">rbx</span>
      pop_return_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [current_free_address$local_data_heap], <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      <span class="builtin">jmp</span> <span class="type">qword</span> [<span class="variable-name">rax</span>]
   }


   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"&lt;&gt;"</span>, <span class="keyword">taca</span>
      pop_return_stack <span class="variable-name">ebx</span>
      pop_return_stack <span class="variable-name">ecx</span>
      <span class="builtin">mov</span> [current_free_address$local_data_heap], <span class="variable-name">ecx</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [<span class="variable-name">ebx</span>]
      <span class="builtin">jmp</span> <span class="type">dword</span> [<span class="variable-name">eax</span>]

   <span class="comment">;; &gt;&lt;&gt;&lt;&gt;&lt; can not be the following
</span>   <span class="comment">;; maybe still something wrong with pop_return_stack
</span>   <span class="comment">;; but I care less about this now
</span>   <span class="comment">;; define_primitive_function "&lt;&gt;", taca
</span>   <span class="comment">;;    pop_return_stack ebx
</span>   <span class="comment">;;    pop_return_stack eax
</span>   <span class="comment">;;    mov [current_free_address$local_data_heap], eax
</span>   <span class="comment">;;    mov eax, [ebx]
</span>   <span class="comment">;;    jmp dword [eax]
</span>
   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> explicit tail call in action</span>
   1. the tail position of a function body must be recognized
      explicit tail call is used to achieve this
   2. thus
      tail-recursive-call can be use to do loop
      without pushing too many address into return-stack
   3. for example if we have a function
      which is called "example"
<span class="org-block-begin-line">      #+begin_src fasm
</span>      define_function <span class="string">"example"</span>, example
         <span class="type">xx</span> fun1
         <span class="type">xx</span> fun2
         <span class="type">xx</span> <span class="keyword">taca</span>, example
<span class="org-block-end-line">      #+end_src
</span>   4. and we have the following jojo in return-stack
<span class="org-block-begin-line">      #+begin_src return-stack
</span>      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(example)</span> <span class="return-stack-bar-ket">]</span>
          <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">      #+end_src
</span>   5. next
<span class="org-block-begin-line">      #+begin_src return-stack
</span>          <span class="return-stack-jo">(example)</span>
      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(fun1)</span> <span class="return-stack-bar-ket">]</span>
                      <span class="return-stack-jo">(fun2)</span>
                      <span class="return-stack-end">(taca)</span>
                      <span class="return-stack-jo">(example)</span>
<span class="org-block-end-line">      #+end_src
</span>   6. next
<span class="org-block-begin-line">      #+begin_src return-stack
</span>          <span class="return-stack-jo">(example)</span>   <span class="return-stack-jo">(fun1)</span>
      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(fun2)</span> <span class="return-stack-bar-ket">]</span>
                      <span class="return-stack-end">(taca)</span>
                      <span class="return-stack-jo">(example)</span>
<span class="org-block-end-line">      #+end_src
</span>   7. next
<span class="org-block-begin-line">      #+begin_src return-stack
</span>                      <span class="return-stack-jo">(fun1)</span>
          <span class="return-stack-jo">(example)</span>   <span class="return-stack-jo">(fun2)</span>
      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(taca)</span> <span class="return-stack-bar-ket">]</span>
                      <span class="return-stack-jo">(example)</span>
<span class="org-block-end-line">      #+end_src
</span>   8. next
      by the definition of taca
<span class="org-block-begin-line">      #+begin_src return-stack
</span>          <span class="return-stack-jo">(example)</span>
      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-end">(end)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(fun1)</span> <span class="return-stack-bar-ket">]</span>
                      <span class="return-stack-jo">(fun2)</span>
                      <span class="return-stack-end">(taca)</span>
                      <span class="return-stack-jo">(example)</span>
<span class="org-block-end-line">      #+end_src
</span>   9. you can see return-stack of (8.)
      is the same as (5.)
      it is clear how the example function
      is actually a loop now
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* </span><span class="org-level-1"><span class="bold">*the story begin*</span></span>
<span class="org-level-2">** begin_to_interpret_threaded_code   </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   <span class="function-name">begin_to_interpret_threaded_code</span>:

      <span class="builtin">cld</span> <span class="comment">;; set DF = 0, then rsi and rdi are incremented
</span>
      <span class="builtin">mov</span> pointer$argument_stack,  address$argument_stack
      <span class="builtin">mov</span> pointer$return_stack,    address$return_stack

      <span class="builtin">mov</span> <span class="variable-name">rax</span>, first_jojo
      push_return_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** begin_to_interpret_threaded_code   </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   <span class="function-name">begin_to_interpret_threaded_code</span>:

      <span class="builtin">cld</span> <span class="comment">;; set DF = 0, then rsi and rdi are incremented
</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, first_jojo
      push_return_stack <span class="variable-name">eax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** first_jojo</span>
   * you can use the following "xx little_test"
     to do some little tests
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">first_jojo</span>:
      <span class="comment">;; xx welcome
</span>      <span class="comment">;; xx little_test
</span>      <span class="type">xx</span> initialization
      <span class="type">xx</span> load_core_file
      <span class="type">xx</span> basic_REPL
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** welcome</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"welcome"</span>, welcome
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$welcome_to_cicada_nymph
      <span class="type">xx</span> <span class="keyword">literal</span>, length$welcome_to_cicada_nymph
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$welcome_to_cicada_nymph</span>:
      <span class="type">db</span> <span class="string">"* welcome to cicada-nymph ^-^"</span>
      <span class="type">db</span> <span class="constant">10</span>
   <span class="function-name">.end</span>:
   length$welcome_to_cicada_nymph = (.end - string$welcome_to_cicada_nymph)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** exit_with_TOS a.k.a. bye</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"bye"</span>, exit_with_TOS
      <span class="builtin">call</span> __exit_with_TOS
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** little_test</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">""</span>, V__little_test_number
      <span class="type">xx</span> <span class="constant">3</span>


   define_function <span class="string">"little_test"</span>, little_test

      <span class="comment">;;;; variable
</span>      <span class="comment">;; xx V__little_test_number
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; exit ocde : 3
</span>
      <span class="comment">;;;; literal
</span>      <span class="comment">;; xx literal, 4
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; exit ocde : 4
</span>
      <span class="comment">;;;; address
</span>      <span class="comment">;; xx address, V__little_test_number, fetch, add2
</span>      <span class="comment">;; xx address, V__little_test_number, save
</span>      <span class="comment">;; xx V__little_test_number
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; exit ocde : 5
</span>
      <span class="comment">;;;; end
</span>      <span class="comment">;; xx literal, 2, negate
</span>      <span class="comment">;; xx literal, 8
</span>      <span class="comment">;; xx addition
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; 6
</span>
      <span class="comment">;;;; taca
</span>      <span class="comment">;; xx literal, 2
</span>      <span class="comment">;; xx literal, 4
</span>      <span class="comment">;; xx power
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; exit ocde : 16
</span>
      <span class="comment">;;;; write_byte
</span>      <span class="comment">;; xx literal, 64, write_byte
</span>      <span class="comment">;; xx literal, 10, write_byte
</span>      <span class="comment">;; xx zero
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; @
</span>
      <span class="comment">;;;; read_byte
</span>      <span class="comment">;; xx read_byte, write_byte
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;;
</span>
      <span class="comment">;;;; branch
</span>      <span class="comment">;; xx read_byte, write_byte
</span>      <span class="comment">;; xx branch, -3
</span>      <span class="comment">;;;; read a string that ended by &lt;return&gt;
</span>      <span class="comment">;;;; write the readed string
</span>      <span class="comment">;;;; or we can say
</span>      <span class="comment">;;;; read line and write line
</span>      <span class="comment">;;;; or we can say
</span>      <span class="comment">;;;; echo line
</span>
      <span class="comment">;;;; false?branch
</span>      <span class="comment">;; xx false, false?branch, 9
</span>      <span class="comment">;; xx   literal, 64, write_byte
</span>      <span class="comment">;; xx   literal, 10, write_byte
</span>      <span class="comment">;; xx   zero
</span>      <span class="comment">;; xx   exit_with_TOS
</span>      <span class="comment">;; xx true, false?branch, 9
</span>      <span class="comment">;; xx   literal, 65, write_byte
</span>      <span class="comment">;; xx   literal, 10, write_byte
</span>      <span class="comment">;; xx   zero
</span>      <span class="comment">;; xx   exit_with_TOS
</span>      <span class="comment">;; xx zero
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; A
</span>
      <span class="comment">;;;; read_word &amp; write_string
</span>      <span class="comment">;; xx read_word, write_string
</span>      <span class="comment">;; xx literal, 10, write_byte
</span>      <span class="comment">;; xx read_word_for_REPL, write_string
</span>      <span class="comment">;; xx literal, 10, write_byte
</span>      <span class="comment">;; xx zero
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; read line
</span>      <span class="comment">;;;; write first two words of the line
</span>
      <span class="comment">;;;; string-&gt;integer
</span>      <span class="comment">;; xx read_word, string_to_integer
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; type 123
</span>      <span class="comment">;;;; exit code 123
</span>
      <span class="comment">;;;; use jo_to_name to test the macro make_primitive_string
</span>      <span class="comment">;; xx literal, jo_to_name, jo_to_name, write_string
</span>      <span class="comment">;; xx literal, 10, write_byte
</span>      <span class="comment">;; xx literal, addition, jo_to_name, write_string
</span>      <span class="comment">;; xx literal, 10, write_byte
</span>      <span class="comment">;; xx zero
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; print "jo-&gt;name"
</span>      <span class="comment">;;;; print "add"
</span>
      <span class="comment">;;;; xxoverxx
</span>      <span class="comment">;; xx literal, 1
</span>      <span class="comment">;; xx literal, 2
</span>      <span class="comment">;; xx literal, 3
</span>      <span class="comment">;; xx literal, 4
</span>      <span class="comment">;; xx xxoverxx
</span>      <span class="comment">;; xx pretty_write_integer
</span>      <span class="comment">;; xx pretty_write_integer
</span>      <span class="comment">;; xx pretty_write_integer
</span>      <span class="comment">;; xx pretty_write_integer
</span>      <span class="comment">;; xx pretty_write_integer
</span>      <span class="comment">;; xx pretty_write_integer
</span>      <span class="comment">;; xx zero
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; 2 1 4 3 2 1
</span>
      <span class="comment">;;;; find
</span>      <span class="comment">;; xx read_word, string_to_integer ;; number
</span>      <span class="comment">;; xx read_word, string_to_integer ;; number
</span>      <span class="comment">;; xx read_word, find ;; add
</span>      <span class="comment">;; xx drop ;; true
</span>      <span class="comment">;; xx execute_jo
</span>      <span class="comment">;; xx write_integer
</span>      <span class="comment">;; xx zero
</span>      <span class="comment">;; xx exit_with_TOS
</span>      <span class="comment">;;;; 1 2 add
</span>      <span class="comment">;;;; print "3"
</span>
      <span class="comment">;;;; basic-REPL (without the ability to define function)
</span>      <span class="comment">;;;; after this test
</span>      <span class="comment">;;;; we will use basic-REPL to do further tests
</span>      <span class="comment">;; xx basic_REPL
</span>      <span class="comment">;;;; 1 2 add .
</span><span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* the stack</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** drop</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"drop"</span>, drop
      <span class="comment">;; &lt;&lt; a -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"drop2"</span>, drop2
      <span class="comment">;; &lt;&lt; a b -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      pop_argument_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** dup                                </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"dup"</span>, <span class="keyword">dup</span>
      <span class="comment">;; &lt;&lt; a -- a, a &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"dup2"</span>, dup2
      <span class="comment">;; &lt;&lt; a b -- a b a b &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rbx</span>, [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">2</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** dup                                </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"dup"</span>, <span class="keyword">dup</span>
      <span class="comment">;; &lt;&lt; a -- a a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"dup2"</span>, dup2
      <span class="comment">;; &lt;&lt; a b -- a b a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** over                               </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"over"</span>, over
      <span class="comment">;; &lt;&lt; a b -- a b | a &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">2</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|over|xx"</span>, xoverxx
      <span class="comment">;; &lt;&lt; a | b c -- a | b c | a &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">3</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|over|x"</span>, xxoverx
      <span class="comment">;; &lt;&lt; a b | c -- a b | c | a b &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">3</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">3</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|over|xx"</span>, xxoverxx
      <span class="comment">;; &lt;&lt; a b | c d -- a b | c d | a b &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">4</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">4</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|over|xxx"</span>, xoverxxx
      <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">4</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|over|xxxx"</span>, xoverxxxx
      <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">5</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|over|xxxx"</span>, xxoverxxxx
      <span class="comment">;; &lt;&lt; a b | c d e f -- a b | c d e f | a b &gt;&gt;
</span>      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">6</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span>  <span class="variable-name">rax</span>, [pointer$argument_stack - (<span class="constant">6</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** over                               </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"over"</span>, over
      <span class="comment">;; &lt;&lt; a b -- a b | a &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">2</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|over|xx"</span>, xoverxx
      <span class="comment">;; &lt;&lt; a | b c -- a | b c | a &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">3</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|over|x"</span>, xxoverx
      <span class="comment">;; &lt;&lt; a b | c -- a b | c | a b &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">3</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">2</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|over|xx"</span>, xxoverxx
      <span class="comment">;; &lt;&lt; a b | c d -- a b | c d | a b &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">4</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">3</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|over|xxx"</span>, xoverxxx
      <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">4</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|over|xxxx"</span>, xoverxxxx
      <span class="comment">;; &lt;&lt; a | b c d -- a | b c d | a &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">5</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|over|xxxx"</span>, xxoverxxxx
      <span class="comment">;; &lt;&lt; a b | c d e f -- a b | c d e f | a b &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">6</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span> - (<span class="constant">5</span> * jo_size)]
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** tuck</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"tuck"</span>, tuck
      <span class="comment">;; &lt;&lt; a b -- b | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"x|tuck|xx"</span>, xtuckxx
      <span class="comment">;; &lt;&lt; a | b c -- b c | a | b c &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      next

   define_primitive_function <span class="string">"xx|tuck|x"</span>, xxtuckx
      <span class="comment">;; &lt;&lt; a b | c -- c | a b | c &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      next

   define_primitive_function <span class="string">"xx|tuck|xx"</span>, xxtuckxx
      <span class="comment">;; &lt;&lt; a b | c d -- c d | a b | c d &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      next

   define_primitive_function <span class="string">"xxx|tuck|x"</span>, xxxtuckx
      <span class="comment">;; &lt;&lt; a b c | d -- d | a b c | d &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** swap                               </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"swap"</span>, swap
      <span class="comment">;; &lt;&lt; a b -- b a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"x|swap|xx"</span>, xswapxx
      <span class="comment">;; &lt;&lt; a | b c -- b c | a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xx|swap|x"</span>, xxswapx
      <span class="comment">;; &lt;&lt; a b | c -- c | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"x|swap|xxx"</span>, xswapxxx
      <span class="comment">;; &lt;&lt; a | b c d -- b c d | a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xxx|swap|x"</span>, xxxswapx
      <span class="comment">;; &lt;&lt; a b c | d -- d | a b c &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      next

   define_primitive_function <span class="string">"xx|swap|xx"</span>, xxswapxx
      <span class="comment">;; &lt;&lt; a b | c d -- c d | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      next


   define_primitive_function <span class="string">"x|swap|xxxx"</span>, xswapxxxx
      <span class="comment">;; &lt;&lt; a | b c d e -- b c d e | a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"xxxx|swap|x"</span>, xxxxswapx
      <span class="comment">;; &lt;&lt; a b c d | e --  e | a b c d &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      next


   define_primitive_function <span class="string">"xx|swap|xxxx"</span>, xxswapxxxx
      <span class="comment">;; &lt;&lt; a b | c d e f -- c d e f | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>      pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      push_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"xxxx|swap|xx"</span>, xxxxswapxx
      <span class="comment">;; &lt;&lt; a b c d | e f --  e f | a b c d &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>      pop_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">r8</span> <span class="comment">;; e
</span>      push_argument_stack <span class="variable-name">r9</span> <span class="comment">;; f
</span>      push_argument_stack <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rcx</span>
      push_argument_stack <span class="variable-name">rdx</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** swap                               </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"swap"</span>, swap
      <span class="comment">;; &lt;&lt; a b -- b a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">eax</span>
      next

   define_primitive_function <span class="string">"x|swap|xx"</span>, xswapxx
      <span class="comment">;; &lt;&lt; a | b c -- b c | a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">eax</span>
      next

   define_primitive_function <span class="string">"xx|swap|x"</span>, xxswapx
      <span class="comment">;; &lt;&lt; a b | c -- c | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      next

   define_primitive_function <span class="string">"x|swap|xxx"</span>, xswapxxx
      <span class="comment">;; &lt;&lt; a | b c d -- b c d | a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">edx</span>
      push_argument_stack <span class="variable-name">eax</span>
      next

   define_primitive_function <span class="string">"xxx|swap|x"</span>, xxxswapx
      <span class="comment">;; &lt;&lt; a b c | d -- d | a b c &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">edx</span>
      push_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">ecx</span>
      next

   define_primitive_function <span class="string">"xx|swap|xx"</span>, xxswapxx
      <span class="comment">;; &lt;&lt; a b | c d -- c d | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">edx</span>
      push_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      next


   define_primitive_function <span class="string">"x|swap|xxxx"</span>, xswapxxxx
      <span class="comment">;; &lt;&lt; a | b c d e -- b c d e | a &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>      <span class="builtin">push</span> <span class="variable-name">eax</span>

      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">edx</span>

      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
      push_argument_stack <span class="variable-name">eax</span>
      next

   define_primitive_function <span class="string">"xxxx|swap|x"</span>, xxxxswapx
      <span class="comment">;; &lt;&lt; a b c d | e --  e | a b c d &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>      <span class="builtin">push</span> <span class="variable-name">eax</span>

      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>

      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
      push_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">edx</span>
      next


   define_primitive_function <span class="string">"xx|swap|xxxx"</span>, xxswapxxxx
      <span class="comment">;; &lt;&lt; a b | c d e f -- c d e f | a b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>      <span class="builtin">push</span> <span class="variable-name">eax</span>

      pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>      <span class="builtin">push</span> <span class="variable-name">eax</span>

      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">edx</span>

      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>
      push_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      next

   define_primitive_function <span class="string">"xxxx|swap|xx"</span>, xxxxswapxx
      <span class="comment">;; &lt;&lt; a b c d | e f --  e f | a b c d &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>      <span class="builtin">push</span> <span class="variable-name">eax</span>

      pop_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>      <span class="builtin">push</span> <span class="variable-name">eax</span>

      pop_argument_stack <span class="variable-name">edx</span>
      pop_argument_stack <span class="variable-name">ecx</span>
      pop_argument_stack <span class="variable-name">ebx</span>
      pop_argument_stack <span class="variable-name">eax</span>

      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; e
</span>
      <span class="builtin">pop</span> <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">eax</span> <span class="comment">;; f
</span>
      push_argument_stack <span class="variable-name">eax</span>
      push_argument_stack <span class="variable-name">ebx</span>
      push_argument_stack <span class="variable-name">ecx</span>
      push_argument_stack <span class="variable-name">edx</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** address</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*the-stack*"</span>, V__the_stack
      <span class="type">xx</span> address$argument_stack
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** pointer                            </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_variable <span class="string">"*the-stack-pointer-snapshot*"</span>, V__the_stack_pointer_snapshot
      <span class="type">xx</span> address$argument_stack

   define_primitive_function <span class="string">"snapshot-the-stack-pointer"</span>, snapshot_the_stack_pointer
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="builtin">mov</span> [V__the_stack_pointer_snapshot + jo_size], pointer$argument_stack
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** pointer                            </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_variable <span class="string">"*the-stack-pointer-snapshot*"</span>, V__the_stack_pointer_snapshot
      <span class="type">xx</span> address$argument_stack

   define_primitive_function <span class="string">"snapshot-the-stack-pointer"</span>, snapshot_the_stack_pointer
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> [V__the_stack_pointer_snapshot + jo_size], <span class="variable-name">eax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* instruction</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> side-effect</span>
   * an instruction
     is a special primitive function
     which does special side-effect on return-stack
   * note that
     side-effect on return-stack
     should all be done in primitive functions
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> naming</span>
   * the naming convention in assembly code
     of instruction
     is the same as it of jo
   * the name of an instruction
     might not be exported to cicada-language as a function
     but as a variable
   * the name of a special primitive function in assembly code
     maybe reused as a macro word in cicada-language
     but the name of the macro in assembly code
     is prefixed by "M__"
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** literal</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*literal*"</span>, V__literal
      <span class="type">xx</span> <span class="keyword">literal</span>

   define_primitive_function <span class="string">""</span>, <span class="keyword">literal</span>
      <span class="comment">;; &lt;&lt; -- fixnum &gt;&gt;
</span>      pop_return_stack <span class="variable-name">rbx</span>
        <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
        push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      push_return_stack <span class="variable-name">rbx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** address</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*address*"</span>, V__address
      <span class="type">xx</span> <span class="keyword">address</span>

   define_primitive_function <span class="string">""</span>, <span class="keyword">address</span>
      <span class="comment">;; &lt;&lt; -- address &gt;&gt;
</span>      pop_return_stack <span class="variable-name">rbx</span>
        <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
        <span class="builtin">add</span> <span class="variable-name">rax</span>, jo_size
        push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      push_return_stack <span class="variable-name">rbx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** branch</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*branch*"</span>, V__branch
      <span class="type">xx</span> <span class="keyword">branch</span>

   define_primitive_function <span class="string">""</span>, <span class="keyword">branch</span>
      pop_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      <span class="builtin">imul</span> <span class="variable-name">rax</span>, jo_size
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
      push_return_stack <span class="variable-name">rbx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** false?branch</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*false?branch*"</span>, V__false?branch
      <span class="type">xx</span> <span class="keyword">false?branch</span>

   define_primitive_function <span class="string">""</span>, <span class="keyword">false?branch</span>
      <span class="comment">;; &lt;&lt; true of false -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">test</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">jnz</span> help__false?branch__not_to_branch

      pop_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      <span class="builtin">imul</span> <span class="variable-name">rax</span>, jo_size
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
      push_return_stack <span class="variable-name">rbx</span>
      next

   <span class="function-name">help__false?branch__not_to_branch</span>:
      pop_return_stack <span class="variable-name">rbx</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      push_return_stack <span class="variable-name">rbx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> return-stack in action</span>
   1. proper exception handling
      is implemented by doing side-effect on return-stack
   2. when executing the following code block
<span class="org-block-begin-line">      #+begin_src fasm
</span>      <span class="type">xx</span> prepare_for
      <span class="type">xx</span> exception_head
      <span class="type">xx</span>   !exception_1
      <span class="type">xx</span>   !exception_2
      <span class="type">xx</span>   end_of_prepare
      <span class="type">xx</span> function_1
      <span class="type">xx</span> function_2
      <span class="type">xx</span> end_of_prepare
<span class="org-block-end-line">      #+end_src
</span>   3. return-stack
<span class="org-block-begin-line">      #+begin_src return-stack
</span>      <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(prepare_for)</span> <span class="return-stack-bar-ket">]</span>
            <span class="return-stack-jo">(exception_head)</span>
            <span class="return-stack-jo">(!exception_1)</span>
            <span class="return-stack-jo">(!exception_2)</span>
            <span class="return-stack-jo">(end_of_prepare)</span>
          <span class="return-stack-jo">(function_1)</span>
          <span class="return-stack-jo">(function_2)</span>
          <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">      #+end_src
</span>   4. next
      * this is how the return-stack looks
        right before exception_head is executed
<span class="org-block-begin-line">        #+begin_src return-stack
</span>          <span class="return-stack-jo">(prepare_for)</span>
        <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(exception_head)</span> <span class="return-stack-bar-ket">]</span>
            <span class="return-stack-jo">(!exception_1)</span>
            <span class="return-stack-jo">(!exception_2)</span>
            <span class="return-stack-jo">(end_of_prepare)</span>
          <span class="return-stack-jo">(function_1)</span>
          <span class="return-stack-jo">(function_2)</span>
          <span class="return-stack-end">(end)</span>
<span class="org-block-end-line">        #+end_src
</span>      * after exception_head is executed
<span class="org-block-begin-line">        #+begin_src return-stack
</span>                                                 <span class="return-stack-jo">(prepare_for)</span>
                                                   <span class="return-stack-jo">(exception_head)</span>
                                                   <span class="return-stack-jo">(!exception_1)</span>
                                                   <span class="return-stack-jo">(!exception_2)</span>
                        <span class="return-stack-jo">(prepare_for)</span>              <span class="return-stack-jo">(end_of_prepare)</span>
        <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">pointer</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(exception_head)</span> <span class="return-stack-bar-ket">]</span> <span class="return-stack-line">-</span> <span class="return-stack-bar-ket">[</span> <span class="return-stack-the-jo">(function_1)</span> <span class="return-stack-bar-ket">]</span>
                          <span class="return-stack-jo">(!exception_1)</span>         <span class="return-stack-jo">(function_2)</span>
                          <span class="return-stack-jo">(!exception_2)</span>         <span class="return-stack-end">(end)</span>
                          <span class="return-stack-jo">(end_of_prepare)</span>
                        <span class="return-stack-jo">(function_1)</span>
                        <span class="return-stack-jo">(function_2)</span>
                        <span class="return-stack-end">(end)</span>

        the pointer above is into argument-stack
<span class="org-block-end-line">        #+end_src
</span><span class="org-level-2">** prepare_for                        </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
   * prepare for a list of exceptions
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">""</span>, prepare_for
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      pop_return_stack <span class="variable-name">rbx</span>
      pop_return_stack <span class="variable-name">rcx</span>
      push_return_stack pointer$argument_stack
      push_return_stack <span class="variable-name">rbx</span>
      push_return_stack <span class="variable-name">rcx</span>
   <span class="function-name">.next</span>:
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> [<span class="variable-name">rbx</span>]
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, end_of_prepare
      <span class="builtin">je</span> .then
      <span class="builtin">jmp</span> .next
   <span class="function-name">.then</span>:
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      push_return_stack <span class="variable-name">rbx</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** prepare_for                        </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
   * prepare for a list of exceptions
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">""</span>, prepare_for
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      pop_return_stack <span class="variable-name">ebx</span>
      pop_return_stack <span class="variable-name">ecx</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, [pointer$argument_stack]
      push_return_stack <span class="variable-name">eax</span>
      push_return_stack <span class="variable-name">ebx</span>
      push_return_stack <span class="variable-name">ecx</span>
   <span class="function-name">.next</span>:
      <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="type">dword</span> [<span class="variable-name">ebx</span>]
      <span class="builtin">cmp</span> <span class="variable-name">eax</span>, end_of_prepare
      <span class="builtin">je</span> .then
      <span class="builtin">jmp</span> .next
   <span class="function-name">.then</span>:
      <span class="builtin">add</span> <span class="variable-name">ebx</span>, jo_size
      push_return_stack <span class="variable-name">ebx</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** end_of_prepare</span>
   * used as an unique id
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*end-of-prepare*"</span>, V__end_of_prepare

   <span class="function-name">end_of_prepare</span>:
      <span class="type">xx</span> <span class="constant">0</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** exception_head</span>
   * this jo is served as a label in return-stack
     when explained
     it pops the jojo itself in
     and
     it pops the argument-stack pointer after it
   * and "explain$exception" will search for them
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">""</span>, exception_head
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      pop_return_stack <span class="variable-name">rax</span>
      pop_return_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* bool</span>
<span class="org-level-2">** false &amp; true</span>
   * they are defined as function
     and viewed as constant
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"false"</span>, false
      <span class="comment">;; &lt;&lt; -- false &gt;&gt;
</span>      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"true"</span>, true
      <span class="comment">;; &lt;&lt; -- true &gt;&gt;
</span>      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** false? &amp; true?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"false?"</span>, false?
      <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>      <span class="type">xx</span> false, equal?
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"true?"</span>, true?
      <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>      <span class="type">xx</span> true, equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** bitwise operations                 </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"bitwise-and"</span>, bitwise_and
      <span class="comment">;; &lt;&lt; a, b -- a and b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">and</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"bitwise-or"</span>, bitwise_or
      <span class="comment">;; &lt;&lt; a, b -- a or b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">or</span>  [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"bitwise-xor"</span>, bitwise_xor
      <span class="comment">;; &lt;&lt; a, b -- a xor b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"bitwise-invert"</span>, bitwise_invert
      <span class="comment">;; &lt;&lt; a -- invert a &gt;&gt;
</span>      <span class="builtin">not</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** bitwise operations                 </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"bitwise-and"</span>, bitwise_and
      <span class="comment">;; &lt;&lt; a, b -- a and b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$argument_stack]
      <span class="builtin">and</span> [<span class="variable-name">rax</span> - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"bitwise-or"</span>, bitwise_or
      <span class="comment">;; &lt;&lt; a, b -- a or b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$argument_stack]
      <span class="builtin">or</span>  [<span class="variable-name">rax</span> - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"bitwise-xor"</span>, bitwise_xor
      <span class="comment">;; &lt;&lt; a, b -- a xor b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$argument_stack]
      <span class="builtin">xor</span> [<span class="variable-name">rax</span> - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rbx</span>
      next

   define_primitive_function <span class="string">"bitwise-invert"</span>, bitwise_invert
      <span class="comment">;; &lt;&lt; a -- invert a &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$argument_stack]
      <span class="builtin">not</span> <span class="type">dword</span> [<span class="variable-name">rax</span> - (<span class="constant">1</span> * jo_size)]
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* fixnum</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** zero &amp; one</span>
   * they are defined as function
     and viewed as constant
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"zero"</span>, zero
      <span class="comment">;; &lt;&lt; -- 0 &gt;&gt;
</span>      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"one"</span>, one
      <span class="comment">;; &lt;&lt; -- 1 &gt;&gt;
</span>      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** zero? &amp; one?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"zero?"</span>, zero?
      <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>      <span class="type">xx</span> zero, equal?
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"one?"</span>, one?
      <span class="comment">;; &lt;&lt; bool -- bool &gt;&gt;
</span>      <span class="type">xx</span> one, equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** add &amp; sub                          </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"add1"</span>, add1
      <span class="comment">;; &lt;&lt; n -- n+1 &gt;&gt;
</span>      <span class="builtin">inc</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      next

   define_primitive_function <span class="string">"add2"</span>, add2
      <span class="comment">;; &lt;&lt; n -- n+2 &gt;&gt;
</span>      <span class="builtin">add</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">2</span>
      next

   define_primitive_function <span class="string">"add3"</span>, add3
      <span class="comment">;; &lt;&lt; n -- n+3 &gt;&gt;
</span>      <span class="builtin">add</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">3</span>
      next

   define_primitive_function <span class="string">"add4"</span>, add4
      <span class="comment">;; &lt;&lt; n -- n+4 &gt;&gt;
</span>      <span class="builtin">add</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">4</span>
      next

   define_primitive_function <span class="string">"add8"</span>, add8
      <span class="comment">;; &lt;&lt; n -- n+8 &gt;&gt;
</span>      <span class="builtin">add</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">8</span>
      next


   define_primitive_function <span class="string">"sub1"</span>, sub1
      <span class="comment">;; &lt;&lt; n -- n-1 &gt;&gt;
</span>      <span class="builtin">dec</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      next

   define_primitive_function <span class="string">"sub2"</span>, sub2
      <span class="comment">;; &lt;&lt; n -- n-2 &gt;&gt;
</span>      <span class="builtin">sub</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">2</span>
      next

   define_primitive_function <span class="string">"sub3"</span>, sub3
      <span class="comment">;; &lt;&lt; n -- n-3 &gt;&gt;
</span>      <span class="builtin">sub</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">3</span>
      next

   define_primitive_function <span class="string">"sub4"</span>, sub4
      <span class="comment">;; &lt;&lt; n -- n-4 &gt;&gt;
</span>      <span class="builtin">sub</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">4</span>
      next

   define_primitive_function <span class="string">"sub8"</span>, sub8
      <span class="comment">;; &lt;&lt; n -- n-8 &gt;&gt;
</span>      <span class="builtin">sub</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="constant">8</span>
      next


   define_primitive_function <span class="string">"add"</span>, addition
      <span class="comment">;; &lt;&lt; a b -- a+b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub"</span>, subtraction
      <span class="comment">;; &lt;&lt; a b -- a-b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="type">qword</span> [pointer$argument_stack - (<span class="constant">1</span> * jo_size)], <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** add &amp; sub                          </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"add1"</span>, add1
      <span class="comment">;; &lt;&lt; n -- n+1 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"add2"</span>, add2
      <span class="comment">;; &lt;&lt; n -- n+2 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"add3"</span>, add3
      <span class="comment">;; &lt;&lt; n -- n+3 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"add4"</span>, add4
      <span class="comment">;; &lt;&lt; n -- n+4 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"add8"</span>, add8
      <span class="comment">;; &lt;&lt; n -- n+8 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rax</span>, <span class="constant">8</span>
      push_argument_stack <span class="variable-name">rax</span>
      next


   define_primitive_function <span class="string">"sub1"</span>, sub1
      <span class="comment">;; &lt;&lt; n -- n-1 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub2"</span>, sub2
      <span class="comment">;; &lt;&lt; n -- n-2 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub3"</span>, sub3
      <span class="comment">;; &lt;&lt; n -- n-3 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub4"</span>, sub4
      <span class="comment">;; &lt;&lt; n -- n-4 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      <span class="builtin">dec</span> <span class="variable-name">rax</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub8"</span>, sub8
      <span class="comment">;; &lt;&lt; n -- n-8 &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="variable-name">rax</span>, <span class="constant">8</span>
      push_argument_stack <span class="variable-name">rax</span>
      next


   define_primitive_function <span class="string">"add"</span>, addition
      <span class="comment">;; &lt;&lt; a b -- a+b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub"</span>, subtraction
      <span class="comment">;; &lt;&lt; a b -- a-b &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** mul</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"mul"</span>, multiple
      <span class="comment">;; &lt;&lt; a b -- a*b &gt;&gt;
</span>      pop_argument_stack  <span class="variable-name">rbx</span> <span class="comment">;; 2ed arg
</span>      pop_argument_stack  <span class="variable-name">rax</span> <span class="comment">;; 1st arg
</span>      <span class="builtin">imul</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
      <span class="comment">;; imul will ignore overflow
</span>      <span class="comment">;; when there are two registers as arg
</span>      <span class="comment">;; imul will save the result into the first register
</span>      push_argument_stack <span class="variable-name">rbx</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** negate</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"negate"</span>, negate
      <span class="comment">;; &lt;&lt; n --  -n &gt;&gt;
</span>      <span class="type">xx</span> zero
      <span class="type">xx</span> swap, subtraction
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** power</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"power"</span>, power
      <span class="comment">;; n must be nature number for now
</span>      <span class="comment">;; &lt;&lt; a, n -- a^n &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, swap <span class="comment">;; leave product
</span>      <span class="type">xx</span> help__power
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"help,power"</span>, help__power
      <span class="comment">;; &lt;&lt; a, product, n -- a^n &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop, swap, drop
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> sub1
      <span class="type">xx</span> swap
      <span class="type">xx</span>   xoverxx, multiple
      <span class="type">xx</span> swap
      <span class="type">xx</span> <span class="keyword">taca</span>, help__power
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** div &amp; mod</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"moddiv"</span>, moddiv
      <span class="comment">;; &lt;&lt; a, b -- a mod b, quotient &gt;&gt;
</span>      <span class="comment">;; &lt;&lt; dividend, divisor -- remainder, quotient &gt;&gt;
</span>      <span class="comment">;; the arg of idiv is divisor
</span>      <span class="comment">;; the lower half of dividend is taken from rax
</span>      <span class="comment">;; the upper half of dividend is taken from rdx
</span>      <span class="builtin">xor</span>  <span class="variable-name">rdx</span>, <span class="variable-name">rdx</span>   <span class="comment">;; high-part of dividend is not used
</span>      pop_argument_stack  <span class="variable-name">rbx</span> <span class="comment">;; 2ed arg
</span>      pop_argument_stack  <span class="variable-name">rax</span> <span class="comment">;; 1st arg
</span>      <span class="builtin">idiv</span> <span class="variable-name">rbx</span>
      <span class="comment">;; the remainder is stored in rdx
</span>      <span class="comment">;; the quotient  is stored in rax
</span>      push_argument_stack <span class="variable-name">rdx</span> <span class="comment">;; remainder
</span>      push_argument_stack <span class="variable-name">rax</span> <span class="comment">;; quotient
</span>      next


   define_function <span class="string">"divmod"</span>, divmod
      <span class="comment">;; &lt;&lt; a, b -- quotient, a mod b &gt;&gt;
</span>      <span class="type">xx</span> moddiv, swap
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"div"</span>, division
      <span class="comment">;; &lt;&lt; a, b -- quotient &gt;&gt;
</span>      <span class="type">xx</span> divmod, drop
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"mod"</span>, modulo
      <span class="comment">;; &lt;&lt; a, b -- a mod b &gt;&gt;
</span>      <span class="type">xx</span> moddiv, drop
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** equal? &amp; greater-than? &amp; less-than?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"equal?"</span>, equal?
      <span class="comment">;; &lt;&lt; a, b -- a, b, true of false &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span>   <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
      <span class="builtin">sete</span>  <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"less-than?"</span>, less_than?
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
      <span class="builtin">setl</span>  <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"greater-than?"</span>, greater_than?
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
      <span class="builtin">setg</span>  <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack  <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"less-or-equal?"</span>, less_or_equal?
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
      <span class="builtin">setle</span> <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"greater-or-equal?"</span>, greater_or_equal?
      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span>   <span class="variable-name">rax</span>, <span class="variable-name">rbx</span>
      <span class="builtin">setge</span> <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** negative? &amp; positive?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"negative?"</span>, negative?
      <span class="comment">;; &lt;&lt; integer -- bool &gt;&gt;
</span>      <span class="type">xx</span> zero, less_than?
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"positive?"</span>, positive?
      <span class="comment">;; &lt;&lt; integer -- bool &gt;&gt;
</span>      <span class="type">xx</span> negative?, false?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* memory</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * although the following functions are all side-effect
     but I use "save" instead of "save!"
<span class="org-level-2">** save                               </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   <span class="comment">;; "save" and "fetch" default to a jo_size
</span>   <span class="comment">;; the rule of "fetch2" and so on are:
</span>   <span class="comment">;;   in memory:
</span>   <span class="comment">;;     ||  1 : value-1  ||
</span>   <span class="comment">;;     ||  1 : value-2  ||
</span>   <span class="comment">;;     ||  1 : value-3  ||
</span>   <span class="comment">;;     ...
</span>   <span class="comment">;;   on stack:
</span>   <span class="comment">;;     &lt;&lt; value-1, value-2, value-3, ... &gt;&gt;
</span>   <span class="comment">;; of course we have:
</span>   <span class="comment">;;   fetch2 : memory=copy=&gt;stack
</span>   <span class="comment">;;   save2  : stack-&gt;memory
</span>
   define_primitive_function <span class="string">"save"</span>, save
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"save-byte"</span>, save_byte
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">byte</span>[<span class="variable-name">rbx</span>], <span class="variable-name">al</span>
      next

   define_primitive_function <span class="string">"save-two-bytes"</span>, save_two_bytes
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">word</span> [<span class="variable-name">rbx</span>], <span class="variable-name">ax</span>
      next

   define_primitive_function <span class="string">"save-four-bytes"</span>, save_four_bytes
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">dword</span> [<span class="variable-name">rbx</span>], <span class="variable-name">eax</span>
      next

   define_primitive_function <span class="string">"n-save"</span>, n_save
      <span class="comment">;; &lt;&lt; value-n, ..., value-1, address, n -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
      <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
      <span class="builtin">add</span> <span class="variable-name">rdx</span>, <span class="variable-name">rax</span>
      <span class="comment">;; for address is based on 0
</span>      <span class="comment">;; but n is based on 1
</span>      <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
   <span class="function-name">.loop</span>:
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">qword</span> [<span class="variable-name">rdx</span>], <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   define_function <span class="string">"save2"</span>, save2
      <span class="comment">;; &lt;&lt; value-2, value-1, address -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> n_save
      <span class="type">xx</span> <span class="keyword">end</span>

   define_primitive_function <span class="string">"n-save-byte"</span>, n_save_byte
      <span class="comment">;; &lt;&lt; value-n, ..., value-1, address, n -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">add</span> <span class="variable-name">rdx</span>, <span class="variable-name">rcx</span>
      <span class="builtin">dec</span> <span class="variable-name">rdx</span>
   <span class="function-name">.loop</span>:
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rdx</span>], <span class="variable-name">al</span>
      <span class="builtin">dec</span> <span class="variable-name">rdx</span>
      <span class="builtin">loop</span> .loop
      next

   define_primitive_function <span class="string">"add-save"</span>, add_save
      <span class="comment">;; ( number to add, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="type">qword</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub-save"</span>, sub_save
      <span class="comment">;; ( number to add, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="type">qword</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** fetch                              </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"fetch"</span>, fetch
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack  <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"fetch-byte"</span>, fetch_byte
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span>[<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"fetch-two-bytes"</span>, fetch_two_bytes
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">ax</span>, <span class="type">word</span> [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"fetch-four-bytes"</span>, fetch_four_bytes
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="type">dword</span> [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   <span class="comment">;;   in memory:
</span>   <span class="comment">;;     ||  1 : value-1  ||
</span>   <span class="comment">;;     ...
</span>   <span class="comment">;;     ||  1 : value-n  ||
</span>   define_primitive_function <span class="string">"n-fetch"</span>, n_fetch
      <span class="comment">;; &lt;&lt; address, n -- value-1, ..., value-n &gt;&gt;
</span>      pop_argument_stack  <span class="variable-name">rcx</span>
      pop_argument_stack  <span class="variable-name">rdx</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">qword</span> [<span class="variable-name">rdx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rdx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   define_primitive_function <span class="string">"n-fetch-byte"</span>, n_fetch_byte
      <span class="comment">;; &lt;&lt; address, n -- byte-1, ..., byte-n &gt;&gt;
</span>      pop_argument_stack  <span class="variable-name">rcx</span>
      pop_argument_stack  <span class="variable-name">rdx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span> [<span class="variable-name">rdx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rdx</span>
      <span class="builtin">loop</span> .loop
      next

   define_function <span class="string">"fetch2"</span>, fetch2
      <span class="comment">;; &lt;&lt; address -- value-1, value-2 &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> n_fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** save                               </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   <span class="comment">;; "save" and "fetch" default to a jo_size
</span>   <span class="comment">;; the rule of "fetch2" and so on are:
</span>   <span class="comment">;;   in memory:
</span>   <span class="comment">;;     ||  1 : value-1  ||
</span>   <span class="comment">;;     ||  1 : value-2  ||
</span>   <span class="comment">;;     ||  1 : value-3  ||
</span>   <span class="comment">;;     ...
</span>   <span class="comment">;;   on stack:
</span>   <span class="comment">;;     &lt;&lt; value-1, value-2, value-3, ... &gt;&gt;
</span>   <span class="comment">;; of course we have:
</span>   <span class="comment">;;   fetch2 : memory=copy=&gt;stack
</span>   <span class="comment">;;   save2  : stack-&gt;memory
</span>
   define_primitive_function <span class="string">"save"</span>, save
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"save-byte"</span>, save_byte
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">byte</span>[<span class="variable-name">rbx</span>], <span class="variable-name">al</span>
      next

   define_primitive_function <span class="string">"save-two-bytes"</span>, save_two_bytes
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">word</span> [<span class="variable-name">rbx</span>], <span class="variable-name">ax</span>
      next

   define_primitive_function <span class="string">"save-four-bytes"</span>, save_four_bytes
      <span class="comment">;; ( value, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">dword</span> [<span class="variable-name">rbx</span>], <span class="variable-name">eax</span>
      next

   define_primitive_function <span class="string">"n-save"</span>, n_save
      <span class="comment">;; &lt;&lt; value-n, ..., value-1, address, n -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
      <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
      <span class="builtin">add</span> <span class="variable-name">rdx</span>, <span class="variable-name">rax</span>
      <span class="comment">;; for address is based on 0
</span>      <span class="comment">;; but n is based on 1
</span>      <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
   <span class="function-name">.loop</span>:
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">dword</span> [<span class="variable-name">rdx</span>], <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="variable-name">rdx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   define_function <span class="string">"save2"</span>, save2
      <span class="comment">;; &lt;&lt; value-2, value-1, address -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> n_save
      <span class="type">xx</span> <span class="keyword">end</span>

   define_primitive_function <span class="string">"n-save-byte"</span>, n_save_byte
      <span class="comment">;; &lt;&lt; value-n, ..., value-1, address, n -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">add</span> <span class="variable-name">rdx</span>, <span class="variable-name">rcx</span>
      <span class="builtin">dec</span> <span class="variable-name">rdx</span>
   <span class="function-name">.loop</span>:
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rdx</span>], <span class="variable-name">al</span>
      <span class="builtin">dec</span> <span class="variable-name">rdx</span>
      <span class="builtin">loop</span> .loop
      next

   define_primitive_function <span class="string">"add-save"</span>, add_save
      <span class="comment">;; ( number to add, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="type">dword</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"sub-save"</span>, sub_save
      <span class="comment">;; ( number to add, address -- )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="type">dword</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** fetch                              </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"fetch"</span>, fetch
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack  <span class="variable-name">rbx</span>
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"fetch-byte"</span>, fetch_byte
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span>[<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"fetch-two-bytes"</span>, fetch_two_bytes
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">ax</span>, <span class="type">word</span> [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   define_primitive_function <span class="string">"fetch-four-bytes"</span>, fetch_four_bytes
      <span class="comment">;; ( address -- value )
</span>      pop_argument_stack <span class="variable-name">rbx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="variable-name">eax</span>, <span class="type">dword</span> [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      next

   <span class="comment">;;   in memory:
</span>   <span class="comment">;;     ||  1 : value-1  ||
</span>   <span class="comment">;;     ...
</span>   <span class="comment">;;     ||  1 : value-n  ||
</span>   define_primitive_function <span class="string">"n-fetch"</span>, n_fetch
      <span class="comment">;; &lt;&lt; address, n -- value-1, ..., value-n &gt;&gt;
</span>      pop_argument_stack  <span class="variable-name">rcx</span>
      pop_argument_stack  <span class="variable-name">rdx</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, <span class="type">dword</span> [<span class="variable-name">rdx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rdx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   define_primitive_function <span class="string">"n-fetch-byte"</span>, n_fetch_byte
      <span class="comment">;; &lt;&lt; address, n -- byte-1, ..., byte-n &gt;&gt;
</span>      pop_argument_stack  <span class="variable-name">rcx</span>
      pop_argument_stack  <span class="variable-name">rdx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span> [<span class="variable-name">rdx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">inc</span> <span class="variable-name">rdx</span>
      <span class="builtin">loop</span> .loop
      next

   define_function <span class="string">"fetch2"</span>, fetch2
      <span class="comment">;; &lt;&lt; address -- value-1, value-2 &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> n_fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** clear</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"clear-memory"</span>, clear_memory
      <span class="comment">;; &lt;&lt; size, address -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rdx</span>
      pop_argument_stack <span class="variable-name">rcx</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rdx</span>], <span class="variable-name">al</span>
      <span class="builtin">inc</span> <span class="variable-name">rdx</span>
      <span class="builtin">dec</span> <span class="variable-name">rcx</span>
      <span class="builtin">loop</span> .loop
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* basic io</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> byte</span>
   * basic io is about byte
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** write-byte                         </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   <span class="function-name">buffer$write_byte</span>:
      <span class="type">db</span> <span class="constant">0</span>

   define_primitive_function <span class="string">"write-byte"</span>, write_byte
      <span class="comment">;; &lt;&lt; byte -- &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="comment">;; write can not just write the char in al to stdout
</span>      <span class="comment">;; write needs the address of the byte to write
</span>      <span class="builtin">mov</span> [buffer$write_byte], <span class="variable-name">al</span>
      <span class="builtin">mov</span> linux64_sys_3_rdx, <span class="constant">1</span>                 <span class="comment">;; max length to be write
</span>      <span class="builtin">mov</span> linux64_sys_2_rsi, buffer$write_byte <span class="comment">;; address
</span>      <span class="builtin">mov</span> linux64_sys_1_rdi, <span class="constant">1</span>                 <span class="comment">;; stdout
</span>      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_write
      <span class="builtin">syscall</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** write-byte                         </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   <span class="function-name">buffer$write_byte</span>:
      <span class="type">db</span> <span class="constant">0</span>

   define_primitive_function <span class="string">"write-byte"</span>, write_byte
      <span class="comment">;; &lt;&lt; byte -- &gt;&gt;
</span>      <span class="comment">;; just calls the Linux write system call
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="comment">;; write can not just write the char in al to stdout
</span>      <span class="comment">;; write needs the address of the byte to write
</span>      <span class="builtin">mov</span> [buffer$write_byte], <span class="variable-name">al</span>
      <span class="builtin">mov</span> linux32_sys_3_edx, <span class="constant">1</span>                 <span class="comment">;; max length to be write
</span>      <span class="builtin">mov</span> linux32_sys_2_ecx, buffer$write_byte <span class="comment">;; address
</span>      <span class="builtin">mov</span> linux32_sys_1_ebx, <span class="constant">1</span>                 <span class="comment">;; stdout
</span>      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_write
      <span class="builtin">syscall</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * do not exit the program
     when meeting &lt;end-of-file&gt;
     so
     when you hit &lt;C-d&gt;
     some you will not exit the interpreter
   * add the feature to unread one ket-char
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> factoring</span>
   * reading from file of stdin is slow
     thus
     1. when reading from file
        a whole file is readed at a time
        and saved to a buffer
     2. when reading from stdin
        a whole line is readed at a time
     3. note that
        reading line instead of keyboard-code
        will limit the design of the user interface
   * by factoring out the low-level calls
     that read a line from stdin
     we are able to implement eval-string easily
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   max_input_length = <span class="constant">1024</span> * <span class="constant">1024</span>

   buffer$read_byte <span class="keyword">labeling</span>
      <span class="type">preserve</span> max_input_length
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-line-from-stdin               </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   define_primitive_function <span class="string">"read-line-from-stdin"</span>, read_line_from_stdin
      <span class="comment">;; &lt;&lt; buffer address, max length -- counter &gt;&gt;
</span>      pop_argument_stack linux64_sys_3_rdx
      pop_argument_stack linux64_sys_2_rsi
      <span class="builtin">xor</span> linux64_sys_1_rdi, linux64_sys_1_rdi <span class="comment">;; stdin
</span>      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_read
      <span class="builtin">syscall</span>
      <span class="comment">;; the return value
</span>      <span class="comment">;; is a count of the number of bytes transferred
</span>      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-line-from-stdin               </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   define_primitive_function <span class="string">"read-line-from-stdin"</span>, read_line_from_stdin
      <span class="comment">;; &lt;&lt; buffer address, max length -- counter &gt;&gt;
</span>      pop_argument_stack linux32_sys_3_edx
      pop_argument_stack linux32_sys_2_ecx
      <span class="builtin">xor</span> linux32_sys_1_ebx, linux32_sys_1_ebx <span class="comment">;; stdin
</span>      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_read
      <span class="builtin">syscall</span>
      <span class="comment">;; the return value
</span>      <span class="comment">;; is a count of the number of bytes transferred
</span>      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-done">test</span><span class="org-level-2"> read-line-from-stdin</span>
<span class="org-block-begin-line">   #+begin_src fasm
</span>   define_function <span class="string">""</span>, test__read_line_from_stdin
      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$read_byte
      <span class="type">xx</span> <span class="keyword">literal</span>, max_input_length
      <span class="type">xx</span> read_line_from_stdin
      <span class="type">xx</span> pretty_write_integer
      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$read_byte
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>
      <span class="type">xx</span> write_string
      <span class="type">xx</span> exit_with_TOS
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-byte</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"read-byte"</span>, read_byte
      <span class="comment">;; &lt;&lt; -- byte &gt;&gt;
</span>      <span class="type">xx</span> have_unreaded_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">9</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, char$unreaded_ket_char, fetch_byte
      <span class="type">xx</span>   zero, <span class="keyword">literal</span>, flag$unreaded_ket_char
      <span class="type">xx</span>   save
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> read_byte__without_unread
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"read-byte,without-unread"</span>, read_byte__without_unread
      <span class="comment">;; &lt;&lt; -- byte &gt;&gt;
</span>      <span class="type">xx</span> eval_string_stack_empty?, <span class="keyword">false?branch</span>, (.not_empty-$)/jo_size
      <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$read_byte
      <span class="type">xx</span>   <span class="keyword">literal</span>, max_input_length
      <span class="type">xx</span>   read_line_from_stdin
      <span class="type">xx</span>     <span class="keyword">dup</span>, positive?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="comment">;;     ignore &lt;end-of-file&gt;
</span>      <span class="comment">;;     ignore reading error
</span>      <span class="type">xx</span>     drop
      <span class="type">xx</span>     <span class="keyword">taca</span>, read_byte__without_unread
      <span class="type">xx</span>   push_eval_string_stack
      <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$read_byte
      <span class="type">xx</span>   push_eval_string_stack
      <span class="type">xx</span>   <span class="keyword">taca</span>, read_byte__without_unread
      <span class="function-name">.not_empty</span>:
      <span class="type">xx</span> pop_eval_string_stack
      <span class="type">xx</span> pop_eval_string_stack
      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   <span class="keyword">taca</span>, read_byte__without_unread
      <span class="type">xx</span> sub1, push_eval_string_stack
      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> add1, push_eval_string_stack
      <span class="type">xx</span> fetch_byte
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** unread-ket-char</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">flag$unreaded_ket_char</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   <span class="function-name">char$unreaded_ket_char</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"have-unreaded-ket-char?"</span>, have_unreaded_ket_char?
      <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, flag$unreaded_ket_char
      <span class="type">xx</span> fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"unread-ket-char"</span>, unread_ket_char
      <span class="comment">;; &lt;&lt; char -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, char$unreaded_ket_char, save
      <span class="type">xx</span> true, <span class="keyword">literal</span>, flag$unreaded_ket_char
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* eval-string</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * for we do not build border-check
     into the interface of pop and push
     we allocation some memory below the stacks
   * the size$eval_string_stack
     defines the max depth
     of nested call to eval string
   * cursor and border of a evaled string
     can be stored in eval_string_stack
     so
     when evaling a string
     the eval_string_stack will be
     &lt;&lt; counter, cursor &gt;&gt;
     when evaling is nested depth is 2
     &lt;&lt; counter, cursor, counter, cursor &gt;&gt;
   * interface to eval-string-stack
     <span class="org-table">| eval-string | push |</span>
     <span class="org-table">| read-byte   | pop  |</span>
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   size$eval_string_stack = <span class="constant">1024</span> * jo_size

      <span class="type">preserve</span> <span class="constant">64</span> * jo_size
   address$eval_string_stack <span class="keyword">labeling</span>
      <span class="type">preserve</span> size$eval_string_stack
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** pointer</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">pointer$eval_string_stack</span>:
      <span class="type">xx</span> address$eval_string_stack
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** push &amp; pop                         </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

    define_primitive_function <span class="string">"push-eval-string-stack"</span>, push_eval_string_stack
       <span class="comment">;; argument-stack -&gt; eval-string-stack
</span>       pop_argument_stack <span class="variable-name">rax</span>
       <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$eval_string_stack]
       <span class="builtin">mov</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
       <span class="builtin">add</span> <span class="type">qword</span> [pointer$eval_string_stack], jo_size
       next

    define_primitive_function <span class="string">"pop-eval-string-stack"</span>, pop_eval_string_stack
       <span class="comment">;; eval-string-stack -&gt; argument-stack
</span>       <span class="builtin">sub</span> <span class="type">qword</span> [pointer$eval_string_stack], jo_size
       <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$eval_string_stack]
       <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
       push_argument_stack <span class="variable-name">rax</span>
       next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** push &amp; pop                         </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

    define_primitive_function <span class="string">"push-eval-string-stack"</span>, push_eval_string_stack
       <span class="comment">;; argument-stack -&gt; eval-string-stack
</span>       pop_argument_stack <span class="variable-name">rax</span>
       <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [pointer$eval_string_stack]
       <span class="builtin">mov</span> [<span class="variable-name">rsi</span>], <span class="variable-name">rax</span>
       <span class="builtin">add</span> <span class="type">dword</span> [pointer$eval_string_stack], jo_size
       next

    define_primitive_function <span class="string">"pop-eval-string-stack"</span>, pop_eval_string_stack
       <span class="comment">;; eval-string-stack -&gt; argument-stack
</span>       <span class="builtin">sub</span> <span class="type">dword</span> [pointer$eval_string_stack], jo_size
       <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [pointer$eval_string_stack]
       <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rsi</span>]
       push_argument_stack <span class="variable-name">rax</span>
       next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** clear                              </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"clear-eval-string-stack"</span>, clear_eval_string_stack
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="type">qword</span> [pointer$eval_string_stack], address$eval_string_stack
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** clear                              </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"clear-eval-string-stack"</span>, clear_eval_string_stack
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">eax</span>, address$eval_string_stack
      <span class="builtin">mov</span> <span class="type">dword</span> [pointer$eval_string_stack], <span class="variable-name">eax</span><span class="comment">;address$eval_string_stack
</span>      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** empty?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"eval-string-stack-empty?"</span>, eval_string_stack_empty?
      <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$eval_string_stack]
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, address$eval_string_stack
      <span class="comment">;; less-than is treated as equal
</span>      <span class="builtin">setle</span> <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> nested call of eval-string</span>
   * nested call of eval-string is handled
     by using a eval_string_stack
     to remember the old string
   * but
     in my view
     meta-programming should NOT
     be achieved by editing string
   * note that
     this point of view
     is not conflict with my macro system
<span class="org-level-2">** eval-string,ready</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"eval-string,ready"</span>, eval_string__ready
      <span class="comment">;; &lt;&lt; string[address, length] -- unknown &gt;&gt;
</span>      <span class="type">xx</span> push_eval_string_stack
      <span class="type">xx</span> push_eval_string_stack
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* port</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** open-input-port                    </span><span class="org-level-2"><span class="org-tag">:linux:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   name_buffer$open_input_port <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">512</span>

   define_primitive_function <span class="string">"open-input-port"</span>, open_input_port
      <span class="comment">;; &lt;&lt; file-name-string[address, length] --
</span>      <span class="comment">;;    [file handle] or [error code] &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rsi</span>
      <span class="comment">;; copy file-name as a null-terminal string
</span>      <span class="builtin">mov</span> <span class="variable-name">rdi</span>, name_buffer$open_input_port
      <span class="builtin">rep</span> <span class="builtin">movsb</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rdi</span>], <span class="variable-name">al</span>
      <span class="builtin">mov</span> linux64_sys_2_rsi, <span class="constant">0</span> <span class="comment">;; OPEN__read_only
</span>      <span class="builtin">mov</span> linux64_sys_1_rdi, name_buffer$open_input_port
      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_open
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** close-port                         </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   define_primitive_function <span class="string">"close-port"</span>, close_port
      <span class="comment">;; &lt;&lt; file-handle -- &gt;&gt;
</span>      pop_argument_stack linux64_sys_1_rdi
      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_close
      <span class="builtin">syscall</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-port                          </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
   * from disk to memory
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   define_primitive_function <span class="string">"read-port"</span>, read_port
      <span class="comment">;; &lt;&lt; [file handle], buffer[address, length] --
</span>      <span class="comment">;;    [number of char] or [error code] &gt;&gt;
</span>      pop_argument_stack linux64_sys_3_rdx
      pop_argument_stack linux64_sys_2_rsi
      pop_argument_stack linux64_sys_1_rdi
      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_read
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** open-input-port                    </span><span class="org-level-2"><span class="org-tag">:linux:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   name_buffer$open_input_port <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">512</span>

   define_primitive_function <span class="string">"open-input-port"</span>, open_input_port
      <span class="comment">;; &lt;&lt; file-name-string[address, length] --
</span>      <span class="comment">;;    [file handle] or [error code] &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rsi</span>
      <span class="comment">;; copy file-name as a null-terminal string
</span>      <span class="builtin">mov</span> <span class="variable-name">rdi</span>, name_buffer$open_input_port
      <span class="builtin">rep</span> <span class="builtin">movsb</span>
      <span class="builtin">xor</span> <span class="variable-name">rax</span>, <span class="variable-name">rax</span>
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rdi</span>], <span class="variable-name">al</span>
      <span class="builtin">mov</span> linux32_sys_2_ecx, <span class="constant">0</span> <span class="comment">;; OPEN__read_only
</span>      <span class="builtin">mov</span> linux32_sys_1_ebx, name_buffer$open_input_port
      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_open
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** close-port                         </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   define_primitive_function <span class="string">"close-port"</span>, close_port
      <span class="comment">;; &lt;&lt; file-handle -- &gt;&gt;
</span>      pop_argument_stack linux32_sys_1_ebx
      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_close
      <span class="builtin">syscall</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-port                          </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
   * from disk to memory
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   define_primitive_function <span class="string">"read-port"</span>, read_port
      <span class="comment">;; &lt;&lt; [file handle], buffer[address, length] --
</span>      <span class="comment">;;    [number of char] or [error code] &gt;&gt;
</span>      pop_argument_stack linux32_sys_3_edx
      pop_argument_stack linux32_sys_2_ecx
      pop_argument_stack linux32_sys_1_ebx
      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_read
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* to load core file</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** path-file?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">address$path_file?</span>:
      <span class="type">db</span> <span class="constant">0</span>

   define_function <span class="string">"path-file?"</span>, path_file?
      <span class="comment">;; &lt;&lt; path[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> open_input_port
      <span class="type">xx</span> <span class="keyword">dup</span>, negative?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, address$path_file?
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>
      <span class="type">xx</span> read_port
      <span class="type">xx</span> swap, close_port
      <span class="type">xx</span> positive?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** load-first-file</span>
   * load-first-file can not be nested for now
   * a function (load-file) will be implemented in core
     to support nested loading
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   buffer$load_first_file <span class="keyword">labeling</span>
     <span class="type">preserve</span> <span class="constant">128</span> * <span class="constant">1024</span>

   define_function <span class="string">"load-first-file"</span>, load_first_file
      <span class="comment">;; &lt;&lt; name-string[address, length] -- unknown &gt;&gt;
</span>      <span class="type">xx</span> open_input_port
      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$load_first_file <span class="comment">;; buffer
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">1024</span> * <span class="constant">1024</span>      <span class="comment">;; length
</span>      <span class="type">xx</span>   read_port
      <span class="type">xx</span> swap, close_port
      <span class="type">xx</span> <span class="keyword">dup</span>, positive?, <span class="keyword">false?branch</span>, (.error-$)/jo_size
      <span class="type">xx</span>   <span class="keyword">literal</span>, buffer$load_first_file
      <span class="type">xx</span>   swap
      <span class="type">xx</span>   eval_string__ready
      <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="function-name">.error</span>:
      <span class="type">xx</span> error_report__load_first_file
      <span class="type">xx</span> write_integer
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"error-report,load-file"</span>, error_report__load_first_file
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$error_report__load_first_file
      <span class="type">xx</span> <span class="keyword">literal</span>, length$error_report__load_first_file
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$error_report__load_first_file</span>:
      <span class="type">db</span> <span class="string">"* (load-file) meets error  (read-port) error code : "</span>
   <span class="function-name">.end</span>:
   length$error_report__load_first_file = (.end - string$error_report__load_first_file)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> two directories</span>
   * all files about cicada
     are stored in two directories only
     1. user :
        "<span class="italic">/home/&lt;user&gt;/</span>.cicada"
     2. system :
        "/etc/cicada"
   * note that
     the convention of linux is not followed
     "/share" and "/include" are not used
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> linux system environment</span>
   * pid is the key to all the linux system environment
   * command-line
     /proc/&lt;pid&gt;/cmdline
   * environment-string-variable-list
     /proc/&lt;pid&gt;/environ
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** init-operating-system-environment  </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   define_function <span class="string">"init-operating-system-environment"</span>, init_operating_system_environment
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> init_pid
      <span class="type">xx</span> init_command_line
      <span class="type">xx</span> init_environment_string_variable_list
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** init-pid                           </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   define_primitive_function <span class="string">"init-pid"</span>, init_pid
      <span class="comment">;; &lt;&lt; -- pid &gt;&gt;
</span>      <span class="builtin">mov</span> linux64_sys_n_rax, linux64_syscall_getpid
      <span class="builtin">syscall</span>
      <span class="builtin">mov</span> [value$get_pid], <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** init-pid                           </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   define_primitive_function <span class="string">"init-pid"</span>, init_pid
      <span class="comment">;; &lt;&lt; -- pid &gt;&gt;
</span>      <span class="builtin">mov</span> linux32_sys_n_eax, linux32_syscall_getpid
      <span class="builtin">syscall</span>
      <span class="builtin">mov</span> [value$get_pid], <span class="variable-name">rax</span>
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** get-pid                            </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">value$get_pid</span>:
      <span class="type">xx</span> <span class="constant">2</span>

   define_function <span class="string">"get-pid"</span>, get_pid
      <span class="comment">;; &lt;&lt; -- pid &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, value$get_pid, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** [init|get]-command-line            </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">file$init_command_line</span>:
      <span class="type">db</span> <span class="string">"/cmdline"</span> <span class="comment">;; length of 8
</span>
   <span class="function-name">path$init_command_line</span>:
      <span class="type">db</span> <span class="string">"/proc/"</span>   <span class="comment">;; length of 6
</span>   <span class="function-name">pid$init_command_line</span>:
      <span class="type">db</span> <span class="string">"********************************"</span>

   <span class="function-name">address$init_command_line</span>:
      <span class="keyword">times</span> <span class="constant">512</span> <span class="type">db</span> <span class="constant">0</span>
   <span class="function-name">length$init_command_line</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"init-command-line"</span>, init_command_line
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> get_pid
      <span class="type">xx</span> write_nature_number__fill_buffer
      <span class="type">xx</span> tuck
      <span class="type">xx</span> <span class="keyword">literal</span>, pid$init_command_line
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">literal</span>, file$init_command_line
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">8</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, pid$init_command_line
      <span class="type">xx</span> xoverxxx, addition
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">literal</span>, path$init_command_line
      <span class="type">xx</span> swap
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">8</span>, addition
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">6</span>, addition
      <span class="type">xx</span> open_input_port
      <span class="type">xx</span> <span class="keyword">literal</span>, address$init_command_line
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">512</span>
      <span class="type">xx</span> read_port
      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_command_line
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"get-command-line"</span>, get_command_line
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, address$init_command_line
      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_command_line, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** [init|get]-environment-string-variable-list </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
   * the size of /proc/&lt;pid&gt;/environ is limited to 4k
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">file$init_environment_string_variable_list</span>:
      <span class="type">db</span> <span class="string">"/environ"</span> <span class="comment">;; length of 8
</span>
   <span class="function-name">path$init_environment_string_variable_list</span>:
      <span class="type">db</span> <span class="string">"/proc/"</span>   <span class="comment">;; length of 6
</span>   <span class="function-name">pid$init_environment_string_variable_list</span>:
      <span class="type">db</span> <span class="string">"********************************"</span>

   <span class="function-name">address$init_environment_string_variable_list</span>:
      <span class="keyword">times</span> (<span class="constant">4</span> * <span class="constant">1024</span>) <span class="type">db</span> <span class="constant">0</span>
   <span class="function-name">length$init_environment_string_variable_list</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"init-environment-string-variable-list"</span>, init_environment_string_variable_list
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> get_pid
      <span class="type">xx</span> write_nature_number__fill_buffer
      <span class="type">xx</span> tuck
      <span class="type">xx</span> <span class="keyword">literal</span>, pid$init_environment_string_variable_list
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">literal</span>, file$init_environment_string_variable_list
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">8</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, pid$init_environment_string_variable_list
      <span class="type">xx</span> xoverxxx, addition
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">literal</span>, path$init_environment_string_variable_list
      <span class="type">xx</span> swap
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">8</span>, addition
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">6</span>, addition
      <span class="type">xx</span> open_input_port
      <span class="type">xx</span> <span class="keyword">literal</span>, address$init_environment_string_variable_list
      <span class="type">xx</span> <span class="keyword">literal</span>, (<span class="constant">4</span> * <span class="constant">1024</span>)
      <span class="type">xx</span> read_port
      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_environment_string_variable_list
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"get-environment-string-variable-list"</span>, get_environment_string_variable_list
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, address$init_environment_string_variable_list
      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_environment_string_variable_list, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** find-environment-string-variable   </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
   * the string used to find an environment-string-variable
     can not contain "="
     no error handling on this
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   define_function <span class="string">"find-environment-string-variable"</span>, find_environment_string_variable
      <span class="comment">;; &lt;&lt; string[address, length]
</span>      <span class="comment">;;    -- string[address, length], true
</span>      <span class="comment">;;    -- false &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, address$init_environment_string_variable_list <span class="comment">;; cursor
</span>      <span class="type">xx</span> find_environment_string_variable__loop
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"find-environment-string-variable,loop"</span>, find_environment_string_variable__loop
      <span class="comment">;; &lt;&lt; string[address, length], cursor
</span>      <span class="comment">;;    -- string[address, length], true
</span>      <span class="comment">;;    -- false &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, address$init_environment_string_variable_list
      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_environment_string_variable_list, fetch
      <span class="type">xx</span> addition
      <span class="type">xx</span> greater_than?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop, drop2
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> xxoverx, xoverxx, swap
      <span class="type">xx</span> compare_buffer, false?, <span class="keyword">false?branch</span>, <span class="constant">7</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
      <span class="type">xx</span>   cursor_to_next_matching_byte
      <span class="type">xx</span>   add1
      <span class="type">xx</span>   <span class="keyword">taca</span>, find_environment_string_variable__loop
      <span class="type">xx</span> <span class="keyword">dup</span>, xoverxx, addition, fetch_byte
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'='</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">7</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
      <span class="type">xx</span>   cursor_to_next_matching_byte
      <span class="type">xx</span>   add1
      <span class="type">xx</span>   <span class="keyword">taca</span>, find_environment_string_variable__loop
      <span class="type">xx</span> xswapxx, drop
      <span class="type">xx</span> addition, add1
      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>
      <span class="type">xx</span> cursor_to_next_matching_byte
      <span class="type">xx</span> over, subtraction
      <span class="type">xx</span> true
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** [init|get]-path,home-directory     </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
   * need error handling
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">string$init_path__home_directory</span>:
      <span class="type">db</span> <span class="string">"HOME"</span>

   define_function <span class="string">"init-path,home-directory"</span>, init_path__home_directory
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$init_path__home_directory
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">4</span>
      <span class="type">xx</span> find_environment_string_variable
      <span class="type">xx</span> drop
      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__home_directory
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__home_directory
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$get_path__home_directory</span>:
      <span class="keyword">times</span> <span class="constant">512</span> <span class="type">db</span> <span class="constant">0</span>
   <span class="function-name">length$get_path__home_directory</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"get-path,home-directory"</span>, get_path__home_directory
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__home_directory
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__home_directory, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** [init|get]-path,working-directory  </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
   * need error handling
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">string$init_path__working_directory</span>:
      <span class="type">db</span> <span class="string">"PWD"</span>

   define_function <span class="string">"init-path,working-directory"</span>, init_path__working_directory
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$init_path__working_directory
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">3</span>
      <span class="type">xx</span> find_environment_string_variable
      <span class="type">xx</span> drop
      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__working_directory
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__working_directory
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$get_path__working_directory</span>:
      <span class="keyword">times</span> <span class="constant">512</span> <span class="type">db</span> <span class="constant">0</span>
   <span class="function-name">length$get_path__working_directory</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"get-path,working-directory"</span>, get_path__working_directory
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__working_directory
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__working_directory, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** [init|get]-path,user-core-file     </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">string$init_path__user_core_file</span>:
      <span class="type">db</span> <span class="string">"/.cicada/core.cn"</span>
   <span class="function-name">.end</span>:
   length$init_path__user_core_file = (.end - string$init_path__user_core_file)


   define_function <span class="string">"init-path,user-core-file"</span>, init_path__user_core_file
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> get_path__home_directory
      <span class="type">xx</span> tuck
      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__user_core_file
      <span class="type">xx</span> string_to_buffer!

      <span class="type">xx</span> <span class="keyword">literal</span>, string$init_path__user_core_file
      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_path__user_core_file
      <span class="type">xx</span> xoverxx
      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__user_core_file
      <span class="type">xx</span> addition
      <span class="type">xx</span> string_to_buffer!

      <span class="type">xx</span> <span class="keyword">literal</span>, length$init_path__user_core_file
      <span class="type">xx</span> addition
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__user_core_file
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$get_path__user_core_file</span>:
      <span class="keyword">times</span> <span class="constant">510</span> <span class="type">db</span> <span class="constant">0</span>

   <span class="function-name">length$get_path__user_core_file</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"get-path,user-core-file"</span>, get_path__user_core_file
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__user_core_file
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__user_core_file, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** get-path,system-core-file          </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">string$get_path__system_core_file</span>:
      <span class="type">db</span> <span class="string">"/etc/cicada/core.cn"</span>
   <span class="function-name">.end</span>:
   length$get_path__system_core_file = (.end - string$get_path__system_core_file)

   define_function <span class="string">"get-path,system-core-file"</span>, get_path__system_core_file
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__system_core_file
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__system_core_file
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** get-path,loaded-core-file          </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="function-name">string$get_path__loaded_core_file</span>:
      <span class="keyword">times</span> <span class="constant">510</span> <span class="type">db</span> <span class="constant">0</span>

   <span class="function-name">length$get_path__loaded_core_file</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"get-path,loaded-core-file"</span>, get_path__loaded_core_file
      <span class="comment">;; &lt;&lt; -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$get_path__loaded_core_file
      <span class="type">xx</span> <span class="keyword">literal</span>, length$get_path__loaded_core_file, fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** load-core-file                     </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   define_function <span class="string">"load-core-file"</span>, load_core_file
      <span class="comment">;; &lt;&lt; unknown -- unknown &gt;&gt;
</span>      <span class="type">xx</span> get_path__user_core_file, path_file?, <span class="keyword">false?branch</span>, (.fail_user_core_file-$)/jo_size
      <span class="type">xx</span>   get_path__user_core_file
      <span class="type">xx</span>   <span class="keyword">dup</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, length$get_path__loaded_core_file
      <span class="type">xx</span>   save
      <span class="type">xx</span>   <span class="keyword">literal</span>, string$get_path__loaded_core_file
      <span class="type">xx</span>   string_to_buffer!
      <span class="type">xx</span>   get_path__user_core_file, load_first_file
      <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="function-name">.fail_user_core_file</span>:

      <span class="type">xx</span> get_path__system_core_file, path_file?, <span class="keyword">false?branch</span>, (.fail_system_core_file-$)/jo_size
      <span class="type">xx</span>   get_path__system_core_file
      <span class="type">xx</span>   <span class="keyword">dup</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, length$get_path__loaded_core_file
      <span class="type">xx</span>   save
      <span class="type">xx</span>   <span class="keyword">literal</span>, string$get_path__loaded_core_file
      <span class="type">xx</span>   string_to_buffer!
      <span class="type">xx</span>   get_path__system_core_file, load_first_file
      <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="function-name">.fail_system_core_file</span>:

      <span class="type">xx</span> <span class="keyword">literal</span>, string$load_core_file__report_1
      <span class="type">xx</span> <span class="keyword">literal</span>, length$load_core_file__report_1
      <span class="type">xx</span> write_string
      <span class="type">xx</span> get_path__user_core_file, write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, string$load_core_file__report_2
      <span class="type">xx</span> <span class="keyword">literal</span>, length$load_core_file__report_2
      <span class="type">xx</span> write_string
      <span class="type">xx</span> get_path__system_core_file, write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, string$load_core_file__report_3
      <span class="type">xx</span> <span class="keyword">literal</span>, length$load_core_file__report_3
      <span class="type">xx</span> write_string

      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$load_core_file__report_1</span>:
      <span class="type">db</span> <span class="string">"* (load-core-file)"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"  * no core file is loaded"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"  * when cicada-nymph is started"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    first"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    it trys to load the user's core file from :"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"       "</span>
   <span class="function-name">.end</span>:
   length$load_core_file__report_1 = (.end - string$load_core_file__report_1)

   <span class="function-name">string$load_core_file__report_2</span>:
      <span class="type">db</span> <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    if it fails"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    then"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    it trys to load the system core file from :"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"       "</span>
   <span class="function-name">.end</span>:
   length$load_core_file__report_2 = (.end - string$load_core_file__report_2)

   <span class="function-name">string$load_core_file__report_3</span>:
      <span class="type">db</span> <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    if it fails"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"    no core file is loaded"</span>, <span class="constant">10</span>
      <span class="type">db</span> <span class="string">"  * now you are running cicada-nymph without core"</span>, <span class="constant">10</span>
   <span class="function-name">.end</span>:
   length$load_core_file__report_3 = (.end - string$load_core_file__report_3)

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* to expose syscall</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * there are two ways to treat the syscall
     1. syscall is NOT expose to cicada-nymph
        system functions are wraped in assembly code
        thus
        make cicada-nymph code be more clean
     2. syscall is expose to cicada-nymph
        system functions are wraped in cicada-nymph code
        thus
        more easy to wraped more system functions
        and
        make assembly code be more clean
        [only needs some system functions to load core file]
   * I choose the second way for now
<span class="org-level-2">** string-&gt;syscall-string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">string$string_to_syscall_string</span>:
      <span class="keyword">times</span> <span class="constant">256</span> <span class="type">db</span> <span class="constant">0</span>

   define_function <span class="string">"string-&gt;syscall-string"</span>, string_to_syscall_string
      <span class="comment">;; &lt;&lt; string[address, length] -- syscall-string[address] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, string$string_to_syscall_string
      <span class="type">xx</span>   addition
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">0</span>
      <span class="type">xx</span>   swap, save_byte
      <span class="type">xx</span> <span class="keyword">literal</span>, string$string_to_syscall_string
      <span class="type">xx</span> string_to_buffer!
      <span class="type">xx</span> <span class="keyword">literal</span>, string$string_to_syscall_string
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** syscall                            </span><span class="org-level-2"><span class="org-tag">:64bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =64bit, platform machine {

   define_primitive_function <span class="string">"syscall"</span>, __syscall
      <span class="comment">;; &lt;&lt; ..., argument2, argument1,
</span>      <span class="comment">;;    syscall-number,
</span>      <span class="comment">;;    number-of-arguments
</span>      <span class="comment">;;    -- return-value &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">0</span>
      <span class="builtin">je</span> __syscall_with_0
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">1</span>
      <span class="builtin">je</span> __syscall_with_1
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">2</span>
      <span class="builtin">je</span> __syscall_with_2
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">3</span>
      <span class="builtin">je</span> __syscall_with_3
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">4</span>
      <span class="builtin">je</span> __syscall_with_4
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">5</span>
      <span class="builtin">je</span> __syscall_with_5
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">6</span>
      <span class="builtin">je</span> __syscall_with_6
      <span class="builtin">jmp</span> __syscall_with_too_many

   __syscall_with_0:
      pop_argument_stack linux64_sys_n_rax
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_1:
      pop_argument_stack linux64_sys_n_rax
      pop_argument_stack linux64_sys_1_rdi
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_2:
      pop_argument_stack linux64_sys_n_rax
      pop_argument_stack linux64_sys_1_rdi
      pop_argument_stack linux64_sys_2_rsi
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_3:
      pop_argument_stack linux64_sys_n_rax
      pop_argument_stack linux64_sys_1_rdi
      pop_argument_stack linux64_sys_2_rsi
      pop_argument_stack linux64_sys_3_rdx
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_4:
      pop_argument_stack linux64_sys_n_rax
      pop_argument_stack linux64_sys_1_rdi
      pop_argument_stack linux64_sys_2_rsi
      pop_argument_stack linux64_sys_3_rdx
      pop_argument_stack linux64_sys_4_r10
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_5:
      pop_argument_stack linux64_sys_n_rax
      pop_argument_stack linux64_sys_1_rdi
      pop_argument_stack linux64_sys_2_rsi
      pop_argument_stack linux64_sys_3_rdx
      pop_argument_stack linux64_sys_4_r10
      pop_argument_stack linux64_sys_5_r9
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_6:
      pop_argument_stack linux64_sys_n_rax
      pop_argument_stack linux64_sys_1_rdi
      pop_argument_stack linux64_sys_2_rsi
      pop_argument_stack linux64_sys_3_rdx
      pop_argument_stack linux64_sys_4_r10
      pop_argument_stack linux64_sys_5_r9
      pop_argument_stack linux64_sys_6_r8
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_too_many:
      <span class="builtin">call</span> __exit_with_six

   <span class="rainbow-delimiters-depth-1">}</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** syscall                            </span><span class="org-level-2"><span class="org-tag">:32bit:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux =32bit, platform machine {

   define_primitive_function <span class="string">"syscall"</span>, __syscall
      <span class="comment">;; &lt;&lt; ..., argument2, argument1,
</span>      <span class="comment">;;    syscall-number,
</span>      <span class="comment">;;    number-of-arguments
</span>      <span class="comment">;;    -- return-value &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">0</span>
      <span class="builtin">je</span> __syscall_with_0
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">1</span>
      <span class="builtin">je</span> __syscall_with_1
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">2</span>
      <span class="builtin">je</span> __syscall_with_2
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">3</span>
      <span class="builtin">je</span> __syscall_with_3
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">4</span>
      <span class="builtin">je</span> __syscall_with_4
      <span class="builtin">cmp</span> <span class="variable-name">rax</span>, <span class="constant">5</span>
      <span class="builtin">je</span> __syscall_with_5
      <span class="builtin">jmp</span> __syscall_with_too_many

   __syscall_with_0:
      pop_argument_stack linux32_sys_n_eax
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_1:
      pop_argument_stack linux32_sys_n_eax
      pop_argument_stack linux32_sys_1_ebx
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_2:
      pop_argument_stack linux32_sys_n_eax
      pop_argument_stack linux32_sys_1_ebx
      pop_argument_stack linux32_sys_2_ecx
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_3:
      pop_argument_stack linux32_sys_n_eax
      pop_argument_stack linux32_sys_1_ebx
      pop_argument_stack linux32_sys_2_ecx
      pop_argument_stack linux32_sys_3_edx
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_4:
      pop_argument_stack linux32_sys_n_eax
      pop_argument_stack linux32_sys_1_ebx
      pop_argument_stack linux32_sys_2_ecx
      pop_argument_stack linux32_sys_3_edx
      pop_argument_stack linux32_sys_4_esi
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_5:
      pop_argument_stack linux32_sys_n_eax
      pop_argument_stack linux32_sys_1_ebx
      pop_argument_stack linux32_sys_2_ecx
      pop_argument_stack linux32_sys_3_edx
      pop_argument_stack linux32_sys_4_esi
      pop_argument_stack linux32_sys_5_edi
      <span class="builtin">syscall</span>
      push_argument_stack <span class="variable-name">rax</span>
      next

   __syscall_with_too_many:
      <span class="builtin">call</span> __exit_with_six

   <span class="rainbow-delimiters-depth-1">}</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* initialization</span>
<span class="org-level-2">** initialization</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"initialization"</span>, initialization
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> initialize_dispatch_word_stack
      <span class="type">xx</span> initialize_local_variable
   <span class="preprocessor">match</span> =linux, platform {
      <span class="type">xx</span> initialize_system
      }
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** initialize-system                  </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   define_function <span class="string">"initialize-system"</span>, initialize_system
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> init_operating_system_environment
      <span class="type">xx</span> init_path__home_directory
      <span class="type">xx</span> init_path__user_core_file
      <span class="type">xx</span> init_path__working_directory
      <span class="type">xx</span> <span class="keyword">end</span>

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* char</span>
<span class="org-level-2">** space-char?</span>
   * as for space-char
     I only use two
     ASCII 10 (newline)
     ASCII 32 (whitespace)
   * note that
     I use the term "whitespace" to denotes the char
     I use the term "space" to denotes the set of chars
   * I will simply view number less-or-equal 32 as space-char
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"space-char?"</span>, space_char?
      <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">32</span>
      <span class="type">xx</span> less_or_equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** bar-ket-char?</span>
   * () [] {}
     but not &lt;&gt;
   * double-quote is viewed as special bar-ket-char
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"bar-ket-char?"</span>, bar_ket_char?
      <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'('</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">')'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'['</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">']'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'{'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'}'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'"'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> drop, false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** decimal-digital-char?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"digital-char?"</span>, decimal_digital_char?
      <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'0'</span>, less_than?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'9'</span>, less_or_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> drop, false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** latin-char?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"latin-char?"</span>, latin_char?
      <span class="comment">;; &lt;&lt; char -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'A'</span>, less_than?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'Z'</span>, less_or_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'a'</span>, less_than?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="default">'z'</span>, less_or_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> drop, false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> digital</span>
   * a decimal-digital is number from 0 to 9
   * a binary-digital is number from 0 to 1
<span class="org-level-2">** char-&gt;decimal-digital &amp; decimal-digital-&gt;char</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"char-&gt;decimal-digital"</span>, char_to_decimal_digital
      <span class="comment">;; &lt;&lt; char -- decimal-digital &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'0'</span>
      <span class="type">xx</span> subtraction
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"decimal-digital-&gt;char"</span>, decimal_digital_to_char
      <span class="comment">;; &lt;&lt; decimal-digital -- char &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'0'</span>
      <span class="type">xx</span> addition
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* buffer</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * a buffer is a large vector
     and some functions do not care about how large it is
<span class="org-level-2">** compare-buffer</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="comment">;; return false when length == 0
</span>   define_primitive_function <span class="string">"compare-buffer"</span>, compare_buffer
      <span class="comment">;; &lt;&lt; address, address, length -- bool &gt;&gt;
</span>      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdi</span>
      pop_argument_stack <span class="variable-name">rsi</span>
      <span class="builtin">repe</span> <span class="builtin">cmpsb</span>
      <span class="builtin">sete</span> <span class="variable-name">al</span>
      <span class="builtin">movzx</span> <span class="variable-name">rax</span>, <span class="variable-name">al</span>
      push_argument_stack <span class="variable-name">rax</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** cursor-&gt;next-matching-byte</span>
   * note that
     it is the NEXT matching-byte
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"cursor-&gt;next-matching-byte"</span>, cursor_to_next_matching_byte
      <span class="comment">;; &lt;&lt; cursor, byte -- cursor new address &gt;&gt;
</span>      <span class="type">xx</span> over, add1, fetch_byte
      <span class="type">xx</span> over, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop, add1
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> swap
      <span class="type">xx</span> add1, swap
      <span class="type">xx</span> <span class="keyword">taca</span>, cursor_to_next_matching_byte
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* string</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> io about string</span>
<span class="org-level-2">** write-string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"write-string"</span>, write_string
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> sub1, swap
      <span class="type">xx</span> <span class="keyword">dup</span>, fetch_byte, write_byte
      <span class="type">xx</span> add1, swap
      <span class="type">xx</span> <span class="keyword">taca</span>, write_string
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** pretty_write_string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">".s"</span>, pretty_write_string
      <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>
      <span class="type">xx</span> write_byte
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** string-equal?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"string-equal?"</span>, string_equal?
      <span class="comment">;; &lt;&lt; string[address, length], string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> xoverxx, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   swap
      <span class="type">xx</span>   compare_buffer
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> drop, drop2
      <span class="type">xx</span> false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-[head|tail],char</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"string-head,char"</span>, string_head__char
      <span class="comment">;; &lt;&lt; string[address, length] -- char &gt;&gt;
</span>      <span class="type">xx</span> drop, fetch_byte
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"string-tail,char"</span>, string_tail__char
      <span class="comment">;; &lt;&lt; string[address, length] -- [address + 1, length + 1] &gt;&gt;
</span>      <span class="type">xx</span> sub1, swap
      <span class="type">xx</span> add1
      <span class="type">xx</span> swap
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-&gt;buffer!</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_primitive_function <span class="string">"string-&gt;buffer!"</span>, string_to_buffer!
      <span class="comment">;; ( string[address, length], buffer[address] -- )
</span>      pop_argument_stack <span class="variable-name">rdi</span> <span class="comment">;; destination
</span>      pop_argument_stack <span class="variable-name">rcx</span> <span class="comment">;; counter
</span>      pop_argument_stack <span class="variable-name">rsi</span> <span class="comment">;; source
</span>      <span class="builtin">rep</span> <span class="builtin">movsb</span>
      next
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-reverse!                    </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   buffer$string_reverse! <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">1024</span>


   define_primitive_function <span class="string">"string-reverse!"</span>, string_reverse!
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rdi</span>, buffer$string_reverse!
      <span class="builtin">mov</span> <span class="variable-name">rcx</span>, [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [pointer$argument_stack - (<span class="constant">2</span> * jo_size)]
      <span class="builtin">rep</span> <span class="builtin">movsb</span>

      <span class="builtin">mov</span> <span class="variable-name">rcx</span>, [pointer$argument_stack - (<span class="constant">1</span> * jo_size)]
      <span class="builtin">dec</span> <span class="variable-name">rdi</span> <span class="comment">;; cursor back into string in buffer$string_reverse!
</span>      <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [pointer$argument_stack - (<span class="constant">2</span> * jo_size)]
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span> [<span class="variable-name">rdi</span>]
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rsi</span>], <span class="variable-name">al</span>
      <span class="builtin">dec</span> <span class="variable-name">rdi</span>
      <span class="builtin">inc</span> <span class="variable-name">rsi</span>
      <span class="builtin">loop</span> .loop

      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-reverse!                    </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   buffer$string_reverse! <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">1024</span>


   define_primitive_function <span class="string">"string-reverse!"</span>, string_reverse!
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$argument_stack]
      <span class="builtin">mov</span> <span class="variable-name">rdi</span>, buffer$string_reverse!
      <span class="builtin">mov</span> <span class="variable-name">rcx</span>, [<span class="variable-name">rbx</span> - (<span class="constant">1</span> * jo_size)]
      <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [<span class="variable-name">rbx</span> - (<span class="constant">2</span> * jo_size)]
      <span class="builtin">rep</span> <span class="builtin">movsb</span>

      <span class="builtin">mov</span> <span class="variable-name">rcx</span>, [<span class="variable-name">rbx</span> - (<span class="constant">1</span> * jo_size)]
      <span class="builtin">dec</span> <span class="variable-name">rdi</span> <span class="comment">;; cursor back into string in buffer$string_reverse!
</span>      <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [<span class="variable-name">rbx</span> - (<span class="constant">2</span> * jo_size)]
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">al</span>, <span class="type">byte</span> [<span class="variable-name">rdi</span>]
      <span class="builtin">mov</span> <span class="type">byte</span> [<span class="variable-name">rsi</span>], <span class="variable-name">al</span>
      <span class="builtin">dec</span> <span class="variable-name">rdi</span>
      <span class="builtin">inc</span> <span class="variable-name">rsi</span>
      <span class="builtin">loop</span> .loop

      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** digital-string?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"digital-string?"</span>, digital_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> over, fetch_byte, decimal_digital_char?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   string_tail__char
      <span class="type">xx</span>   <span class="keyword">taca</span>, digital_string?
      <span class="type">xx</span> drop2, false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** char-string?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"char-string?"</span>, char_string?
      <span class="comment">;; &lt;&lt; string[address, length], char -- bool &gt;&gt;
</span>      <span class="type">xx</span> xxswapx
      <span class="type">xx</span> <span class="keyword">dup</span>, one?, false?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop2, drop
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_head__char, equal?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** zero-string?</span>
   * "0" or "-0"
     0 is special when compiling literal number
     for we are using 0 as "end"
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"zero-string?"</span>, zero_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> dup2, <span class="keyword">literal</span>, <span class="default">'0'</span>, char_string?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2
      <span class="type">xx</span> string_head__char, <span class="keyword">literal</span>, <span class="default">'-'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_tail__char, <span class="keyword">literal</span>, <span class="default">'0'</span>, char_string?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** integer-string?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"integer-string?"</span>, integer_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, <span class="keyword">literal</span>, <span class="default">'-'</span>, char_string?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char, <span class="keyword">literal</span>, <span class="default">'-'</span>, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   string_tail__char
      <span class="type">xx</span>   digital_string?
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> digital_string?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-&gt;integer</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"string-&gt;integer"</span>, string_to_integer
      <span class="comment">;; &lt;&lt; string[address, length] -- integer &gt;&gt;
</span>      <span class="type">xx</span> dup2, string_head__char, <span class="keyword">literal</span>, <span class="default">'-'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   digital_string_to_integer
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> digital_string_to_integer
      <span class="type">xx</span> negate
      <span class="type">xx</span> <span class="keyword">end</span>


   <span class="function-name">sum$digital_string_to_integer</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   <span class="function-name">counter$digital_string_to_integer</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"digital-string-&gt;integer"</span>, digital_string_to_integer
      <span class="comment">;; &lt;&lt; string[address, length] -- integer &gt;&gt;
</span>      <span class="type">xx</span> zero, <span class="keyword">literal</span>, sum$digital_string_to_integer, save
      <span class="type">xx</span> zero, <span class="keyword">literal</span>, counter$digital_string_to_integer, save

      <span class="type">xx</span> dup2, string_reverse!
      <span class="type">xx</span>   help__digital_string_to_integer
      <span class="type">xx</span> string_reverse!, drop2

      <span class="type">xx</span> <span class="keyword">literal</span>, sum$digital_string_to_integer
      <span class="type">xx</span> fetch
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"help,digital-string-&gt;integer"</span>, help__digital_string_to_integer
      <span class="comment">;; &lt;&lt; reversed-string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="type">xx</span> dup2, string_head__char, char_to_decimal_digital
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">10</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, counter$digital_string_to_integer, fetch
      <span class="type">xx</span>     one
      <span class="type">xx</span>     <span class="keyword">literal</span>, counter$digital_string_to_integer
      <span class="type">xx</span>     add_save
      <span class="type">xx</span>   power
      <span class="type">xx</span> multiple

      <span class="type">xx</span> <span class="keyword">literal</span>, sum$digital_string_to_integer
      <span class="type">xx</span> add_save

      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> <span class="keyword">taca</span>, help__digital_string_to_integer
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** find-char,string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"find-char,string"</span>, find_char__string
     <span class="comment">;; &lt;&lt; found:
</span>     <span class="comment">;;      string[address, length], char -- address, true &gt;&gt;
</span>     <span class="comment">;; &lt;&lt; not found:
</span>     <span class="comment">;;      string[address, length], char -- false &gt;&gt;
</span>     <span class="type">xx</span> over, zero?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
     <span class="type">xx</span>   drop, drop2
     <span class="type">xx</span>   false
     <span class="type">xx</span>   <span class="keyword">end</span>
     <span class="type">xx</span> xoverxx, fetch_byte
     <span class="type">xx</span> over, equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
     <span class="type">xx</span>   drop2
     <span class="type">xx</span>   true
     <span class="type">xx</span>   <span class="keyword">end</span>
     <span class="type">xx</span> xxswapx
     <span class="type">xx</span> string_tail__char
     <span class="type">xx</span> xswapxx
     <span class="type">xx</span> <span class="keyword">taca</span>, find_char__string
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-done">test</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">XIE</span> Yuheng <span class="cicada-nymph-sentence-reader">;</span>
   <span class="cicada-nymph-number">32</span> find-char,string . <span class="cicada-nymph-comment">&lt;&lt; 1 &gt;&gt;</span>
   fetch-byte . <span class="cicada-nymph-comment">&lt;&lt; 32 &gt;&gt;</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* io about number</span>
<span class="org-level-2">** write-nature-number</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="comment">;; 2 ^ 64 = 18446744073709551616
</span>   <span class="comment">;; which is of length 20
</span>   <span class="comment">;; so
</span>   <span class="comment">;; I use 32 to align to 16
</span>
   buffer$write_nature_number <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">32</span>

   <span class="function-name">counter$write_nature_number</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"write-nature-number"</span>, write_nature_number
      <span class="comment">;; &lt;&lt; nature-number -- &gt;&gt;
</span>      <span class="type">xx</span> write_nature_number__fill_buffer
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"write-nature-number,fill-buffer"</span>, write_nature_number__fill_buffer
      <span class="comment">;; &lt;&lt; nature-number -- &gt;&gt;
</span>      <span class="type">xx</span> zero
      <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_nature_number, save

      <span class="type">xx</span> write_nature_number__loop

      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$write_nature_number
      <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_nature_number, fetch
      <span class="type">xx</span> string_reverse!
      <span class="type">xx</span> <span class="keyword">end</span>


   define_function <span class="string">"write-nature-number,loop"</span>, write_nature_number__loop
      <span class="comment">;; &lt;&lt; rest-number -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, divmod

      <span class="type">xx</span> decimal_digital_to_char
      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$write_nature_number
      <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_nature_number, fetch
      <span class="type">xx</span> addition
      <span class="type">xx</span> save_byte

      <span class="type">xx</span> one
      <span class="type">xx</span> <span class="keyword">literal</span>, counter$write_nature_number
      <span class="type">xx</span> add_save

      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   drop
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">taca</span>, write_nature_number__loop
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** write-integer</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"write-integer"</span>, write_integer
      <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, positive?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   write_nature_number
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'-'</span>, write_byte
      <span class="type">xx</span> negate
      <span class="type">xx</span> write_nature_number
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** pretty_write_integer</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"."</span>, pretty_write_integer
      <span class="comment">;; &lt;&lt; integer -- &gt;&gt;
</span>      <span class="type">xx</span> write_integer
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">32</span>
      <span class="type">xx</span> write_byte
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* word</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> io about word</span>
   * words are separated by spaces
   * a bar-ket is a word
     even when there are no spaces around it
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   max_word_length = <span class="constant">1024</span>

   buffer$read_word <span class="keyword">labeling</span>
      <span class="type">preserve</span> max_word_length

   buffer$read_word_for_REPL <span class="keyword">labeling</span>
      <span class="type">preserve</span> max_word_length
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-word-begin-char</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"read-word-begin-char"</span>, read_word_begin_char
      <span class="comment">;; &lt;&lt; -- non-blank-char &gt;&gt;
</span>      <span class="type">xx</span> read_byte
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">32</span> <span class="comment">;; ascii.space
</span>      <span class="type">xx</span> greater_than?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> drop
      <span class="type">xx</span> <span class="keyword">taca</span>, read_word_begin_char
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-word-&gt;buffer</span>
   1. skip any space-char (whitespace newline)
   2. call read_char to read characters into buffer
      until it hits a blank
   3. return the address of buffer and length to argument_stack
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"read-word-&gt;buffer"</span>, read_word_to_buffer
      <span class="comment">;; &lt;&lt; buffer -- word[address, length] &gt;&gt;
</span>      <span class="type">xx</span> read_word_begin_char
      <span class="comment">;; no metter what the begin char is
</span>      <span class="comment">;; save it into buffer
</span>      <span class="type">xx</span> dup2, swap, save_byte
      <span class="type">xx</span> swap, add1, swap
      <span class="type">xx</span> one, swap <span class="comment">;; leave length counter
</span>      <span class="comment">;; &lt;&lt; cursor[address in buffer], counter, begin char &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, bar_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop
      <span class="type">xx</span>   help__read_word_to_buffer__bar_ket
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="comment">;; maybe add other type of chars
</span>      <span class="type">xx</span> drop
      <span class="type">xx</span> help__read_word_to_buffer__regular
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"help,read-word-&gt;buffer,bar-ket"</span>, help__read_word_to_buffer__bar_ket
      <span class="comment">;; &lt;&lt; cursor[address in buffer], counter -- word[address, length] &gt;&gt;
</span>      <span class="type">xx</span> tuck, subtraction
      <span class="type">xx</span> swap
      <span class="type">xx</span> <span class="keyword">end</span>


   define_function <span class="string">"help,read-word-&gt;buffer,regular"</span>, help__read_word_to_buffer__regular
      <span class="comment">;; &lt;&lt; cursor[address in buffer], counter -- word[address, length] &gt;&gt;
</span>      <span class="type">xx</span> read_byte
      <span class="type">xx</span> <span class="keyword">dup</span>, bar_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">6</span>
      <span class="type">xx</span>   unread_ket_char
      <span class="type">xx</span>   tuck, subtraction
      <span class="type">xx</span>   swap
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">dup</span>, space_char?, <span class="keyword">false?branch</span>, <span class="constant">6</span>
      <span class="type">xx</span>   drop
      <span class="type">xx</span>   tuck, subtraction
      <span class="type">xx</span>   swap
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> xoverxx, save_byte
      <span class="type">xx</span> add1
      <span class="type">xx</span> swap, add1, swap
      <span class="type">xx</span> <span class="keyword">taca</span>, help__read_word_to_buffer__regular
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-word</span>
   * read-word will override the word readed before
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"read-word"</span>, read_word
      <span class="comment">;; &lt;&lt; -- word[address of buffer$read_word, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$read_word, read_word_to_buffer
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** read-word-for-REPL</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"read-word-for-REPL"</span>, read_word_for_REPL
      <span class="comment">;; &lt;&lt; -- word[address of buffer$read_word_for_REPL, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$read_word_for_REPL, read_word_to_buffer
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * one should use space-string? to make sure
     that the string is not space-string
     before apply string-[head|tail],word onto the string
<span class="org-level-2">** space-string?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"space-string?"</span>, space_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char, space_char?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   string_tail__char
      <span class="type">xx</span>   <span class="keyword">taca</span>, space_string?
      <span class="type">xx</span> drop2, false
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-&gt;word-[begin|end]</span>
   * the error is not handled
     so
     before calling (string-&gt;word-begin)
     one should make sure that
     the argument is not a space-string
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"string-&gt;word-begin"</span>, string_to_word_begin
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="comment">;;   no error handling
</span>      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> space_char?, false?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> <span class="keyword">taca</span>, string_to_word_begin

   define_function <span class="string">"string-&gt;word-end"</span>, string_to_word_end
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="comment">;;   no error handling
</span>      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> bar_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   string_tail__char
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> help__string_to_word_end
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"help,string-&gt;word-end"</span>, help__string_to_word_end
      <span class="comment">;; &lt;&lt; string[address, length] -- address &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="comment">;;   no error handling
</span>      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> space_char?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> bar_ket_char?, <span class="keyword">false?branch</span>, <span class="constant">2</span>
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> <span class="keyword">taca</span>, help__string_to_word_end
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** string-[head|tail],word</span>
   * note that
     the following functions do not create new strings
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"string-head,word"</span>, string_head__word
      <span class="comment">;; &lt;&lt; string[address, length] -- word[address, length] &gt;&gt;
</span>      <span class="type">xx</span> string_to_word_begin
      <span class="type">xx</span> dup2, string_to_word_end
      <span class="type">xx</span> swap, drop
      <span class="type">xx</span> subtraction
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"string-tail,word"</span>, string_tail__word
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> string_to_word_begin
      <span class="type">xx</span> string_to_word_end
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* dictionary</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * the dictionary is a single-linked-list
     of word-jo-jojo
   * a jojo is an vector of jo
   * from a jo one can find a jojo
     for example
     this is what the "explain$function" will do
     to help the interpreter
     to explain the mean of a jo
   * from a word one can find a jo
     for example
     this is what the "define-function" will do
     from source code
     it defines new function into dictionary
     by creating new structured data into memory
<span class="org-level-2">** find</span>
   * as find
   * find jo in dictionary by word
     but I simply call it "find"
   * a function whoes name is prefixed by "find"
     maybe fail to find
     and maybe returns a signal
     to inform the function who calls it
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*first-jo-in-dictionary*"</span>, V__first_jo_in_dictionary
      <span class="type">xx</span> (last_link + jo_size)

   define_function <span class="string">"find"</span>, find
      <span class="comment">;; found :
</span>      <span class="comment">;; &lt;&lt; word[address, length] -- jo, true &gt;&gt;
</span>      <span class="comment">;; not found :
</span>      <span class="comment">;; &lt;&lt; word[address, length] -- false &gt;&gt;
</span>      <span class="type">xx</span> V__first_jo_in_dictionary
      <span class="type">xx</span> help__find
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"help,find"</span>, help__find
      <span class="comment">;; found :
</span>      <span class="comment">;; &lt;&lt; word[address, length], jo -- jo, true &gt;&gt;
</span>      <span class="comment">;; not found :
</span>      <span class="comment">;; &lt;&lt; word[address, length], jo -- false &gt;&gt;
</span>      <span class="type">xx</span> xxtuckx


      <span class="type">xx</span> jo_to_name, xxoverxx

      <span class="comment">;; for debug
</span>      <span class="comment">;; xx jo_to_name
</span>      <span class="comment">;; xx   dup2
</span>      <span class="comment">;; xx   dup, write_integer, literal, 32, write_byte
</span>      <span class="comment">;; xx   write_string, literal, 10, write_byte
</span>      <span class="comment">;; xx xxoverxx
</span>      <span class="comment">;; xx   dup2
</span>      <span class="comment">;; xx   dup, write_integer, literal, 32, write_byte
</span>      <span class="comment">;; xx   write_string, literal, 10, write_byte
</span>

      <span class="type">xx</span> string_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> xswapxx
      <span class="type">xx</span> <span class="keyword">dup</span>, last_jo__dictionary?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop, drop2
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> jo_to_pre_jo
      <span class="type">xx</span> <span class="keyword">taca</span>, help__find
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** execute-word</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"execute-word"</span>, execute_word
      <span class="comment">;; &lt;&lt; word[address, length] -- unknown &gt;&gt;
</span>      <span class="type">xx</span> dup2, integer_string?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   string_to_integer
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="comment">;; maybe more
</span>
      <span class="type">xx</span> dup2 <span class="comment">;; for to report undefined word
</span>
      <span class="type">xx</span> find, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   xxswapx, drop2
      <span class="type">xx</span>   execute_jo
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="type">xx</span> write_undefined_word_report__for_execute_word
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>
      <span class="type">xx</span> write_byte
      <span class="type">xx</span> <span class="keyword">end</span>


   define_function <span class="string">"write-undefined-word-report,for-execute-word"</span>, write_undefined_word_report__for_execute_word
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_execute_word
      <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_execute_word
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$undefined_word_report__for_execute_word</span>:
      <span class="type">db</span> <span class="string">"* (execute-word) meets undefined word : "</span>
   <span class="function-name">.end</span>:
   length$undefined_word_report__for_execute_word = (.end - string$undefined_word_report__for_execute_word)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* basic-REPL</span>
<span class="org-block-begin-line">  #+begin_src fasm :tangle cicada-nymph.fasm
</span>  define_function <span class="string">"basic-REPL"</span>, basic_REPL
     <span class="comment">;; &lt;&lt; unknown -- unknown &gt;&gt;
</span>     <span class="type">xx</span> read_word_for_REPL
     <span class="type">xx</span> execute_word
     <span class="type">xx</span> <span class="keyword">taca</span>, basic_REPL
<span class="org-block-end-line">  #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* colon semicolon</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * from the aesthetics point of view
     I do NOT think which of the following is better then the other
     but I choose the second one
   * first:
<span class="org-block-begin-line">     #+begin_src
</span><span class="org-block">     define-function factorial
       &lt;&lt; n -- n! &gt;&gt;
       dup one? if
         end
       then
       dup sub1 factorial *
       end
     end
</span><span class="org-block-end-line">     #+end_src
</span>   * second:
<span class="org-block-begin-line">     #+begin_src cicada-nymph
</span>     <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">factorial</span>
       <span class="cicada-nymph-comment">&lt;&lt; n -- n! &gt;&gt;</span>
       dup one? <span class="cicada-nymph-syntax-key-word">if</span>
         <span class="cicada-nymph-end">end</span>
       <span class="cicada-nymph-syntax-key-word">then</span>
       dup sub1 factorial *
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">     #+end_src
</span><span class="org-level-2">** [colon|semicolon]-string?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"colon-string?"</span>, colon_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">':'</span>
      <span class="type">xx</span> char_string?
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"semicolon-string?"</span>, semicolon_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">';'</span>
      <span class="type">xx</span> char_string?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** comment-[begin|end]-string?</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">string$comment_begin</span>:
      <span class="type">db</span> <span class="string">"&lt;&lt;"</span>

   define_function <span class="string">"comment-begin-string?"</span>, comment_begin_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$comment_begin
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> string_equal?
      <span class="type">xx</span> <span class="keyword">end</span>


   <span class="function-name">string$comment_end</span>:
      <span class="type">db</span> <span class="string">"&gt;&gt;"</span>

   define_function <span class="string">"comment-end-string?"</span>, comment_end_string?
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$comment_end
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> string_equal?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** colon &amp; semicolon</span>
   * nested : ; is NOT allow
     and no error check for it
   * nested &lt;&lt; &gt;&gt; must be handled
   * comment are handled by : ;
     comment inside : ; are not readed
   * note that
     there might be a ; in &lt;&lt; &gt;&gt;
     when this happens
     the ; must NOT be readed
   * note that
     a bar-ket is readed as a word
     double-quote is special bar-ket
     but "&lt;" &amp; "&gt;" are not viewed as bar-ket
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   buffer$colon <span class="keyword">labeling</span>
      <span class="type">preserve</span> <span class="constant">1024</span> * <span class="constant">1024</span>

   <span class="function-name">cursor$colon</span>:
      <span class="type">xx</span> <span class="constant">0</span>


   define_function <span class="string">":"</span>, colon
      <span class="comment">;; &lt;&lt; -- string[address of buffer$colon, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, save
      <span class="type">xx</span> help__loop__colon
      <span class="comment">;; address
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
      <span class="comment">;; length
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, buffer$colon
      <span class="type">xx</span> subtraction
      <span class="type">xx</span> <span class="keyword">end</span>


   define_function <span class="string">""</span>, help__loop__colon
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> read_byte
      <span class="type">xx</span> help__save_byte__colon
      <span class="type">xx</span> help__meet_end__colon?, <span class="keyword">false?branch</span>, <span class="constant">7</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">3</span> <span class="comment">;; for the string " ; "
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$colon
      <span class="type">xx</span>   sub_save
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> help__meet_comment__colon?, <span class="keyword">false?branch</span>, <span class="constant">9</span>
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">4</span> <span class="comment">;; for the string " &lt;&lt; "
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$colon
      <span class="type">xx</span>   sub_save
      <span class="type">xx</span>   ignore_comment
      <span class="type">xx</span>   <span class="keyword">taca</span>, help__loop__colon
      <span class="type">xx</span> <span class="keyword">taca</span>, help__loop__colon


   define_function <span class="string">""</span>, help__save_byte__colon
      <span class="comment">;; &lt;&lt; byte -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> save_byte
      <span class="type">xx</span> one
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon
      <span class="type">xx</span> add_save
      <span class="type">xx</span> <span class="keyword">end</span>


   define_function <span class="string">""</span>, help__meet_end__colon?
      <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">3</span>, subtraction
      <span class="type">xx</span> fetch_byte, space_char?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, subtraction
      <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">';'</span>, equal?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, subtraction
      <span class="type">xx</span> fetch_byte, space_char?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> true
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">""</span>, help__meet_comment__colon?
      <span class="comment">;; &lt;&lt; -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">4</span>, subtraction
      <span class="type">xx</span> fetch_byte, space_char?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">3</span>, subtraction
      <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">'&lt;'</span>, equal?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, subtraction
      <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">'&lt;'</span>, equal?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$colon, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, subtraction
      <span class="type">xx</span> fetch_byte, space_char?
      <span class="type">xx</span> false?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> true
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ignore-comment</span>
   * this function is for basic-REPL
     but it is reused by colon
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"&lt;&lt;"</span>, ignore_comment
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> read_word
      <span class="type">xx</span> dup2, comment_begin_string?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>     ignore_comment <span class="comment">;; for the new nested-comment
</span>      <span class="type">xx</span>   <span class="keyword">taca</span>, ignore_comment <span class="comment">;; for the rest-comment
</span>      <span class="type">xx</span> dup2, comment_end_string?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> drop2
      <span class="type">xx</span> <span class="keyword">taca</span>, ignore_comment
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-done">test</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph
</span>   <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-comment">&lt;&lt; 989 &gt;&gt;</span> <span class="cicada-nymph-number">64</span> add .
   <span class="cicada-nymph-comment">&lt;&lt; 65 &gt;&gt;</span>

   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">kkk</span> <span class="cicada-nymph-comment">&lt;&lt; 989 &lt;&lt; 989 &gt;&gt;</span> &gt;&gt; <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">.s</span>
   <span class="cicada-nymph-comment">&lt;&lt; kkk &gt;&gt;</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* function &amp; jojo</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   size$jo_heap = <span class="constant">1024</span> * <span class="constant">1024</span> * jo_size

   define_variable <span class="string">"*jo-heap*"</span>, V__jo_heap
     <span class="type">xx</span> address$jo_heap

   define_variable <span class="string">"*size,jo-heap*"</span>, V__size__jo_heap
     <span class="type">xx</span> size$jo_heap


   address$jo_heap <span class="keyword">labeling</span>
      <span class="type">preserve</span> size$jo_heap

   define_variable <span class="string">"*current-free-address,jo-heap*"</span>, V__current_free_address__jo_heap
      <span class="type">xx</span> address$jo_heap
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * the make-jojo is a macro dispatcher
     it can be viewed as make-function-body
     it gets next word and use predicates on word to do dispatch
   * note that
     make-jojo can be viewed as the "compiler" of the cicada-nymph
     it does NOT (can not) compile file to file
     but creates structured data directly into memory
<span class="org-level-2">** !undo-make-jojo</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_exception <span class="string">"!undo-make-jojo"</span>, !undo_make_jojo
      <span class="comment">;; &lt;&lt; old V__current_free_address__primitive_string
</span>      <span class="comment">;;    old V__current_free_address__jo_heap
</span>      <span class="comment">;;    old V__first_jo_in_dictionary
</span>      <span class="comment">;;    string[address, length]
</span>      <span class="comment">;;    -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$undo_make_jojo_report
      <span class="type">xx</span> <span class="keyword">literal</span>, length$undo_make_jojo_report
      <span class="type">xx</span> write_string

      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">';'</span>, write_byte
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte

      <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_dictionary, save
      <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__jo_heap, save
      <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__primitive_string
      <span class="type">xx</span> save
      <span class="type">xx</span> <span class="keyword">end</span>


   <span class="function-name">string$undo_make_jojo_report</span>:
      <span class="type">db</span> <span class="string">"  THE FOLLOWING JOJO IS NOT MADE :"</span>
      <span class="type">db</span> <span class="constant">10</span>
      <span class="type">db</span> <span class="string">": "</span>
   <span class="function-name">.end</span>:
   length$undo_make_jojo_report = (.end - string$undo_make_jojo_report)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** make-jojo</span>
   * &#36889;&#35023;&#21448;&#29986;&#29983;&#20102;&#29305;&#27530;&#30340;&#19968;&#39006;&#29664;
     &#23427;&#26408;&#35365;&#38614;&#28982;&#20197; "M__" &#29234;&#21069;&#32180;
     &#20294;&#26159;&#27794;&#26377;&#20316;&#29234;&#23383;&#31526;&#20018;&#30340;&#21517;&#23383;
     &#27599;&#20491;&#36889;&#31278;&#29664;&#37117;&#33287;&#19968;&#20491;&#35586;&#35422;&#30456;&#23565;
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"make-jojo"</span>, make_jojo
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> local_variable_table__clear
      <span class="type">xx</span> make_jojo__loop
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"make-jojo,loop"</span>, make_jojo__loop
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> dup2, space_string?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2
      <span class="type">xx</span> string_tail__word
      <span class="type">xx</span> xxswapxx
      <span class="type">xx</span> string_head__word
      <span class="comment">;; &lt;&lt; tail[address, length], head[address, length] &gt;&gt;
</span>      <span class="type">xx</span> make_jojo__dispatch_word
      <span class="type">xx</span> <span class="keyword">taca</span>, make_jojo__loop

   define_function <span class="string">"make-jojo,dispatch-word"</span>, make_jojo__dispatch_word
      <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>      <span class="comment">;;    string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> dup2
      <span class="type">xx</span> find_dispatch_word_stack, true?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   execute_jo
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2
      <span class="type">xx</span> find, false?
      <span class="type">xx</span> <span class="keyword">false?branch</span>, <span class="constant">7</span>
      <span class="type">xx</span>   write_undefined_word_report__for_make_jojo
      <span class="type">xx</span>   write_string
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span>   !undo_make_jojo
      <span class="type">xx</span> xxswapx, drop2 <span class="comment">;; word
</span>      <span class="type">xx</span> make_jojo__dispatch_jo
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"make-jojo,dispatch-jo"</span>, make_jojo__dispatch_jo
      <span class="comment">;; &lt;&lt; string[address, length], jo --
</span>      <span class="comment">;;    string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, macro_jo?, <span class="keyword">false?branch</span>, <span class="constant">3</span>
      <span class="type">xx</span>   execute_jo
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="comment">;; the same to
</span>      <span class="comment">;;   function
</span>      <span class="comment">;;   primitive-function
</span>      <span class="comment">;;   variable
</span>      <span class="comment">;;   exception
</span>      <span class="type">xx</span> save_into__jo_heap
      <span class="type">xx</span> <span class="keyword">end</span>


   define_function <span class="string">"write-undefined-word-report,for-make-jojo"</span>, write_undefined_word_report__for_make_jojo
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_make_jojo
      <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_make_jojo
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$undefined_word_report__for_make_jojo</span>:
      <span class="type">db</span> <span class="string">"* (make-jojo) meets undefined word : "</span>
   <span class="function-name">.end</span>:
   length$undefined_word_report__for_make_jojo = (.end - string$undefined_word_report__for_make_jojo)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** dispatch-word-stack</span>
<span class="org-level-3">*** </span><span class="org-todo">note</span>
    * for we do not build border-check
      into the interface of pop and push
      we allocation some memory below the stacks
    * the size$dispatch_word_stack
      defines the max number of word dispatchers
    * values in dispatch_word_stack
      are two by two
      &lt;&lt; dispatcher [macro, predicate] &gt;&gt;
<span class="org-level-3">*** memory allocation</span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    size$dispatch_word_stack = <span class="constant">1024</span> * jo_size

       <span class="type">preserve</span> <span class="constant">64</span> * jo_size
    address$dispatch_word_stack <span class="keyword">labeling</span>
       <span class="type">preserve</span> size$dispatch_word_stack
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** pointer</span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    <span class="function-name">pointer$dispatch_word_stack</span>:
       <span class="type">xx</span> address$dispatch_word_stack
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** push &amp; pop                        </span><span class="org-level-3"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    <span class="preprocessor">match</span> =64bit, machine {

    define_primitive_function <span class="string">"push-dispatch-word-stack"</span>, push_dispatch_word_stack
       <span class="comment">;; argument-stack -&gt; dispatch-word-stack
</span>       pop_argument_stack <span class="variable-name">rax</span>
       <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$dispatch_word_stack]
       <span class="builtin">mov</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
       <span class="builtin">add</span> <span class="type">qword</span> [pointer$dispatch_word_stack], jo_size
       next

    define_primitive_function <span class="string">"pop-dispatch-word-stack"</span>, pop_dispatch_word_stack
       <span class="comment">;; dispatch-word-stack -&gt; argument-stack
</span>       <span class="builtin">sub</span> <span class="type">qword</span> [pointer$dispatch_word_stack], jo_size
       <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$dispatch_word_stack]
       <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
       push_argument_stack <span class="variable-name">rax</span>
       next

    }
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** push &amp; pop                        </span><span class="org-level-3"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    <span class="preprocessor">match</span> =32bit, machine {

    define_primitive_function <span class="string">"push-dispatch-word-stack"</span>, push_dispatch_word_stack
       <span class="comment">;; argument-stack -&gt; dispatch-word-stack
</span>       pop_argument_stack <span class="variable-name">rax</span>
       <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [pointer$dispatch_word_stack]
       <span class="builtin">mov</span> [<span class="variable-name">rsi</span>], <span class="variable-name">rax</span>
       <span class="builtin">add</span> <span class="type">dword</span> [pointer$dispatch_word_stack], jo_size
       next

    define_primitive_function <span class="string">"pop-dispatch-word-stack"</span>, pop_dispatch_word_stack
       <span class="comment">;; dispatch-word-stack -&gt; argument-stack
</span>       <span class="builtin">sub</span> <span class="type">dword</span> [pointer$dispatch_word_stack], jo_size
       <span class="builtin">mov</span> <span class="variable-name">rsi</span>, [pointer$dispatch_word_stack]
       <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rsi</span>]
       push_argument_stack <span class="variable-name">rax</span>
       next

    }
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** clear                             </span><span class="org-level-3"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    <span class="preprocessor">match</span> =64bit, machine {

    define_primitive_function <span class="string">"clear-dispatch-word-stack"</span>, clear_dispatch_word_stack
       <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>       <span class="builtin">mov</span> <span class="type">qword</span> [pointer$dispatch_word_stack], address$dispatch_word_stack
       next

    }
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** clear                             </span><span class="org-level-3"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    <span class="preprocessor">match</span> =32bit, machine {

    define_primitive_function <span class="string">"clear-dispatch-word-stack"</span>, clear_dispatch_word_stack
       <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>       <span class="builtin">mov</span> <span class="variable-name">eax</span>, address$dispatch_word_stack
       <span class="builtin">mov</span> <span class="type">dword</span> [pointer$dispatch_word_stack], <span class="variable-name">eax</span><span class="comment">;address$dispatch_word_stack
</span>       next

    }
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** find</span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    define_function <span class="string">"find-dispatch-word-stack"</span>, find_dispatch_word_stack
       <span class="comment">;; &lt;&lt; word[address, length]
</span>       <span class="comment">;;    -- jo, true
</span>       <span class="comment">;;    -- false &gt;&gt;
</span>       <span class="type">xx</span> <span class="keyword">literal</span>, pointer$dispatch_word_stack, fetch
       <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_dispatch_word_stack, save
       <span class="type">xx</span> find_dispatch_word_stack__loop
       <span class="type">xx</span> <span class="keyword">end</span>

    <span class="function-name">cursor$find_dispatch_word_stack</span>:
       <span class="type">xx</span> <span class="constant">0</span>

    define_function <span class="string">"find-dispatch-word-stack,loop"</span>, find_dispatch_word_stack__loop
       <span class="comment">;; &lt;&lt; word[address, length]
</span>       <span class="comment">;;    -- jo, true
</span>       <span class="comment">;;    -- false &gt;&gt;
</span>       <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_dispatch_word_stack, fetch
       <span class="type">xx</span> <span class="keyword">literal</span>, address$dispatch_word_stack
       <span class="type">xx</span> equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
       <span class="type">xx</span>   drop2
       <span class="type">xx</span>   false
       <span class="type">xx</span>   <span class="keyword">end</span>
       <span class="type">xx</span> dup2
       <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_dispatch_word_stack, fetch
       <span class="type">xx</span> V__jo_size, subtraction, fetch
       <span class="type">xx</span> execute_jo, true?, <span class="keyword">false?branch</span>, (.not_found-$)/jo_size
       <span class="type">xx</span>   drop2
       <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$find_dispatch_word_stack, fetch
       <span class="type">xx</span>   V__jo_size, subtraction
       <span class="type">xx</span>   V__jo_size, subtraction, fetch
       <span class="type">xx</span>   true
       <span class="type">xx</span>   <span class="keyword">end</span>
    <span class="function-name">.not_found</span>:
       <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_dispatch_word_stack, fetch
       <span class="type">xx</span> V__jo_size, subtraction
       <span class="type">xx</span> V__jo_size, subtraction
       <span class="type">xx</span> <span class="keyword">literal</span>, cursor$find_dispatch_word_stack, save
       <span class="type">xx</span> <span class="keyword">taca</span>, find_dispatch_word_stack__loop
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-3">*** initialize_dispatch_word_stack</span>
<span class="org-block-begin-line">    #+begin_src fasm :tangle cicada-nymph.fasm
</span>    define_function <span class="string">"initialize-dispatch-word-stack"</span>, initialize_dispatch_word_stack
       <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>       <span class="type">xx</span> clear_dispatch_word_stack
       <span class="type">xx</span> <span class="keyword">literal</span>, M__integer_string, push_dispatch_word_stack
       <span class="type">xx</span> <span class="keyword">literal</span>, integer_string?, push_dispatch_word_stack
       <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">    #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> macro in cicada-nymph</span>
   * a macro is a function to be called at compile time
     with a string to be compiled as one argument
     and do side-effect to store data into memory
     and return a shorter string
     [this can be viewed as moving a cursor forward]
   * a macro should be highlight by text editor in a special way
<span class="org-level-2">** address</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="string">"address"</span>, M__address
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">address</span>
      <span class="type">xx</span> save_into__jo_heap

      <span class="type">xx</span> dup2
      <span class="type">xx</span> string_head__word
      <span class="type">xx</span> find, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span>   string_tail__word
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="type">xx</span> write_undefined_word_report__for_address
      <span class="type">xx</span> dup2, string_head__word, write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> !undo_make_jojo


   define_function <span class="string">"write-undefined-word-report,for-address"</span>, write_undefined_word_report__for_address
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$undefined_word_report__for_address
      <span class="type">xx</span> <span class="keyword">literal</span>, length$undefined_word_report__for_address
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$undefined_word_report__for_address</span>:
      <span class="type">db</span> <span class="string">"* (make-jojo (address)) the word follows (address) is undefined : "</span>
   <span class="function-name">.end</span>:
   length$undefined_word_report__for_address = (.end - string$undefined_word_report__for_address)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** branch</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="string">"branch"</span>, M__branch
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">branch</span>
      <span class="type">xx</span> save_into__jo_heap

      <span class="type">xx</span> dup2
      <span class="type">xx</span> string_head__word
      <span class="type">xx</span> dup2, integer_string?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   string_to_integer
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span>   string_tail__word
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="type">xx</span> write_not_integer_string_report__for_branch
      <span class="type">xx</span> dup2, string_head__word, write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> !undo_make_jojo


   define_function <span class="string">"write-not-integer-string-report,for-branch"</span>, write_not_integer_string_report__for_branch
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$not_integer_string_report__for_branch
      <span class="type">xx</span> <span class="keyword">literal</span>, length$not_integer_string_report__for_branch
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$not_integer_string_report__for_branch</span>:
      <span class="type">db</span> <span class="string">"* (make-jojo (branch)) the word follows (branch) must be a integer string : "</span>
   <span class="function-name">.end</span>:
   length$not_integer_string_report__for_branch = (.end - string$not_integer_string_report__for_branch)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** false?branch</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="string">"false?branch"</span>, M__false?branch
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">false?branch</span>
      <span class="type">xx</span> save_into__jo_heap

      <span class="type">xx</span> dup2
      <span class="type">xx</span> string_head__word
      <span class="type">xx</span> dup2, integer_string?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   string_to_integer
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span>   string_tail__word
      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="type">xx</span> write_not_integer_string_report__for_false?branch
      <span class="type">xx</span> dup2, string_head__word, write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> !undo_make_jojo


   define_function <span class="string">"write-not-integer-string-report,for-false?branch"</span>, write_not_integer_string_report__for_false?branch
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$not_integer_string_report__for_false?branch
      <span class="type">xx</span> <span class="keyword">literal</span>, length$not_integer_string_report__for_false?branch
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$not_integer_string_report__for_false?branch</span>:
      <span class="type">db</span> <span class="string">"* (make-jojo (false?branch)) the word follows (false?branch) must be a integer string : "</span>
   <span class="function-name">.end</span>:
   length$not_integer_string_report__for_false?branch = (.end - string$not_integer_string_report__for_false?branch)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** double-quote</span>
   * primitive-string-heap is used
     to allocate string literal in function body
   * in ASCII encode double-quote is 34
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="default">'"'</span>, M__double_quote
      <span class="comment">;; &lt;&lt; string[address, length] -- string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> dup2
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'"'</span>, find_char__string
      <span class="type">xx</span> <span class="keyword">false?branch</span>, (.not_found-$)/jo_size
      <span class="type">xx</span>   xoverxx, subtraction
      <span class="comment">;;   &lt;&lt; string[address, length], length &gt;&gt;
</span>
      <span class="comment">;; address
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>     save_into__jo_heap
      <span class="type">xx</span>   V__current_free_address__primitive_string, add2
      <span class="type">xx</span>     save_into__jo_heap
      <span class="type">xx</span>   xoverxx, over
      <span class="type">xx</span>     save_into__primitive_string_heap

      <span class="comment">;; length
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>     save_into__jo_heap
      <span class="type">xx</span>   <span class="keyword">dup</span>
      <span class="type">xx</span>     save_into__jo_heap

      <span class="type">xx</span>   tuck, subtraction
      <span class="type">xx</span>   xxswapx
      <span class="type">xx</span>   addition
      <span class="type">xx</span>   swap

      <span class="type">xx</span>   string_tail__char <span class="comment">;; over the ending double-quote
</span>      <span class="type">xx</span>   <span class="keyword">end</span>

      <span class="function-name">.not_found</span>:
      <span class="type">xx</span> write_not_integer_string_report__for_double_quote
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> !undo_make_jojo


   define_function <span class="string">"write-not-integer-string-report,for-double-quote"</span>, write_not_integer_string_report__for_double_quote
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, string$not_integer_string_report__for_double_quote
      <span class="type">xx</span> <span class="keyword">literal</span>, length$not_integer_string_report__for_double_quote
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$not_integer_string_report__for_double_quote</span>:
      <span class="type">db</span> <span class="string">"* (make-jojo (double-quote)) can not find the ending double-quote"</span>
   <span class="function-name">.end</span>:
   length$not_integer_string_report__for_double_quote = (.end - string$not_integer_string_report__for_double_quote)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** M__integer_string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="string">""</span>, M__integer_string
      <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>      <span class="comment">;;    string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span> string_to_integer
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * for the following function
     I add the "CICADA__" as prefix
     to distinguish from their assembly code version
<span class="org-level-2">** define-function</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"define-function"</span>, CICADA__define_function
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> V__current_free_address__primitive_string, xxswapx
      <span class="type">xx</span> V__current_free_address__jo_heap, xxswapx
      <span class="type">xx</span> V__first_jo_in_dictionary, xxswapx
      <span class="type">xx</span> prepare_for
      <span class="type">xx</span>   exception_head
      <span class="type">xx</span>   !undo_make_jojo
      <span class="type">xx</span>   end_of_prepare


      <span class="type">xx</span> V__current_free_address__primitive_string
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span> dup2, string_head__word
      <span class="type">xx</span>   save_into__primitive_string_heap

      <span class="type">xx</span> V__first_jo_in_dictionary
      <span class="type">xx</span> jo_to_link
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> V__current_free_address__jo_heap
      <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_dictionary
      <span class="type">xx</span> save

      <span class="type">xx</span> <span class="keyword">literal</span>, explain$function
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> dup2, string_tail__word
      <span class="type">xx</span>   make_jojo


      <span class="type">xx</span> drop2
      <span class="type">xx</span> drop, drop, drop
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-done">test</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">addadd</span> add add <span class="cicada-nymph-end">end</span> <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-number">2</span> <span class="cicada-nymph-number">3</span> addadd . <span class="cicada-nymph-comment">&lt;&lt; 6 &gt;&gt;</span>

   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">add1</span> <span class="cicada-nymph-number">1</span> add <span class="cicada-nymph-end">end</span> <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> add1 . <span class="cicada-nymph-comment">&lt;&lt; 2 &gt;&gt;</span>

   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">negate</span> <span class="cicada-nymph-number">0</span> swap sub <span class="cicada-nymph-end">end</span> <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> negate . <span class="cicada-nymph-comment">&lt;&lt; -1 &gt;&gt;</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** define-macro</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"define-macro"</span>, CICADA__define_macro
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> V__current_free_address__primitive_string, xxswapx
      <span class="type">xx</span> V__current_free_address__jo_heap, xxswapx
      <span class="type">xx</span> V__first_jo_in_dictionary, xxswapx
      <span class="type">xx</span> prepare_for
      <span class="type">xx</span>   exception_head
      <span class="type">xx</span>   !undo_make_jojo
      <span class="type">xx</span>   end_of_prepare


      <span class="type">xx</span> V__current_free_address__primitive_string
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span> dup2, string_head__word
      <span class="type">xx</span>   save_into__primitive_string_heap

      <span class="type">xx</span> V__first_jo_in_dictionary
      <span class="type">xx</span> jo_to_link
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> V__current_free_address__jo_heap
      <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_dictionary
      <span class="type">xx</span> save

      <span class="type">xx</span> <span class="keyword">literal</span>, explain$macro
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> dup2, string_tail__word
      <span class="type">xx</span>   make_jojo


      <span class="type">xx</span> drop2
      <span class="type">xx</span> drop, drop, drop
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** define-exception</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"define-exception"</span>, CICADA__define_exception
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> V__current_free_address__primitive_string, xxswapx
      <span class="type">xx</span> V__current_free_address__jo_heap, xxswapx
      <span class="type">xx</span> V__first_jo_in_dictionary, xxswapx
      <span class="type">xx</span> prepare_for
      <span class="type">xx</span>   exception_head
      <span class="type">xx</span>   !undo_make_jojo
      <span class="type">xx</span>   end_of_prepare


      <span class="type">xx</span> V__current_free_address__primitive_string
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span> dup2, string_head__word
      <span class="type">xx</span>   save_into__primitive_string_heap

      <span class="type">xx</span> V__first_jo_in_dictionary
      <span class="type">xx</span> jo_to_link
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> V__current_free_address__jo_heap
      <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_dictionary
      <span class="type">xx</span> save

      <span class="type">xx</span> <span class="keyword">literal</span>, explain$exception
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> dup2, string_tail__word
      <span class="type">xx</span>   make_jojo


      <span class="type">xx</span> drop2
      <span class="type">xx</span> drop, drop, drop
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * not undo is needed for define-variable
<span class="org-level-2">** define-variable</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"define-variable"</span>, CICADA__define_variable
      <span class="comment">;; &lt;&lt; variable, string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> V__current_free_address__primitive_string
      <span class="type">xx</span>   save_into__jo_heap
      <span class="type">xx</span> dup2, string_head__word
      <span class="type">xx</span>   save_into__primitive_string_heap

      <span class="type">xx</span> V__first_jo_in_dictionary
      <span class="type">xx</span> jo_to_link
      <span class="type">xx</span>   save_into__jo_heap

      <span class="type">xx</span> V__current_free_address__jo_heap
      <span class="type">xx</span> <span class="keyword">address</span>, V__first_jo_in_dictionary
      <span class="type">xx</span> save

      <span class="type">xx</span> <span class="keyword">literal</span>, explain$variable
      <span class="type">xx</span>   save_into__jo_heap

      <span class="comment">;; when debugging
</span>      <span class="comment">;; instead of drop2
</span>      <span class="comment">;; one may wish to do some thing to the string
</span>      <span class="type">xx</span> drop2
      <span class="type">xx</span> save_into__jo_heap
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span>
   * you can see how the naming convention is used
     for functions that create structured data into memory
<span class="org-level-2">** save-into,primitive-string-heap</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"save-into,primitive-string-heap"</span>, save_into__primitive_string_heap
      <span class="comment">;; &lt;&lt; string[address, length] -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, V__current_free_address__primitive_string
      <span class="type">xx</span> save_two_bytes

      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>
      <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__primitive_string
      <span class="type">xx</span> add_save

      <span class="type">xx</span> tuck
      <span class="type">xx</span> V__current_free_address__primitive_string
      <span class="type">xx</span> string_to_buffer!

      <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__primitive_string
      <span class="type">xx</span> add_save
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** save-into,jo-heap</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"save-into,jo-heap"</span>, save_into__jo_heap
      <span class="comment">;; &lt;&lt; number -- &gt;&gt;
</span>      <span class="type">xx</span> V__current_free_address__jo_heap
      <span class="type">xx</span> save

      <span class="type">xx</span> <span class="keyword">literal</span>, jo_size
      <span class="type">xx</span> <span class="keyword">address</span>, V__current_free_address__jo_heap
      <span class="type">xx</span> add_save
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-done">test</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph
</span>   <span class="cicada-nymph-number">233</span> <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">*three*</span> <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-variable</span>
   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">add-three</span> <span class="cicada-nymph-variable">*three*</span> add <span class="cicada-nymph-end">end</span> <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> add-three . <span class="cicada-nymph-comment">&lt;&lt; 234 &gt;&gt;</span>

   <span class="cicada-nymph-comment">&lt;&lt; you get the address of the variable *three*
      by add "address" in front of it &gt;&gt;</span>
   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">fix-*three*</span> <span class="cicada-nymph-number">3</span> <span class="cicada-nymph-syntax-key-word">address</span> <span class="cicada-nymph-variable">*three*</span> save <span class="cicada-nymph-end">end</span> <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   fix-*three*
   <span class="cicada-nymph-number">1</span> add-three . <span class="cicada-nymph-comment">&lt;&lt; 4 &gt;&gt;</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* local-variable</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> </span><span class="org-level-2"><span class="bold">*to compare readability*</span></span>
<span class="org-level-2">** example code without local-variable</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">name-hash-table,insert,loop</span>
     <span class="cicada-nymph-comment">&lt;&lt; string[address, length], number, counter
        -- name, true
        -- name, false &gt;&gt;</span>
     xx|tuck|xx name-hash-table,hash
     xx|tuck|x
     <span class="cicada-nymph-comment">&lt;&lt; number, counter, name, string[address, length], name &gt;&gt;</span>
     name,used? false? <span class="cicada-nymph-syntax-key-word">if</span>
       x|over|xx name,save-string
         xx|tuck|x <span class="cicada-nymph-comment">&lt;&lt; name as return value &gt;&gt;</span>
       <span class="cicada-nymph-comment">&lt;&lt; name, number, counter, name &gt;&gt;</span>
       x|over|xx <span class="cicada-nymph-number">0</span> name-hash-table,hash
       swap name,save-orbiton
       <span class="cicada-nymph-comment">&lt;&lt; name, number, counter &gt;&gt;</span>
       swap <span class="cicada-nymph-number">0</span> name-hash-table,hash
       name,save-orbit-length
       <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-syntax-key-word">address</span> <span class="cicada-nymph-variable">*name-hash-table,counter*</span> add-save
       <span class="cicada-nymph-bool">true</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     <span class="cicada-nymph-comment">&lt;&lt; number, counter, name, string[address, length] &gt;&gt;</span>
     x|over|xx name,fetch-string
     xx|over|xx string-equal? <span class="cicada-nymph-syntax-key-word">if</span>
       drop2 xx|swap|x drop2
       <span class="cicada-nymph-bool">true</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     <span class="cicada-nymph-comment">&lt;&lt; number, counter, name, string[address, length] &gt;&gt;</span>
     x|over|xxx <span class="cicada-nymph-variable">*name-hash-table,size*</span> equal? <span class="cicada-nymph-syntax-key-word">if</span>
       drop2 xx|swap|x drop2
       <span class="cicada-nymph-bool">false</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     <span class="cicada-nymph-comment">&lt;&lt; number, counter, name, string[address, length] &gt;&gt;</span>
     x|swap|xx drop
     xx|swap|xx add1
     <span class="cicada-nymph-end">&lt;&gt;</span> name-hash-table,insert,loop
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">name-hash-table,insert</span>
     <span class="cicada-nymph-comment">&lt;&lt; string[address, length]
        -- name, true
        -- name, false &gt;&gt;</span>
     dup2 string-&gt;finite-carry-sum
     <span class="cicada-nymph-number">0</span> name-hash-table,insert,loop
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** example code with local-variable</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph :tangle core.cn
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">name-hash-table,insert,loop</span>
     <span class="cicada-nymph-comment">&lt;&lt; string[address, length], number, counter
        -- name, true
        -- name, false &gt;&gt;</span>
     <span class="cicada-nymph-save-local-variable-1">&gt;:counter</span> <span class="cicada-nymph-save-local-variable-1">&gt;:number</span> <span class="cicada-nymph-save-local-variable-2">&gt;::string</span>
     <span class="cicada-nymph-fetch-local-variable-1">:number</span> <span class="cicada-nymph-fetch-local-variable-1">:counter</span> name-hash-table,hash
     <span class="cicada-nymph-save-local-variable-1">&gt;:name</span>
     <span class="cicada-nymph-fetch-local-variable-1">:number</span> <span class="cicada-nymph-number">0</span> name-hash-table,hash
     <span class="cicada-nymph-save-local-variable-1">&gt;:orbit</span>
     <span class="cicada-nymph-fetch-local-variable-1">:name</span> name,used? false? <span class="cicada-nymph-syntax-key-word">if</span>
       <span class="cicada-nymph-fetch-local-variable-2">::string</span> <span class="cicada-nymph-fetch-local-variable-1">:name</span>
       name,save-string
       <span class="cicada-nymph-fetch-local-variable-1">:orbit</span> <span class="cicada-nymph-fetch-local-variable-1">:name</span>
       name,save-orbiton
       <span class="cicada-nymph-fetch-local-variable-1">:counter</span> <span class="cicada-nymph-fetch-local-variable-1">:orbit</span>
       name,save-orbit-length
       <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-syntax-key-word">address</span> <span class="cicada-nymph-variable">*name-hash-table,counter*</span> add-save
       <span class="cicada-nymph-fetch-local-variable-1">:name</span> <span class="cicada-nymph-bool">true</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     <span class="cicada-nymph-fetch-local-variable-1">:name</span> name,fetch-string
     <span class="cicada-nymph-fetch-local-variable-2">::string</span> string-equal? <span class="cicada-nymph-syntax-key-word">if</span>
       <span class="cicada-nymph-fetch-local-variable-1">:name</span> <span class="cicada-nymph-bool">true</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     <span class="cicada-nymph-fetch-local-variable-1">:counter</span> <span class="cicada-nymph-variable">*name-hash-table,size*</span> equal? <span class="cicada-nymph-syntax-key-word">if</span>
       <span class="cicada-nymph-fetch-local-variable-1">:name</span> <span class="cicada-nymph-bool">false</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-syntax-key-word">then</span>
     <span class="cicada-nymph-fetch-local-variable-2">::string</span>
     <span class="cicada-nymph-fetch-local-variable-1">:number</span> <span class="cicada-nymph-fetch-local-variable-1">:counter</span> add1
     <span class="cicada-nymph-end">&lt;&gt;</span> name-hash-table,insert,loop
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>

   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">name-hash-table,insert</span>
     <span class="cicada-nymph-comment">&lt;&lt; string[address, length]
        -- name, true
        -- name, false &gt;&gt;</span>
     dup2 string-&gt;finite-carry-sum
     <span class="cicada-nymph-number">0</span> name-hash-table,insert,loop
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">&#35352;</span><span class="org-level-2"> &#35438;&#37323;&#32773; &#33287; &#25910;&#23614;&#35422;</span>
   * &#22312;&#36914;&#34892;&#26178;
     &#27599;&#27425;&#36914;&#20837;&#19968;&#20491;&#20989;&#25976;&#39636;&#30340;&#22519;&#34892;
     &#21363; &#27599;&#27425;&#23559;&#19968;&#20018;&#29664;&#29664;&#20837;&#26855;&#26178;
     &#21516;&#26178;&#22312;&#36889;&#20018;&#29664;&#23376;&#24213;&#37096;&#21152;&#19978;
     current_free_address$local_data_heap
     &#21363; &#22312; explain$function &#20013;&#38656;&#35201;&#20570;&#29305;&#27530;&#34389;&#29702;
     &#27880;&#24847;
     explain$exception
     explain$macro
     &#31561;&#31561;
     &#21644; explain$function &#20006;&#27794;&#26377;&#21312;&#21029;
     &#21482;&#26159;&#21517;&#23383;&#19981;&#19968;&#27171;&#32780;&#24050;
     &#25152;&#20197;&#20063;&#38656;&#35201;&#20570;&#29305;&#27530;&#34389;&#29702;
   * &#36889;&#20491;&#20540;&#22312;&#20989;&#25976;&#36864;&#20986;&#26178;
     [&#21363; &#22312; end &#36889;&#20491;&#20989;&#25976;&#20013;]
     &#29992;&#20197;&#37325;&#32622; current_free_address$local_data_heap
     &#20063;&#23601;&#26159; &#37323;&#25918;&#22312;&#36889;&#27425;&#20989;&#25976;&#20316;&#29992;&#36942;&#31243;&#20013;&#25152;&#20998;&#37197;&#30340;&#20839;&#23384;
   * &#27599;&#27425; &gt;:name &#30340;&#26178;&#20505;
     &#37117;&#26356;&#26032; current_free_address$local_data_heap
     &#20197;&#20998;&#37197;&#20839;&#23384;&#23601;&#34892;&#20102;
   * &#20063;&#23601;&#26159;&#35498;
     return-stack &#20013;&#30340;&#22823;&#22810;&#25976;&#26377;&#25928;&#20540;
     &#37117;&#26159;&#20197;&#20841;&#20491;&#20540;&#19968;&#23565;&#30340;&#26041;&#24335;&#23384;&#22312;&#30340;
   * &#20841;&#20491;&#32080;&#23614;&#35422;&#26159; end &#21644; &lt;&gt;
     &#23565;&#26044; &lt;&gt;
     &#21363; &#23565;&#26044;&#26126;&#39023;&#30340;&#23614;&#36958;&#27512;&#35519;&#29992;
     &#38656;&#35201;&#21033;&#29992;&#26855;&#20013;&#30340;&#20540;&#37325;&#32622; current_free_address$local_data_heap
     &#20294;&#26159;&#20006;&#19981;&#20837;&#26855;&#26032;&#20540;
<span class="org-level-2">** </span><span class="org-todo">&#35352;</span><span class="org-level-2"> &#35486;&#27861;&#25844;&#23637;&#26041;&#38754;&#30340;&#25903;&#25345;</span>
   * &#36889;&#35023;&#38656;&#35201;&#35672;&#21029; &gt;:name &#36996;&#26377; :name &#31561;&#31561;
     &#20006;&#23565;&#23427;&#20497;&#20570;&#29305;&#27530;&#34389;&#29702;
     &#36889;&#20123;&#26481;&#35199;&#25033;&#35442;&#34249;&#21161;&#35373;&#35336;&#33391;&#22909;&#30340;&#35486;&#27861;&#25844;&#23637;&#27231;&#21046;&#20358;&#23526;&#29694;
   * &#20063;&#23601;&#26159;&#35498;
     &#21934;&#32020;&#30340; define-macro &#26159;&#19981;&#20805;&#20998;&#30340;
     &#38656;&#35201;&#35731; make-jojo &#32173;&#35703;&#19968;&#20491;&#21015;&#34920;
     &#20197;&#21205;&#24907;&#30340;&#26041;&#24335;&#26597;&#25214; &#35486;&#27861;&#35586;&#35422;
   * &#23526;&#38555;&#19978;
     &#25105;&#23559;&#20351;&#29992;&#19968;&#20491; &#35486;&#27861;&#35586;&#35422; &#30340;&#26855;
     &#21487;&#20197;&#30332;&#29694;
     &#36889;&#27171;&#30340;&#35441;
     &#25105;&#23601;&#33021;&#24456;&#23481;&#26131;&#22320;&#33256;&#26178;&#25913;&#35722;&#35486;&#27861;&#20102;
<span class="org-level-2">** </span><span class="org-todo">&#35352;</span><span class="org-level-2"> &#27880;&#24847;</span>
   * &#38656;&#35201;&#37325;&#23531;&#30340;&#37096;&#20998;&#36996;&#26377; exception-handling
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> interface</span>
   * &#39318;&#20808;&#35201;&#28415;&#36275;&#26368;&#22522;&#26412;&#30340;
     &#38263;&#24230;&#29234; <span class="bold">*jo-size*</span> &#30340;&#20493;&#25976;&#30340;
     &#23616;&#37096;&#35722;&#37327;&#30340;&#38656;&#27714;
     &#20854;&#27425;
     &#36996;&#35201;&#33021;&#22816;&#22312;&#25152;&#30003;&#35531;&#30340;&#23616;&#37096;&#31354;&#38291;&#35023;&#20351;&#29992;&#23383;&#31526;&#20018;
     &#36889;&#20841;&#31278;&#38263;&#24230;&#30340;&#25976;&#25818;&#32080;&#27083;&#38656;&#35201;&#20849;&#23384;
     &#20351;&#29992; offset &#23601;&#34892;&#20102;
   * &#24213;&#23652;
     local-data-allocate,byte
     &#36889;&#20491;&#21482;&#35731; current_free_address$local_data_heap &#21069;&#36914;
     &#32780;&#19981;&#24460;&#36864;
   * &#27880;&#24847;
     &#26368;&#29234;&#37325;&#35201;&#30340;&#29305;&#40670;&#26159;
     &#25152;&#26377;&#30340;&#23565; &#23616;&#37096;&#25976;&#25818;&#22534; &#30340;&#20351;&#29992;
     &#37117;&#24517;&#38920;&#22312;&#32232;&#35695;&#26178;&#26399;&#34987;&#38748;&#24907;&#22320;&#31639;&#20986;&#20358;
     &#25152;&#20197;&#24517;&#38920;&#35373;&#35336;&#35486;&#27861;&#24171;&#21161;&#32232;&#35695;&#22120;&#20316;&#35336;&#31639;
     &gt;:name :name &#29992;&#20197; &#20998;&#37197; &#21644; &#20351;&#29992;
     <span class="bold">*jo-size*</span> &#20493;&#25976;&#22823;&#23567;&#30340;&#20839;&#23384;
     &#32780;
     16 %&gt;:address
     &#23559;&#20998;&#37197; 16 byte &#30340;&#20839;&#23384;
     &#28982;&#24460;&#25226;&#20839;&#23384;&#39318;&#30340;&#22320;&#22336;&#23384;&#25918;&#21040; :address &#36889;&#20491;&#23616;&#37096;&#35722;&#37327;&#20013;
   * &#35486;&#32681;&#26041;&#38754;
     &gt;:name &#30340;&#37325;&#35079;&#20986;&#29694;&#26377;&#20841;&#31278;&#35486;&#32681;
     1. &#26356;&#26032;&#36889;&#20491;&#23616;&#37096;&#35722;&#20803;&#30340;&#20540;
     2. &#35206;&#33995;&#19978;&#19968;&#20491;&#23616;&#37096;&#35722;&#20803;&#32129;&#23450;
     &#25105;&#36984;&#25799;&#31532;&#19968;&#31278;
     &#22240;&#29234;&#36889;&#27171;
     &#25105;&#23601;&#19981;&#24517;&#35373;&#35336;&#38989;&#22806;&#30340;&#35486;&#27861;&#20358;&#26356;&#26032;&#23616;&#37096;&#35722;&#20803;&#30340;&#20540;&#20102;
     &#27604;&#36611;&#31777;&#28500;
<span class="org-level-2">** </span><span class="org-todo">&#35352;</span><span class="org-level-2"> &#35486;&#32681;&#29305;&#40670;&#32317;&#32080;</span>
   * &#25152;&#26377;&#26377;&#21517;&#23616;&#37096;&#35722;&#20803;&#30340;&#21517;&#23383;&#33287;&#20540;&#30340;&#23565;&#25033;
     &#37117;&#30001;&#32232;&#35695;&#22120;&#34389;&#29702;
   * &#27599;&#20491;&#20989;&#25976;&#39636;&#23601;&#26159;&#19968;&#20491;&#38750;&#24120;&#32218;&#24615;&#30340;&#26481;&#35199;
     &#20989;&#25976;&#39636;&#20013;&#19981;&#33021;&#23884;&#22871;&#21029;&#30340;&#20989;&#25976;&#39636;
<span class="org-level-2">** </span><span class="org-todo">&#35352;</span><span class="org-level-2"> &#35486;&#29992;&#29305;&#40670;&#32317;&#32080;</span>
   * &#25152;&#26377;&#30340;&#20989;&#25976;&#37117;&#26159;&#20840;&#23616;&#30340;
     &#21253;&#25324;&#36628;&#21161;&#20989;&#25976;
   * &#25152;&#20197;&#35373;&#35336;&#36628;&#21161;&#20989;&#25976;&#30340;&#26178;&#20505;
     &#25033;&#35442;&#26684;&#22806;&#23567;&#24515;
     &#20760;&#37327;&#20351;&#24471;&#36628;&#21161;&#20989;&#25976;&#33021;&#22816;&#34987;&#37325;&#29992;
   * &#25913;&#20195;&#30908;&#20006;&#35519;&#25972;&#23565;&#36628;&#21161;&#20989;&#25976;&#30340;&#20351;&#29992;
     &#23601;&#34987;&#31281;&#20316;&#26159; "re-factoring"
     &#21363; &#20989;&#25976;&#30340;&#22240;&#23376;&#30340;&#37325;&#26032;&#20998;&#35299;
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   size$local_data_heap = <span class="constant">3</span> * <span class="constant">1024</span> * <span class="constant">1024</span>

   address$local_data_heap <span class="keyword">labeling</span>
      <span class="type">preserve</span> size$local_data_heap

   <span class="function-name">current_free_address$local_data_heap</span>:
      <span class="type">xx</span> address$local_data_heap
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** local_data_allocate__[byte,jo]</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"local-data-allocate,byte"</span>, local_data_allocate__byte
      <span class="comment">;; &lt;&lt; number -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, current_free_address$local_data_heap
      <span class="type">xx</span> add_save
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"local-data-allocate,jo"</span>, local_data_allocate__jo
      <span class="comment">;; &lt;&lt; number -- &gt;&gt;
</span>      <span class="type">xx</span> V__jo_size, multiple
      <span class="type">xx</span> <span class="keyword">literal</span>, current_free_address$local_data_heap
      <span class="type">xx</span> add_save
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> many fetch &amp; save</span>
   * in memory
     <span class="org-table">| 1 : value-1 |</span>
     <span class="org-table">| 1 : value-2 |</span>
     <span class="org-table">| 1 : value-3 |</span>
   * on stack
     &lt;&lt; value-1, value-2, value-3, ... &gt;&gt;
<span class="org-level-2">** n-fetch &amp; n-save                   </span><span class="org-level-2"><span class="org-tag">:64bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =64bit, machine {

   define_primitive_function <span class="string">"n-fetch-local-data"</span>, n_fetch_local_data
      <span class="comment">;; &lt;&lt; offset, n -- value-1, ..., value-n &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$return_stack - (<span class="constant">2</span> * jo_size)]

      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   define_primitive_function <span class="string">"n-save-local-data"</span>, n_save_local_data
      <span class="comment">;; &lt;&lt; value-n, ..., value-1, offset, n -- &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [pointer$return_stack - (<span class="constant">2</span> * jo_size)]

      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
        <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
        <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
        <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
        <span class="comment">;; for address is based on 0
</span>        <span class="comment">;; but n is based on 1
</span>        <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="function-name">.loop</span>:
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** n-fetch &amp; n-save                   </span><span class="org-level-2"><span class="org-tag">:32bit:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =32bit, machine {

   define_primitive_function <span class="string">"n-fetch-local-data"</span>, n_fetch_local_data
      <span class="comment">;; &lt;&lt; offset, n -- value-1, ..., value-n &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$return_stack]
      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [<span class="variable-name">rax</span> - (<span class="constant">2</span> * jo_size)]

      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
   <span class="function-name">.loop</span>:
      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [<span class="variable-name">rbx</span>]
      push_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   define_primitive_function <span class="string">"n-save-local-data"</span>, n_save_local_data
      <span class="comment">;; &lt;&lt; value-n, ..., value-1, offset, n -- &gt;&gt;
</span>      <span class="builtin">mov</span> <span class="variable-name">rax</span>, [pointer$return_stack]
      <span class="builtin">mov</span> <span class="variable-name">rbx</span>, [<span class="variable-name">rax</span> - (<span class="constant">2</span> * jo_size)]

      pop_argument_stack <span class="variable-name">rcx</span>
      pop_argument_stack <span class="variable-name">rdx</span>
      <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rdx</span>
        <span class="builtin">mov</span> <span class="variable-name">rax</span>, jo_size
        <span class="builtin">imul</span> <span class="variable-name">rax</span>, <span class="variable-name">rcx</span>
        <span class="builtin">add</span> <span class="variable-name">rbx</span>, <span class="variable-name">rax</span>
        <span class="comment">;; for address is based on 0
</span>        <span class="comment">;; but n is based on 1
</span>        <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
   <span class="function-name">.loop</span>:
      pop_argument_stack <span class="variable-name">rax</span>
      <span class="builtin">mov</span> [<span class="variable-name">rbx</span>], <span class="variable-name">rax</span>
      <span class="builtin">sub</span> <span class="variable-name">rbx</span>, jo_size
      <span class="builtin">loop</span> .loop
      next

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> example result</span>
   * with &gt;::name
     without @:address
<span class="org-block-begin-line">     #+begin_src cicada-nymph
</span>     <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">example</span>
       <span class="cicada-nymph-comment">&lt;&lt; number1, number2, number3, number4
          -- number1, number2 &gt;&gt;</span>
       <span class="cicada-nymph-save-local-variable-2">&gt;::var2</span>
       <span class="cicada-nymph-save-local-variable-2">&gt;::var2</span>
       <span class="cicada-nymph-fetch-local-variable-2">::var2</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">     #+end_src
</span>     ----------------
<span class="org-block-begin-line">     #+begin_src fasm
</span>     define_function <span class="string">"example"</span>, example

        <span class="comment">;; &gt;::var2
</span>        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">2</span>, local_data_allocate__jo
        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, <span class="keyword">literal</span>, <span class="constant">2</span>, n_save_local_data

        <span class="comment">;; &gt;::var2
</span>        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, <span class="keyword">literal</span>, <span class="constant">2</span>, n_save_local_data

        <span class="comment">;; ::var2
</span>        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, <span class="keyword">literal</span>, <span class="constant">2</span>, n_fetch_local_data

        <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">     #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">note</span><span class="org-level-2"> example result 2</span>
   * with @:address
     without &gt;::name
<span class="org-block-begin-line">     #+begin_src cicada-nymph
</span>     <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">example</span>
       <span class="cicada-nymph-comment">&lt;&lt; -- &gt;&gt;</span>
       <span class="cicada-nymph-save-local-variable-X">@:address</span> <span class="cicada-nymph-number">16</span>
       <span class="cicada-nymph-save-local-variable-X">@:address</span> <span class="cicada-nymph-number">32</span>
       <span class="cicada-nymph-end">end</span>
     <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
<span class="org-block-end-line">     #+end_src
</span>     ----------------
<span class="org-block-begin-line">     #+begin_src fasm
</span>     define_function <span class="string">"example"</span>, example

        <span class="comment">;; @:address 16
</span>        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">1</span>, local_data_allocate__jo
        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">16</span>
        <span class="type">xx</span>   <span class="keyword">literal</span>, current_free_address$local_data_heap
        <span class="type">xx</span>   fetch, swap
        <span class="type">xx</span> local_data_allocate__byte

        <span class="type">xx</span> <span class="keyword">literal</span>, (<span class="constant">0</span> + jo_size + <span class="constant">16</span>), n_save_local_data

        <span class="comment">;; @:address 32
</span>        <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">32</span>
        <span class="type">xx</span>   <span class="keyword">literal</span>, current_free_address$local_data_heap
        <span class="type">xx</span>   fetch, swap
        <span class="type">xx</span> local_data_allocate__byte
        <span class="type">xx</span> <span class="keyword">literal</span>, (<span class="constant">0</span> + jo_size + <span class="constant">16</span>), n_save_local_data

        <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">     #+end_src
</span><span class="org-level-2">** </span><span class="org-done">test</span>
<span class="org-block-begin-line">   #+begin_src cicada-nymph
</span>   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">local-variable,test</span>
     <span class="cicada-nymph-comment">&lt;&lt; number1, number2, number3 -- number1 + number2 &gt;&gt;</span>
     <span class="cicada-nymph-save-local-variable-1">&gt;:var2</span>
     <span class="cicada-nymph-save-local-variable-1">&gt;:var2</span>
     <span class="cicada-nymph-save-local-variable-1">&gt;:var1</span>
     <span class="cicada-nymph-fetch-local-variable-1">:var1</span>
     <span class="cicada-nymph-fetch-local-variable-1">:var2</span>
     add
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-number">2</span> <span class="cicada-nymph-number">4</span> local-variable,test <span class="cicada-nymph-comment">&lt;&lt; 3 &gt;&gt;</span> .


   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">local-variable,test,2</span>
     <span class="cicada-nymph-comment">&lt;&lt; number1, number2 -- number2 + number3 &gt;&gt;</span>
     <span class="cicada-nymph-save-local-variable-2">&gt;::var2</span>
     <span class="cicada-nymph-fetch-local-variable-2">::var2</span>
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-number">2</span> local-variable,test,2 <span class="cicada-nymph-comment">&lt;&lt; 1 2 &gt;&gt;</span> . .


   <span class="cicada-nymph-sentence-reader">:</span> <span class="cicada-nymph-word-to-define">local-variable,test,3</span>
     <span class="cicada-nymph-comment">&lt;&lt; number1, number2, number3 -- number2 + number3 &gt;&gt;</span>
     <span class="cicada-nymph-save-local-variable-2">&gt;::var2</span>
     <span class="cicada-nymph-save-local-variable-1">&gt;:var1</span>
     <span class="cicada-nymph-fetch-local-variable-2">::var2</span>
     add
     <span class="cicada-nymph-end">end</span>
   <span class="cicada-nymph-sentence-reader">;</span> <span class="cicada-nymph-lexicographer">define-function</span>
   <span class="cicada-nymph-number">1</span> <span class="cicada-nymph-number">2</span> <span class="cicada-nymph-number">4</span> local-variable,test,3 <span class="cicada-nymph-comment">&lt;&lt; 6 &gt;&gt;</span> .
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** count-front-colon</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"count-front-colon"</span>, count_front_colon
      <span class="comment">;; &lt;&lt; string[address, length] -- number &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span> <span class="comment">;; counter
</span>      <span class="type">xx</span> count_front_colon__loop
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"count-front-colon,loop"</span>, count_front_colon__loop
      <span class="comment">;; &lt;&lt; string[address, length], counter -- number &gt;&gt;
</span>      <span class="type">xx</span> over, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   xxswapx, drop2
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> xxoverx, string_head__char
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">':'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   xxswapx, drop2
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> add1, xxswapx
      <span class="type">xx</span> string_tail__char, xswapxx
      <span class="type">xx</span> <span class="keyword">taca</span>, count_front_colon__loop
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** local-variable-fetch-string?</span>
   * :name
     ::name
   * but not
<span class="org-special-keyword">     :name:</span>
     <span class="org-special-keyword">::name:</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"local-variable-fetch-string?"</span>, local_variable_fetch_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, addition, sub1
      <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">':'</span>
      <span class="type">xx</span> equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, count_front_colon
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?, false?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop, drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> subtraction
      <span class="type">xx</span> swap, drop
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** M__local_variable_fetch_string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="string">""</span>, M__local_variable_fetch_string
      <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>      <span class="comment">;;    string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> dup2
      <span class="type">xx</span> local_variable_table__find, <span class="keyword">false?branch</span>, (.not_found-$)/jo_size
      <span class="comment">;;   literal, &lt;offese&gt;, literal, n, n_fetch_local_data
</span>      <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>       save_into__jo_heap
      <span class="comment">;;     offset
</span>      <span class="type">xx</span>       save_into__jo_heap
      <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>       save_into__jo_heap
      <span class="comment">;;     n
</span>      <span class="type">xx</span>     count_front_colon
      <span class="type">xx</span>       save_into__jo_heap
      <span class="type">xx</span>     <span class="keyword">literal</span>, n_fetch_local_data
      <span class="type">xx</span>       save_into__jo_heap
      <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="function-name">.not_found</span>:
      <span class="comment">;; &gt;&lt;&gt;&lt;&gt;&lt; exception handling
</span>      <span class="type">xx</span> write_local_variable_not_bound_report
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">10</span>, write_byte
      <span class="type">xx</span> !undo_make_jojo


   define_function <span class="string">"write-local-variable-not-bound-report"</span>, write_local_variable_not_bound_report
      <span class="type">xx</span> <span class="keyword">literal</span>, string$local_variable_not_bound_report
      <span class="type">xx</span> <span class="keyword">literal</span>, length$local_variable_not_bound_report
      <span class="type">xx</span> write_string
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$local_variable_not_bound_report</span>:
      <span class="type">db</span> <span class="string">"* LOCAL-VARIABLE NOT BOUND : "</span>
   <span class="function-name">.end</span>:
   length$local_variable_not_bound_report = (.end - string$local_variable_not_bound_report)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** local-variable-save-string?</span>
   * &gt;:name
     &gt;::name
   * but not
     &gt;:name:
     &gt;::name:
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"local-variable-save-string?"</span>, local_variable_save_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, zero?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, addition, sub1
      <span class="type">xx</span> fetch_byte, <span class="keyword">literal</span>, <span class="default">':'</span>
      <span class="type">xx</span> equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'&gt;'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> dup2, count_front_colon
      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?, false?, <span class="keyword">false?branch</span>, <span class="constant">5</span>
      <span class="type">xx</span>   drop, drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> subtraction
      <span class="type">xx</span> swap, drop
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>, greater_than?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** M__local_variable_save_string</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_macro <span class="string">""</span>, M__local_variable_save_string
      <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>      <span class="comment">;;    string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> dup2
      <span class="type">xx</span> local_variable_table__find, <span class="keyword">false?branch</span>, (.not_found-$)/jo_size
      <span class="comment">;;   literal, &lt;offese&gt;, literal, n, n_save_local_data
</span>      <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>       save_into__jo_heap
      <span class="comment">;;     offset
</span>      <span class="type">xx</span>       save_into__jo_heap
      <span class="type">xx</span>     <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>       save_into__jo_heap
      <span class="comment">;;     n
</span>      <span class="type">xx</span>     count_front_colon
      <span class="type">xx</span>       save_into__jo_heap
      <span class="type">xx</span>     <span class="keyword">literal</span>, n_save_local_data
      <span class="type">xx</span>       save_into__jo_heap
      <span class="type">xx</span>   <span class="keyword">end</span>
   <span class="function-name">.not_found</span>:
      <span class="type">xx</span> dup2
      <span class="type">xx</span> local_variable_table__insert
      <span class="type">xx</span> xxswapx
      <span class="type">xx</span> count_front_colon
      <span class="comment">;; literal, &lt;number&gt;, local_data_allocate__jo
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>     save_into__jo_heap
      <span class="comment">;;   number of jo
</span>      <span class="type">xx</span>     <span class="keyword">dup</span>, save_into__jo_heap
      <span class="type">xx</span>   <span class="keyword">literal</span>, local_data_allocate__jo
      <span class="type">xx</span>     save_into__jo_heap
      <span class="comment">;; literal, &lt;offese&gt;, literal, n, save_local_data
</span>      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>     save_into__jo_heap
      <span class="comment">;;   offset
</span>      <span class="type">xx</span>   swap
      <span class="type">xx</span>     save_into__jo_heap
      <span class="type">xx</span>   <span class="keyword">literal</span>, <span class="keyword">literal</span>
      <span class="type">xx</span>     save_into__jo_heap
      <span class="comment">;;   n
</span>      <span class="type">xx</span>     save_into__jo_heap
      <span class="type">xx</span>   <span class="keyword">literal</span>, n_save_local_data
      <span class="type">xx</span>     save_into__jo_heap
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-todo">&gt;&lt;</span><span class="org-level-2"> local-variable-save-address-string?</span>
   * @:address
<span class="org-block-begin-line">   #+begin_src fasm
</span>   define_function <span class="string">"local-variable-save-address-string?"</span>, local_variable_save_address_string?
      <span class="comment">;; &lt;&lt; string[address, length] -- bool &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">dup</span>, <span class="keyword">literal</span>, <span class="constant">3</span>, less_than?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">'@'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2, string_head__char
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">':'</span>, equal?, false?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2, false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> string_head__char
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="default">':'</span>, equal?, false?
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** </span><span class="org-todo">&gt;&lt;</span><span class="org-level-2"> M__local_variable_save_address_string</span>
   * @:address &lt;literal-number&gt;
     &lt;literal-number&gt; must be literal
     for the amount of memory be allocated
     must be decided as compile-time
<span class="org-block-begin-line">   #+begin_src fasm
</span>   define_macro <span class="string">""</span>, M__local_variable_save_address_string
      <span class="comment">;; &lt;&lt; string[address, length], word[address, length] --
</span>      <span class="comment">;;    string[address, length] &gt;&gt;
</span>      <span class="type">xx</span> string_tail__char
      <span class="type">xx</span> dup2

      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-level-2"><span class="bold">*local-variable-table*</span></span>
<span class="org-level-2">** memory allocation</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   size$local_variable_table = <span class="constant">100</span> * <span class="constant">1024</span>

   address$local_variable_table <span class="keyword">labeling</span>
      <span class="type">preserve</span> size$local_variable_table
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** clear</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">border$local_variable_table</span>:
      <span class="type">xx</span> address$local_variable_table

   <span class="function-name">offset$local_variable_table</span>:
      <span class="type">xx</span> <span class="constant">0</span>

   define_function <span class="string">"local-variable-table,clear"</span>, local_variable_table__clear
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, address$local_variable_table
      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, save
      <span class="type">xx</span> <span class="keyword">literal</span>, <span class="constant">0</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, offset$local_variable_table, save
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** insert</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"local-variable-table,insert"</span>, local_variable_table__insert
      <span class="comment">;; &lt;&lt; string[address, length] -- offset &gt;&gt;
</span>
      <span class="comment">;; leave offset
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, offset$local_variable_table, fetch
      <span class="type">xx</span>   xxtuckx <span class="comment">;; return value
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch, save
      <span class="type">xx</span> V__jo_size
      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, add_save

      <span class="comment">;; update offset$local_variable_table
</span>      <span class="type">xx</span> dup2
      <span class="type">xx</span>   count_front_colon
      <span class="type">xx</span>   V__jo_size, multiple
      <span class="type">xx</span>   <span class="keyword">literal</span>, offset$local_variable_table, add_save

      <span class="comment">;; leave length
</span>      <span class="type">xx</span> <span class="keyword">dup</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch, save
      <span class="type">xx</span> V__jo_size
      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, add_save

      <span class="type">xx</span> tuck <span class="comment">;; for to update border$local_variable_table
</span>
      <span class="comment">;; leave string
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch
      <span class="type">xx</span> string_to_buffer!

      <span class="comment">;; update border$local_variable_table
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, add_save

      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** find</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="function-name">cursor$local_variable_table</span>:
      <span class="type">xx</span> address$local_variable_table

   define_function <span class="string">"local-variable-table,find"</span>, local_variable_table__find
      <span class="comment">;; &lt;&lt; string[address, length]
</span>      <span class="comment">;;    -- offset, true
</span>      <span class="comment">;;    -- false &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, address$local_variable_table
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, save
      <span class="type">xx</span> local_variable_table__find__loop
      <span class="type">xx</span> <span class="keyword">end</span>

   define_function <span class="string">"local-variable-table,find,loop"</span>, local_variable_table__find__loop
      <span class="comment">;; &lt;&lt; string[address, length]
</span>      <span class="comment">;;    -- offset, true
</span>      <span class="comment">;;    -- false &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
      <span class="type">xx</span> <span class="keyword">literal</span>, border$local_variable_table, fetch
      <span class="type">xx</span> greater_or_equal?, <span class="keyword">false?branch</span>, <span class="constant">4</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   false
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> dup2
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
      <span class="type">xx</span>   V__jo_size, addition
      <span class="type">xx</span>   V__jo_size, addition <span class="comment">;; address of string
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
      <span class="type">xx</span>   V__jo_size, addition
      <span class="type">xx</span>   fetch <span class="comment">;; length of string
</span>      <span class="type">xx</span> string_equal?, <span class="keyword">false?branch</span>, <span class="constant">8</span>
      <span class="type">xx</span>   drop2
      <span class="type">xx</span>   <span class="keyword">literal</span>, cursor$local_variable_table, fetch
      <span class="type">xx</span>     fetch <span class="comment">;; offset
</span>      <span class="type">xx</span>   true
      <span class="type">xx</span>   <span class="keyword">end</span>
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, fetch
      <span class="type">xx</span>   V__jo_size, addition
      <span class="type">xx</span>   fetch <span class="comment">;; length of string
</span>      <span class="type">xx</span> V__jo_size, addition
      <span class="type">xx</span> V__jo_size, addition
      <span class="type">xx</span> <span class="keyword">literal</span>, cursor$local_variable_table, add_save
      <span class="type">xx</span> <span class="keyword">taca</span>, local_variable_table__find__loop
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** initialize-local-variable</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"initialize-local-variable"</span>, initialize_local_variable
      <span class="comment">;; &lt;&lt; -- &gt;&gt;
</span>      <span class="type">xx</span> <span class="keyword">literal</span>, M__local_variable_save_string,  push_dispatch_word_stack
      <span class="type">xx</span> <span class="keyword">literal</span>, local_variable_save_string?,    push_dispatch_word_stack
      <span class="type">xx</span> <span class="keyword">literal</span>, M__local_variable_fetch_string, push_dispatch_word_stack
      <span class="type">xx</span> <span class="keyword">literal</span>, local_variable_fetch_string?,   push_dispatch_word_stack
      <span class="type">xx</span> <span class="keyword">end</span>
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* some global variable</span>
<span class="org-level-2">** platform</span>
   * this word is implemented as a function
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_function <span class="string">"platform"</span>, the_platform
      <span class="type">xx</span> <span class="keyword">literal</span>, string$platform
      <span class="type">xx</span> <span class="keyword">literal</span>, length$platform
      <span class="type">xx</span> <span class="keyword">end</span>

   <span class="function-name">string$platform</span>:

   <span class="preprocessor">match</span> =linux, platform {
      <span class="type">db</span> <span class="string">"linux"</span>
   }

   <span class="function-name">.end</span>:
   length$platform = (.end - string$platform)
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-1">* -----------------------------------</span>
<span class="org-level-1">* epilog</span>
<span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-level-2"><span class="bold">*un-initialized-memory*</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*un-initialized-memory*"</span>, V__un_initialized_memory
     <span class="type">xx</span> address$un_initialized_memory

   define_variable <span class="string">"*size,un-initialized-memory*"</span>, V__size__un_initialized_memory
     <span class="type">xx</span> size$un_initialized_memory

   define_variable <span class="string">"*current-free-address,un-initialized-memory*"</span>, V__current_free_address__un_initialized_memory
     <span class="type">xx</span> current_free_address$un_initialized_memory
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** </span><span class="org-level-2"><span class="bold">*current-free-address,primitive-string-heap*</span></span>
   * the last_primitive_string_in_assembly
     is just "<span class="bold">*current-free-address,primitive-string-heap*</span>"
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   define_variable <span class="string">"*current-free-address,primitive-string-heap*"</span>, V__current_free_address__primitive_string
      <span class="type">xx</span> current_free_address$primitive_string_heap
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** last_link</span>
   * this word helps to initialize V__first_jo_in_dictionary
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   last_link = link
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** size$un_initialized_memory</span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   size$un_initialized_memory = <span class="constant">64</span> * <span class="constant">1024</span> * <span class="constant">1024</span> <span class="comment">;; (byte)
</span><span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-2">** un_initialized_memory              </span><span class="org-level-2"><span class="org-tag">:linux:</span></span>
<span class="org-block-begin-line">   #+begin_src fasm :tangle cicada-nymph.fasm
</span>   <span class="preprocessor">match</span> =linux, platform {

   <span class="keyword">segment</span> <span class="keyword">readable</span> <span class="keyword">writeable</span>
   <span class="function-name">address$un_initialized_memory</span>:
      <span class="type">rb</span> size$un_initialized_memory

   }
<span class="org-block-end-line">   #+end_src
</span><span class="org-level-2">** ----------------------------------</span>
<span class="org-level-1">* ===================================</span>
</pre>
  </body>
</html>
